<!DOCTYPE HTML>
<html lang="en" class="light" dir="ltr">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>CSCI 0320 Notes</title>
        <meta name="robots" content="noindex">


        <!-- Custom HTML head -->
        
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff">

        <link rel="icon" href="favicon.svg">
        <link rel="shortcut icon" href="favicon.png">
        <link rel="stylesheet" href="css/variables.css">
        <link rel="stylesheet" href="css/general.css">
        <link rel="stylesheet" href="css/chrome.css">
        <link rel="stylesheet" href="css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="highlight.css">
        <link rel="stylesheet" href="tomorrow-night.css">
        <link rel="stylesheet" href="ayu-highlight.css">

        <!-- Custom theme stylesheets -->
        <link rel="stylesheet" href="././mdbook-admonish.css">
        <link rel="stylesheet" href="./mdbook-admonish.css">

    </head>
    <body class="sidebar-visible no-js">
    <div id="body-container">
        <!-- Provide site root to javascript -->
        <script>
            var path_to_root = "";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('light')
            html.classList.add(theme);
            var body = document.querySelector('body');
            body.classList.remove('no-js')
            body.classList.add('js');
        </script>

        <input type="checkbox" id="sidebar-toggle-anchor" class="hidden">

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            var body = document.querySelector('body');
            var sidebar = null;
            var sidebar_toggle = document.getElementById("sidebar-toggle-anchor");
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            } else {
                sidebar = 'hidden';
            }
            sidebar_toggle.checked = sidebar === 'visible';
            body.classList.remove('sidebar-visible');
            body.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item expanded affix "><a href="home.html">How to read these notes</a></li><li class="chapter-item expanded "><a href="success-in-0320/success-in-0320.html"><strong aria-hidden="true">1.</strong> Success in 0320</a><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><a href="success-in-0320/recipe.html"><strong aria-hidden="true">1.1.</strong> Debugging Recipe</a></li></ol></li><li class="chapter-item expanded "><a href="02_lambdas_validation/02_lambdas_validation.html"><strong aria-hidden="true">2.</strong> Agile, Lambdas, and Validation</a></li><li class="chapter-item expanded "><a href="03_bias_narrowing_refinements/03_bias_narrowing_refinements.html"><strong aria-hidden="true">3.</strong> Narrowing and Refinements</a></li><li class="chapter-item expanded "><a href="04_refinements_mutability/04_refinements_mutability.html"><strong aria-hidden="true">4.</strong> Branding and Immutability</a><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><a href="04_refinements_mutability/04.5.apis-integration.html"><strong aria-hidden="true">4.1.</strong> APIs and Integration</a></li></ol></li><li class="chapter-item expanded "><a href="05_threads_promises/05_threads_promises.html"><strong aria-hidden="true">5.</strong> Threads and Promises</a></li><li class="chapter-item expanded "><a href="06_html_react/html-react-playwright.html"><strong aria-hidden="true">6.</strong> HTML and React</a></li><li class="chapter-item expanded "><a href="algorithms/algorithms.html"><strong aria-hidden="true">7.</strong> Thinking About Algorithms</a><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><a href="algorithms/supplement.html"><strong aria-hidden="true">7.1.</strong> Supplement Board: Dijkstra's Algorithm, Etc.</a></li></ol></li><li class="chapter-item expanded "><a href="security/security_and_threat_modeling.html"><strong aria-hidden="true">8.</strong> Security 1</a></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle">
                <div class="sidebar-resize-indicator"></div>
            </div>
        </nav>

        <!-- Track and set sidebar scroll position -->
        <script>
            var sidebarScrollbox = document.querySelector('#sidebar .sidebar-scrollbox');
            sidebarScrollbox.addEventListener('click', function(e) {
                if (e.target.tagName === 'A') {
                    sessionStorage.setItem('sidebar-scroll', sidebarScrollbox.scrollTop);
                }
            }, { passive: true });
            var sidebarScrollTop = sessionStorage.getItem('sidebar-scroll');
            sessionStorage.removeItem('sidebar-scroll');
            if (sidebarScrollTop) {
                // preserve sidebar scroll position when navigating via links within sidebar
                sidebarScrollbox.scrollTop = sidebarScrollTop;
            } else {
                // scroll sidebar to current active section when navigating via "next/previous chapter" buttons
                var activeSection = document.querySelector('#sidebar .active');
                if (activeSection) {
                    activeSection.scrollIntoView({ block: 'center' });
                }
            }
        </script>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky">
                    <div class="left-buttons">
                        <label id="sidebar-toggle" class="icon-button" for="sidebar-toggle-anchor" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </label>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">CSCI 0320 Notes</h1>

                    <div class="right-buttons">
                        <a href="print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.min.css" integrity="sha384-AfEj0r4/OFrOo5t7NnNe46zW/tFgW6x/bCJG8FqQCEo3+Aro6EYUG4+cU+KJWu/X" crossorigin="anonymous">
<h1 id="how-to-read-these-notes"><a class="header" href="#how-to-read-these-notes">How to read these notes</a></h1>
<p>Welcome to CSCI 0320/1340! </p>
<p>This page contains the <em>lecture notes</em> for the course. With JavaScript enabled, the table of contents will allow you to select a specific chapter. Likewise, the search icon should allow you to search for arbitrary words throughout all the notes. The lecture indexing is for <strong>Fall 2025</strong>. Some lectures are mainly done via slides, in which case we will attempt to link the slides here as well. </p>
<p>These notes are meant to be accompanied by the <a href="https://github.com/cs0320/class-livecode">course live code repository</a>, which contains a collection of code examples done in and out of class. The course assumes that students will review the live code.</p>
<div id="admonition-these-notes-are-not-final" class="admonition admonish-warning">
<div class="admonition-title">
<p>These notes are not final!</p>
<p><a class="admonition-anchor-link" href="home.html#admonition-these-notes-are-not-final"></a></p>
</div>
<div>
<p>This outline is subject to change, and notes are often modified in response to TA feedback or student Q&amp;A before class. Some notes will be greyed out and inaccessible in the table of contents.</p>
</div>
</div>
<h2 id="exercises"><a class="header" href="#exercises">Exercises</a></h2>
<p>Exercises are enclosed in expandable spoiler tags:</p>
<div id="admonition-exercise-answers" class="admonition admonish-note">
<div class="admonition-title">
<p>Exercise Answers</p>
<p><a class="admonition-anchor-link" href="home.html#admonition-exercise-answers"></a></p>
</div>
<div>
<p>If you see an expandable piece of text, like this:</p>
<details>
<summary>Think, then click.</summary>
<p>Text for you to read <em>after</em> thinking or doing an exercise...</p>
</details>
</br>
stop and think, or do the related exercise, before expanding.
</div>
</div>
<div style="break-before: page; page-break-before: always;"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.min.css" integrity="sha384-AfEj0r4/OFrOo5t7NnNe46zW/tFgW6x/bCJG8FqQCEo3+Aro6EYUG4+cU+KJWu/X" crossorigin="anonymous">
<h1 id="success-in-0320"><a class="header" href="#success-in-0320">Success In 0320</a></h1>
<h2 id="logistics"><a class="header" href="#logistics">Logistics</a></h2>
<p><strong>We have been moved to B&amp;H.</strong></p>
<ul>
<li>I check override requests every day after the course starts. </li>
<li>If you need and <strong>get an override</strong>, please accept ASAP so that Brown and the department get accurate enrollment estimates. CAB does not report active overrides in the enrollment total, so delaying prevents others from getting in.</li>
<li>If you <strong>are still shopping</strong>, keep 0320 in your cart so that you see announcements, etc. that we send to the list or post on EdStem. <strong>If you do not have 0320/1340 in your cart, I will not grant you an override.</strong></li>
<li><strong>You need the prerequisites</strong> to take 0320 or 1340. If you haven't completed 0200, 0190, or a comparable course, you cannot take 0320 yet. (If you're a transfer student and concerned, let's talk; I was also a transfer student as an undergrad so I have some understanding of potential worries.)</li>
</ul>
<p>When I say &quot;0320&quot; in the course notes, I mean both 0320 and 1340. </p>
<h2 id="welcome"><a class="header" href="#welcome">Welcome!</a></h2>
<p>Before we get started, turn to the people sitting next you to now and introduce yourself. </p>
<p>The most important part of 0320 is <em>collaboration</em>. With the exception of the very first assignment, everything in 0320 is group work. </p>
<ul>
<li>You'll be submitting your work to repositories that everyone in the class can (eventually) read.</li>
<li>You'll be helping one another solve bugs and design problems (even if you're in different project groups; this is a requirement). 
To make this work, we need a professional and friendly environment. </li>
</ul>
<p>We'll be passing out index cards. I like to anonymously learn some important things about students in this class, so please fill one out, answering: </p>
<ul>
<li>What is a <strong>goal</strong> you have for 0320?</li>
<li>What is something you <strong>need</strong> to succeed in 0320?</li>
<li>What is something you're <strong>afraid</strong> of in 0320?
At the end of class, leave your card either here in front or on (one single) chair in the back so I can collect. </li>
</ul>
<h3 id="0320-is-different"><a class="header" href="#0320-is-different">0320 is Different</a></h3>
<p>You'll want to read the missive. You may not need to read <em>all</em> of it super deeply yet, but you should note the ways that 0320 is different from what you're used to. E.g., you'll be getting formative feedback every week from a mentor. Like in industry, you will not be graded by an autograder.</p>
<h3 id="ta-introductions"><a class="header" href="#ta-introductions">TA Introductions</a></h3>
<p><strong>Speaking of mentors, let's introduce the TAs!</strong></p>
<h2 id="disclaimer"><a class="header" href="#disclaimer">Disclaimer</a></h2>
<p>This offering of 0320 is experimental. Much of the assignment content is new, as are the structured AI content. We've tried to minimize issues, but issues will happen. We'll act to mitigate them. Likewise, the perspective on AI we use is based on common practice as of summer 2025. I've reserved sprint 9 to address anything new that comes up (and have an assignment in reserve in case nothing does). </p>
<h2 id="immediate-advice"><a class="header" href="#immediate-advice">Immediate Advice</a></h2>
<p>The first sprint goes out Monday, and there's a setup deliverable due before then. Please do it soon; you don't want to spend a lot of time early next week on setting up VSCode and so on.</p>
<p>Go to gear up sections. This semester, they're on <strong>Mondays and Tuesdays</strong> (with one exception around IPD). Switching doesn't require a &quot;conference&quot; switch in CAB. </p>
<p>Read <a href="https://cs0320.github.io/notes/">lecture notes</a> and <a href="https://github.com/cs0320/class-livecode">livecode</a>. More than reading the code examples, pull the code and experiment with them! I try to strike a balance between depth and drill in class, which means that when we have in-class work, these resources will be vital references. (Today, for example, I won't talk through every bullet point in these notes.)</p>
<p>Prototype early. (Paraphrasing Andy: <em>Start soon! Start yesterday!</em>)</p>
<p>Be aware that while this is an S/NC course, it is a lot of work. To quote a very wise remark from prior feedback: <em>&quot;You will work very hard, but not get an A&quot;.</em> </p>
<h3 id="reading-for-next-time"><a class="header" href="#reading-for-next-time">Reading for Next Time</a></h3>
<p>Read the missive. </p>
<p>Also, a short non-technical reading: <a href="https://www.gutenberg.org/files/33002/33002-h/33002-h.htm#Page_165">Clever Manka</a>. Read it. <strong>What does it have to do with software engineering?</strong></p>
<p>There will be readings, but you won't need to pay for them.</p>
<h2 id="programming-vs-engineering"><a class="header" href="#programming-vs-engineering">Programming vs. Engineering</a></h2>
<p>Let's say I asked you to open up your laptop and write me a sorting algorithm in the language of your choice. How would you react?</p>
<details>
<summary>Think, then click.</summary>
Hopefully you didn't immediately start programming. I didn't really give you enough information, did I? I didn't say (among other things):
<ul>
<li>what kind of values you would have to sort; </li>
<li>whether the sort needed to be stable, or in-place, or if there were any runtime requirements; or</li>
<li>what the input interface should be (do you need to do file I/O or parse a CSV file?)</li>
</ul>
<p>If you'd written insertion sort over lists of integers, but I needed to sort lists of records with a low worst-case runtime, you'd have had to start all over.</p>
</details>
</br>
<p>Get in the habit of <strong>asking questions</strong>.  It will save you time and pain in the future. </p>
<p><strong>Communicate</strong> clearly and often. It will save you time and pain in the future. </p>
<p><strong>Document your assumptions and needs</strong>. It will save you time and pain in the future.</p>
<p>Don't misunderstand me: you'll work with a lot of code in this class. But just writing code is, frankly, <em>not good enough</em>.</p>
<h2 id="what-makes-good-software"><a class="header" href="#what-makes-good-software">What makes &quot;good software&quot;?</a></h2>
<p>There are many valid viewpoints on this. In the context of 0320, we're going to think about a few dimensions. </p>
<ul>
<li>Is the software <em>ready for change</em>? (Can it be extended easily, and without modifying the original code?)</li>
<li>Is the software <em>safe from bugs</em>? (Not just &quot;bug free&quot;, but resilient to the bugs of other software that might call it, or that it might call.)</li>
<li>Is the software <em>easy to understand</em>? (Is it well documented? Is it designed in a way that other engineers will be able to follow without a lot of work? Is it clear how to use it?)</li>
<li>Is the software <em>fit to purpose</em>? (Does it do what it is supposed to do? Figuring that out involves <em>a lot of work</em>, because other people are involved.)</li>
</ul>
<p>That last category is incredibly broad. For me, it incorporates issues beyond functional correctness like:</p>
<ul>
<li>performance, </li>
<li>security, </li>
<li>harm minimization, etc.</li>
</ul>
<h2 id="the-0320-collaboration-standard"><a class="header" href="#the-0320-collaboration-standard">The 0320 Collaboration Standard</a></h2>
<p><strong>This may be the weirdest course you'll take during your time at Brown CS. It will also challenge you in new ways. That is deliberate.</strong></p>
<p>Our goal is not to teach you to do better at programming courses, or even computer science courses in general. Our goal is to teach you to be a better engineer, period. That goal has some natural consequences.</p>
<p>The collaboration policy is part of that. We'll use Git, an industry standard version control system. If you haven't had Git experience yet, that's OK! Here's an example of how it works on a project I just happen to have here on my laptop. By the way, I'm using IntelliJ to work on this code. This course strongly encourages you to use (and supports) IntelliJ; the gear up sections today and tomorrow can help you set it up.</p>
<p>One advantage of using Git is that all the code from lecture will be available on a <a href="https://github.com/cs0320/class-livecode">public repository</a> in the <code>F25</code> folder (for Fall 2025) and also in the <code>vignettes</code> subfolder, which I use for small examples that may or may not appear in class. You can clone the repository to experiment with the code on your own machine. <strong>You should clone this repository as soon as you're able</strong>; we'll use it for in-class exercises, and it gives you the ability to experiment with changing the code on your own machine. <strong>Starting next week, I will assume that you have the repository cloned on your laptop, if you bring one.</strong></p>
<h2 id="what-about-ai"><a class="header" href="#what-about-ai">What About AI?</a></h2>
<p>We'll use it. Please see the missive. There's lots of new stuff, and I've written enough text about it already. :-)</p>
<h2 id="how-does-grading-work"><a class="header" href="#how-does-grading-work">How Does Grading Work?</a></h2>
<p>You may look at the first assignment and think &quot;OMG I am not prepared!&quot; But you are. This course is designed to prompt this feeling—in a safe environment, so you can build the skills necessary to navigate unpreparedness. The course works for those who embrace our (admittedly unusual) system. </p>
<p>If you're a <em>highly prepared</em> student and you find that even most supplemental problems aren't challenging you: this is your chance to cut loose. Impress me. Final demos are public for everyone, but for Master's students and undergraduates who opt in, they will be <em>publicized</em>. </p>
<p>0320 is mandatory S/NC. We award &quot;S with distinction&quot; based on completing supplemental sprint challenges, exceptional professionalism, and strong performance on the term project. </p>
<ul>
<li>The sprints let you demonstrate command of new technical skills, which we give formative feedback on. </li>
<li>The term project lets you show you can apply those skills in a new context of your own. Expectations are stronger here: I want everyone to finish 0320 with a good item for their portfolio (whether you're going into traditional SWE or not). </li>
</ul>
<p>The missive talks at length about grading; I won't try to duplicate all that information here. However, here are some key features of 0320's grading.</p>
<p><strong>1-week sprints:</strong> You'll have a deliverable every week. This gives us a better cadence for feedback. You'll alternate between asynchronous video demos and synchronous demos each week, and the demos (<em>and your answers to questions they ask</em>) are the primary way your mentors will generate feedback.</p>
<p><strong>Feedback Spreadsheet:</strong> You'll receive access to a spreadsheet where your mentors will leave formative feedback <em>every week</em>, along with whether you've met expectations for the week. We'll expect you to work on addressing this feedback between sprints. </p>
<p><strong>No Hidden Rubrics:</strong> There are no secret rubrics or hidden test suites in 0320; we want you to know what our expectations are. You can see our grading instructions, and a recipe for giving demos, linked in the first sprint. (We do provide mentors with some additional private material to help them give feedback efficiently, but everything in that material is also in the sprint handouts.)</p>
<p><strong>Collaboration Matters</strong> We would like to more strongly encourage collaboration between students. You'll need to earn a certain number of crests throughout the semester and per sprint. <strong>You will handle reporting this to us on your feedback sheet.</strong></p>
<p><strong>Testing Matters:</strong> We'll talk more about testing on Tuesday, but it should go without saying that in 0320, we take testing seriously. The handouts contain <em>pretty good advice</em> on meeting our requirements. Read them. </p>
<h2 id="typescript"><a class="header" href="#typescript">TypeScript</a></h2>
<p>We're going to be using TypeScript for nearly all of this course. Last year, we used Java for the &quot;back end&quot; and TypeScript on the &quot;front end&quot;, and it was tough to devote enough time to general TypeScript practice. So we're doing everything in one language. The first two weeks give you an introduction.</p>
<p>TypeScript is essentially &quot;JavaScript with types&quot;. It transpiles to JavaScript, meaning that Node and your browser only need to &quot;understand&quot; JavaScript. Why do we need types here, though?</p>
<h3 id="equality"><a class="header" href="#equality">Equality</a></h3>
<p>When I'm learning a new language, I like to identify language features that I rely on, and experiment with them. Coming up with these facets isn't always easy, which is why we're doing it together. For instance, let's check out <em>equality</em>, a deceptively simple yet subtle idea that many languages differ on. We've got a couple options for our experiments:</p>
<ul>
<li>If we were interested in <em>web</em> behavior, I'd use the console of whatever browser I wanted. (Safari's JS console is Command-Option-C, if you've enabled developer tools.</li>
<li>If we were interested in general <em>program</em> behavior, I'd just run Node. Node is a runtime library for JavaScript that's often used for backend servers—the same sort of setting you might see a Java program used for. </li>
</ul>
<p>Behavior isn't always the same between these. We'll get to that later. For now, let's use Node.</p>
<pre><code class="language-javascript">&gt; 15 == &quot;15&quot;
true
&gt; 15 == true
false
&gt; 1 == true
true
0 == false
true
</code></pre>
<p>Already we've learned a great deal. JavaScript's <code>==</code> operator performs type conversion before comparing values. It allows us to pretend that the number <code>1</code> is &quot;true&quot; and that the number <code>0</code> is &quot;false&quot;, but other numbers aren't equivalent to either. </p>
<p>Those of you who have programmed in Racket before: notice this is different from Racket! In Racket, every non-false value (Racket calls false <code>#f</code>) is considered true. The same is true in many other languages.</p>
<p>JavaScript has a second equality operator, <code>===</code>, that checks for equality <em>without</em> type conversion. So:</p>
<pre><code class="language-javascript">&gt; 15 === &quot;15&quot;
false
</code></pre>
<p>Java also has two different types of equality (<code>==</code> and the <code>.equals</code> method), but there the difference has nothing to do with implicit type conversion, but with references vs. structural equality. JavaScript's implicit conversion adds an extra layer of complexity.</p>
<h3 id="arithmetic"><a class="header" href="#arithmetic">Arithmetic</a></h3>
<p>Let's try a few arithmetic operators that are often overloaded across different languages.</p>
<pre><code class="language-javascript">&gt; '1' + 1
'11'

&gt; 1 + '1'
'11'

&gt; 1 - '1'
0

&gt; '1' - 1
0
</code></pre>
<p>JavaScript tries to &quot;do the reasonable thing&quot; whenever possible. This can lead to surprising bugs; When in doubt, use explicit conversion functions (e.g., <code>parseInt</code>). In fact, let's try a couple more (Credit for these to <a href="https://www.destroyallsoftware.com/talks/wat">Gary Bernhardt</a> from 2012---it's 4 minutes long; watch it.) For context, <code>[]</code> denotes an array or list in JavaScript and <code>{}</code> denotes an object.</p>
<pre><code class="language-javascript">&gt; [] + []
&quot;&quot;

&gt; {} + {}
'[object Object][object Object]'

&gt; [] + {}
[object Object]
</code></pre>
<p>Do you see why TypeScript is helpful, now? JavaScript lets you throw off the constraints of the type system, but those constraints are like a safety belt on a roller coaster.</p>
<h4 id="supplemental-whats-really-happening"><a class="header" href="#supplemental-whats-really-happening">Supplemental: What's Really Happening?</a></h4>
<p>The details involve how JavaScript is implicitly converting between different types. Before applying <code>+</code>, it converts to a &quot;primitive&quot; type, which for an object is a string. An empty array is converted to the empty string. And so on. The details would consume a full class, or more! Just beware, and embrace types.</p>
<h3 id="objects"><a class="header" href="#objects">Objects</a></h3>
<p>While we won't be using TypeScript <em>classes</em> much in 0320, we can't avoid using <em>objects</em>. Objects are collections of fields; there's no sharp distinction between fields that are methods and fields that are data. If you've used Python before, these may remind you of dictionaries. For example:</p>
<pre><code class="language-javascript">&gt; const cat = {talk: function() { console.log('meow'); }}
undefined
</code></pre>
<p>This defines a value for the variable <code>cat</code>. The console (in both a browser and in Node) displays <code>undefined</code> because that's the return value of the definition statement.</p>
<pre><code class="language-javascript">&gt; cat.talk
function talk()
</code></pre>
<p>The value of <code>cat.talk</code> is a <em>function</em>. We can pass it around the same way we would a string or a number. But we can also call it:</p>
<pre><code class="language-javascript">&gt; cat.talk()
meow
undefined
</code></pre>
<p>Again, the <em>console</em> is printing the &quot;meow&quot; and then saying what the return value was. You won't need to worry about this apparent double result when you're working with TypeScript in general.</p>
<p>Don't get too attached to the method-style syntax, however. Objects in TypeScript are more flexible. A field is a field, no matter what it contains:</p>
<pre><code class="language-javascript">&gt; cat[&quot;talk&quot;]
function talk()
&gt; cat[&quot;talk&quot;]()
meow
undefined
</code></pre>
<p>You'll get a lot more practice with TypeScript over the next 2 weeks.</p>
<h2 id="typescript-types"><a class="header" href="#typescript-types">TypeScript Types</a></h2>
<p>TypeScript works a little bit differently from Java. <a href="https://docs.google.com/document/d/115A3utnCRM71jOGlXV6hqGzvHgA7psPo218JpXtnSPI/edit?usp=sharing">See the Thinking Like an Engineer: Types</a> document for more. I'll cover some of them live today and Tuesday. </p>
<p>We'll be using a library called Zod for validation, and to enrich what types can give us. Zod appears in the very first sprint! I'll be talking about it on Tuesday, but <strong>do not wait until then</strong> to start the sprint. There are other, Zod-free deliverables.</p>
<!-- ### A Little Bit of Generics

In today's project I've got a very basic `Student` class. Every `Student` has a todo list, and the contents of their todo list are passed in the constructor. 

```java
public class Student {    
    List<String> todos;
    public Student(List<String> todos) {
        this.todos = todos;
    }

    ...
    
}
```

We don't have any code yet to remove things, or add things to the list. What we do have is a method to find the _most common thing_ on the todo list. 

```java
    public String mostCommonTodoItem() {
        Map<String, Integer> counts = new HashMap<>();
        for(String s : this.todos) {
            if(!counts.containsKey(s)) counts.put(s, 1);
            else counts.put(s, counts.get(s) + 1);
        }
        String mostCommonItem = null;
        int howCommon = 0;
        for(String s : counts.keySet()) {
            if(counts.get(s) > howCommon) {
                mostCommonItem = s;
                howCommon = counts.get(s);
            }
        }
        return mostCommonItem;
    }
```

There might be more concise ways to write this, but this way is useful for what I want to demo. It breaks the problem in half:
* first, compute the number of times every item appears on the list; and 
* second, find which item had the highest count. 

Looking at this code, you might have some questions. One is whether I can really say there is _one unique_ most common item on the list. I'm making some unstated assumptions, aren't I? More on that later in the semester. 

For now, let's observe that the todo list for every student needs to contain `String` items. But there's no real reason for that. Our `mostCommonTodoItem()` method would work perfectly if we changed `String` to `Integer`. Or we changed `String` to `Object`, or even to some other more complicated type like `List<String>` (then each todo item would be its own list). But to make such a change, we need to modify _many_ places in the method, and copy it. We'd have `mostCommonTodoItem_String` and `mostCommonTodoItem_Int` and so on. That sounds like a lot of work. The code isn't _easily extensible_. 

We can fix that using Java generics. Rather than saying `List<String>`, what we want to do is speak of a list of some arbitrary type---that the method *doesn't need to care* about the details of. Let's call that arbitrary type `T` for short. Then we might say that the `Student` class has a field `List<T> todos`, and write the method this way:

```java
public T mostCommonTodoItem() {
        Map<T, Integer> counts = new HashMap<>();
        for(T s : this.todos) {
            if(!counts.containsKey(s)) counts.put(s, 1);
            else counts.put(s, counts.get(s) + 1);
        }
        T mostCommonItem = null;
        int howCommon = 0;
        for(T s : counts.keySet()) {
            if(counts.get(s) > howCommon) {
                mostCommonItem = s;
                howCommon = counts.get(s);
            }
        }
        return mostCommonItem;
    }
```

It's the same code we would have written if we'd changed `String` to some other type, except we're just plugging in this new name `T` instead. Here, `T` is called a _type variable_. **Crucially, a type variable is not a variable at runtime**. It doesn't hold a value or a reference. Instead, it's a variable that the *compiler* uses when it's reasoning about the program. We can make this code valid Java by declaring `T` in the `class` definition:

```java
public class Student<T> {
    ...
}
```

Every time we create a `Student`, that instance will have a todo list containing items of some type. That type will always have to be the same type for any specific student; that single type is the value of `T` (which only exists for the compiler). We can create students just like we would without the type variable, but we need to provide a little information, like this:

```java
Student<String> tim = new Student<>(List.of("lecture notes", "email", "email", "family", "email"));
Student<Integer> nim = new Student<>(List.of(1, 17, 3, 43, 1, 2, 5));
```
This is exactly the same thing you do when you create a new `List` or `Set` or `HashMap`! All of these data structures are implemented using type variables. They are a _great_ way to make your code easy to use and extend. (We'll revisit generics and type variables a little later in the semester, but this is as much as you need for now.)

~~~admonish note title="This isn't really about Java"
Most programming languages, at least those with a static type system, support this sort of thing. Technically, it's an example of something called [*parametric polymorphism*](https://en.wikipedia.org/wiki/Parametric_polymorphism). Even Python's type-hint system allows it. So does TypeScript.
~~~

While we're here editing this class, there's something I don't like. What happens if the list is empty? Then the method returns `null`. This feels unsafe, or at least not very communicative. We could be throwing an exception that has more meaning---like `IllegalArgumentException` (or maybe even our own exception type). I'll add this to the start of the method:

```java
        if(this.todos.isEmpty()) {
            throw new IllegalArgumentException();
        }
``` -->
<!-- Great! So we've made 2 improvements to the code: one which makes it more generic, and one that makes it a little more useful to the program that's calling it. 

Now that we've made this change, I'll just *commit* the change to my local repository. First, I'll tell Git that I want it to include the change I just made:

```
git add Student.java
```

At any point, I can ask Git for the `status` of the repository:

```
git status
```

which can help keep track of which files are changed, added (i.e., ready to be comitted) etc.

I see the file I want to change is ready, so I'll commit the change, with a human-readable message:

```
git commit -m "feat: generic student TODO list, better error behavior"
```

So far, the change is only on my _local_ machine: in the file, but also in the repository. If I want others on staff (and all of you!) to get the change, I need to `push` to the repo:

```
git push 
```

We can see a log of commits on the Github page for the project. Each of these entries shows a commit I've made in the past. If someone else wants to review the changes I've made, they can just look at the difference between commits. This is tremendously useful for group work, and most real engineering is group work. 

Now if any of you view the repo, you'll see my change. It's that easy! Here's a sketch image of what's going on. Always keep in mind that these three things are different:
* the files on your filesystem;
* the history and current version of those files in your _local_ repository; and
* the history and current version of those files in your _remote_ repository.

![](https://i.imgur.com/rRZsWx9.png)

As the semester progresses, we'll have expectations about your use of Git. For now, focus on your commits and pushes:
* Name your commits something informative, and give credit to anyone who pair-programmed or worked with you. (More on this in the gearup.)
* Commit and push regularly. Don't just push everything all at once on the day the sprint is due. If your laptop breaks, and you haven't pushed to Github, you will be a very unhappy person and we may not be particularly sympathetic.

In future, we'll ask you to use branches---which are a great way to develop in parallel with others. For the first sprint, working in the `main` branch is fine.

## Testing with JUnit

Unfortunately, I forgot to do something really important. 

Since this was an existing project, we had test cases written for it. I guess I should have run those tests _before_ pushing my update, huh? Let's have a look. Our tests use _JUnit_, a popular testing library for Java. How do we install JUnit? Just by adding it as a dependency in Maven, our Java package manager. Your Maven configuration usually lives in a single file: `pom.xml`. In my project, I have:

```xml
    <dependencies>
        <dependency>
            <groupId>org.junit.jupiter</groupId>
            <artifactId>junit-jupiter</artifactId>
            <version>RELEASE</version>
            <scope>test</scope>
        </dependency>
    </dependencies>
    <build>
        <plugins>
            <plugin>
                <groupId>org.apache.maven.plugins</groupId>
                <artifactId>maven-surefire-plugin</artifactId>
                <version>2.22.2</version>
            </plugin>
        </plugins>
    </build>
```

This loads JUnit for testing in my application. (The plugin is to help JUnit interoperate well with the build system we'll be using, Maven, which you may recall is the tool that uses this `pom.xml` file.)

I previously had this test in my suite: 

```java
    @Test
    public void emptyList() {
        Student student = new Student(List.of());        
        assertNull(student.mostCommonTodoItem());
    }
```

There are now some warnings in the test, because `Student` is now generic, and there are no angle-bracketed type parameters in my test. But we can fix those pretty easily, just by adding `<>` or `<String>` in some places. 

But the test still fails. I guess I put in a bug by mistake. But I don't really understand how, or what the problem is. How do I work through the problem?

~~~admonish warning title="Watch out!"
This is a simple issue that you may immediately see and know how to fix. That's not the point. If it were something bigger, it would be difficult to fit it into class. So let's treat this as a real bug, and learn better how to diagnose such problems.
~~~
 
## The 0320 Debugging Recipe

I think I'm supposed to follow this [debugging recipe](./recipe.md). And why don't _you all_ help me follow it? It starts in a strange way:

#### Rule One

"Never debug when tired or angry."

I don't feel particularly angry, and I just had a sandwich. So I think I'm good to go. (This rule is not a joke, however. When you're tired and/or angry, your effectiveness per unit time goes down, and you may end up convincing yourself to make changes that are not good ideas in hindsight and make the problem even harder to fix. This is a reason to **start work ASAP**.)

#### What's Wrong?

Assemble your knowledge. Write no more than two sentences for each question:
* What is the purpose of the code you're working on?
* What steps can you perform to reproduce the bug?
* What is the expected behavior/result, and what is the unexpected actual behavior/result?
* Why do you expect the result that you expect?

Let's give it a try.
> I'm working on a method that finds the most common item in a list.
> I can reproduce the bug by running the test suite for the `Student` class. The failing test creates a `Student` instance with an empty list, and then invokes the most-common method.
> I expected this test to pass. I made the code objectively better, so tests shouldn't be failing.

#### Tell the Story

Now describe how you think the system operates as it approaches the unexpected actual result. Write your description as a series of steps. Use no more than one or two sentences for each step, but each step should be testable as a hypothesis about how the system works.

> The student is created, and its `todos` field contains a reference to that empty list. Then the method is called, the empty-list check is hit, my exception gets thrown, and the test should pass.

#### Localization

Confirm each step in your description is accurate. Use any reasonable means (e.g., print statements or a debugger). The **first step** where the program behaves unexpectedly is a *possible* location for the original bug. More commonly, it contains the call site for the actual buggy code.

> I see the student is created, and I know the method is called because I added a `println` to check.
> I see my exception is being returned, because I added a `println` to check.*
> But an exception is not the same as `null`. 

Notice how this process is leading us to the problem: that an exception being thrown is not the same as returning `null`. This is a pretty simple bug, but the process of _narrowing your attention_ through experiments is a professional technique that works even in enormous enterprise systems.

**We expect you to follow the recipe, especially during collab section. If you were my debugging partner, my answers to those questions may have pointed you directly to the problem!**

I guess I need to rewrite my test. But wait. Isn't what we just did _cheating_? I let you see my code, and that might influence your solution to this project. 

No. In 0320, we have an open collaboration policy---even about code. But in exchange, we need you to follow some basic professional standards. Things like: giving credit to sources, not short-circuiting anybody's learning, and never adapting code you don't understand or can't test well. See the missive for the full statement. 

A failure to meet these basic professional standards would be a violation of Brown's academic code. It would also get you in trouble at work. To run a course with such an open policy is _risky_---if abused, it harms your learning and our ability to keep the course collaborative. So, to protect the format of the course, if these standards were violated I would have to file an academic code case and then relentlessly pursue it.

But I won't have to do that, right?
 -->
<!-- ## Aside: Test Coverage 

There are a few metrics for how good a test suite is. One is "test coverage", which measures how much of the code the suite exercises. Although we encourage you to run from the terminal using `mvn`, IntelliJ is probably the best way to get test-coverage information easily, without more configuration work. To do this, run a test file in IntelliJ, then select "Run with Coverage" from the "Run" menu:

![The run menu's run-with-coverage option](./run-with-coverage.png)

This will open a new pane in IntelliJ:

![A new pane labeled "Coverage", showing class, method, and line coverage](./coverage-window.png)

My 3 tests for today's lecture are only exercising 29 percent of the code! That's a bit worrying. (We'll expect at least 50 percent line coverage on CSV, which should be very easy to reach.) If you click on the package name, it will show you lower-level information:

![Details for the `Student` class, the `Main` class, and the `prep` sub-package](./more-coverage.png)

Actually, my coverage isn't bad after all. I simply don't have tests in this file for my course-prep code, or for the `Main` class. That's OK; all lines in the `Student` class are being exercised. 

~~~admonish warning title="Coverage isn't everything!"
Don't view a high level of coverage as a guarantee! Coverage is imperfect; there are a lot of things it doesn't measure. But it's one means by which you can discover problems with your testing. 

On a similar note, there's diminishing returns on time to improve coverage. In a real, large code base, it's _far_ more difficult to move from 90% to 95% than it is to move from 50% to 65%. Don't spend all your time trying to improve coverage at the exclusion of all else, but don't neglect it either. Our sprints are small, compared to most real-world projects!
~~~
 -->
<div style="break-before: page; page-break-before: always;"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.min.css" integrity="sha384-AfEj0r4/OFrOo5t7NnNe46zW/tFgW6x/bCJG8FqQCEo3+Aro6EYUG4+cU+KJWu/X" crossorigin="anonymous">
<h1 id="the-debugging-recipe"><a class="header" href="#the-debugging-recipe">The Debugging Recipe</a></h1>
<h2 id="rule-one"><a class="header" href="#rule-one">Rule One</a></h2>
<p>Never debug when tired or angry. If you must debug when tired, commit to a stopping time. Set a timer or ask a friend to help you keep that commitment.</p>
<h2 id="identify-whats-wrong"><a class="header" href="#identify-whats-wrong">Identify What's Wrong</a></h2>
<p>Assemble your knowledge. Write no more than two sentences for each question:</p>
<ul>
<li>What is the purpose of the code you're working on?</li>
<li>What steps can you perform to reproduce the bug?</li>
<li>What is the expected behavior/result, and what is the unexpected actual behavior/result?</li>
<li>Why do you expect the result that you expect?</li>
</ul>
<h2 id="tell-the-story"><a class="header" href="#tell-the-story">Tell the Story</a></h2>
<p>Now describe how you think the system operates as it approaches the unexpected actual result. Write your description as a series of steps. Use no more than one or two sentences for each step, but each step should be testable as a hypothesis about how the system works.</p>
<h2 id="localization"><a class="header" href="#localization">Localization</a></h2>
<p>Confirm each step in your description is accurate. Use any reasonable means (e.g., print statements or a debugger). The <strong>first step</strong> where the program behaves unexpectedly is a <em>possible</em> location for the original bug. More commonly, it contains the call site for the actual buggy code.</p>
<p>Record this location, along with the expected and actual behavior.</p>
<h2 id="explanation"><a class="header" href="#explanation">Explanation</a></h2>
<p>If you have a hypothesis about the cause of the bug, make an experiment to see if you are correct.</p>
<ul>
<li>If yes, proceed to fix the problem. Whenever possible, add a regression test so that this bug will be quickly identified if it happens again. Re-run all tests to confirm that your &quot;fix&quot; hasn't broken something else. </li>
<li>If you have no hypothesis, or your hypothesis was incorrect, increase your level of detail about <strong>that single step</strong>. Look for unstated assumptions and dependencies; often, you'll find you left something important out of the original story. Then repeat the localization step.</li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.min.css" integrity="sha384-AfEj0r4/OFrOo5t7NnNe46zW/tFgW6x/bCJG8FqQCEo3+Aro6EYUG4+cU+KJWu/X" crossorigin="anonymous">
<h1 id="agile-lambdas-and-validation"><a class="header" href="#agile-lambdas-and-validation">Agile, Lambdas, and Validation</a></h1>
<h2 id="logistics-1"><a class="header" href="#logistics-1">Logistics</a></h2>
<p><strong>If you haven't yet installed Node or cloned the starter code, it would be a good idea to do that ASAP.</strong></p>
<p>We don't have a no-laptops policy in 0320. But if you're going to play chess or write an essay while in class, please sit where you won't distract anyone sitting behind you. </p>
<h2 id="agile-development"><a class="header" href="#agile-development">Agile Development</a></h2>
<p>We're going to be using a few terms of art in 0320. While we do put a bit of our own spin on these (largely because this is a class, and not a full-time job) it's important to understand what's going on. </p>
<p>We say that a development methodology is <em>agile</em> if, broadly speaking, it prioritizes the ability to change plans in response to regularly-sought feedback. Once we try to define it more precisely, you'll find multiple competing definitions, and many competing methodologies that purport to be &quot;agile&quot;. But change and feedback are good enough for us today. </p>
<p>Usually, you'll see the term used in contrast to &quot;waterfall&quot; development, where the software project proceeds along a linear path, like this:</p>
<ul>
<li>Requirements </li>
<li>Specifications</li>
<li>Design </li>
<li>Implementation</li>
<li>Testing</li>
<li>Maintenance</li>
</ul>
<p>Of course, all of these &quot;phases&quot; still exist in an agile project! The difference is that (e.g.) customer feedback on an early demo might result in changes to the requirements, or some trouble with testing an early prototype might mean changing the design to make testing easier. To make this possible, agile projects usually start development early, expecting that some, or even most, of that prototype code will be replaced later. But <strong>something must be possible to demo at every stage</strong>, or feedback is hard to obtain.</p>
<h3 id="sprints"><a class="header" href="#sprints">Sprints</a></h3>
<p>Agile development is often divided into short periods of development effort: <em>sprints</em>. The duration of a sprint varies depending on the project and company. In 0320, we've organized development into one-week sprints with relatively small requirements for each. Each sprint builds on the last. </p>
<p>Organizing sprints is an important skill for project managers. Timelines need estimates (and the ability to alter those estimates when needed), tickets need to be managed, and so on. We'll gloss over most of this in 0320, although your term project will need some attention to project-management tasks like these.</p>
<h3 id="user-stories"><a class="header" href="#user-stories">User Stories</a></h3>
<p>A <em>user story</em> is a short description of desired behavior. You'll often find these used in requirements documents for agile projects. There are a few templates, but we (mostly) follow the &quot;As a USER-ROLE I can NEEDED-BEHAVIOR so that TASK-OR-BENEFIT&quot; pattern. Look at the user stories in sprint 1.1, and you should see this pattern. </p>
<p>It's important to remember that, although they follow a template, user stories are <em>informal</em>: they may not be enough by themselves to really describe what the customer needs. To help bridge this gap, they are often accompanied by <em>acceptance criteria</em>, which give additional lower-level requirements. But these are still fairly informal, and there's often a need for more precise specification to be agreed upon between developers! </p>
<p>But what makes a good user story? A user story describes a narrow, <em>demoable</em> piece of functionality that can reasonably be accomplished in a single sprint. Often, you might start with a rough user story and realize that it's too big, and then split it into multiple stories. If users request an enhancement to an existing story, commonly these would be added as new stories (and more infrequently as additional acceptance criteria).</p>
<div id="admonition-developers-are-users-too" class="admonition admonish-warning">
<div class="admonition-title">
<p>Developers are users too!</p>
<p><a class="admonition-anchor-link" href="02_lambdas_validation/02_lambdas_validation.html#admonition-developers-are-users-too"></a></p>
</div>
<div>
<p>If you're building a software package that is intended for other developers to use, <em>they are potential users</em>! In this class we will be giving you user stories from the developer-user perspective in addition to the end-user perspective. Your API design, documentation, etc. will matter to developer users.</p>
</div>
</div>
<h2 id="reading-clever-manka"><a class="header" href="#reading-clever-manka">Reading: Clever Manka</a></h2>
<p>There's a fairy tale I like: <em>Clever Manka</em>, from a 1920's compilation called The Shoemaker's Apron, available on Project Gutenburg <a href="https://www.gutenberg.org/files/33002/33002-h/33002-h.htm#Page_165">here</a>. I'll reproduce the text in full here, within these spoiler tags. </p>
<details>
<summary>Clever Manka</summary>
<blockquote>
<p>There was once a rich farmer who was as grasping and unscrupulous as he was rich. He was always driving a hard bargain and always getting the better of his poor neighbors. One of these neighbors was a humble shepherd who in return for service was to receive from the farmer a heifer. When the time of payment came the farmer refused to give the shepherd the heifer and the shepherd was forced to lay the matter before the burgomaster.</p>
<p>The burgomaster, who was a young man and as yet not very experienced, listened to both sides and when he had deliberated he said:</p>
<p>&quot;Instead of deciding this case, I will put a riddle to you both and the man who makes the best answer shall have the heifer. Are you agreed?&quot;</p>
<p>The farmer and the shepherd accepted this proposal and the burgomaster said:</p>
<p>&quot;Well then, here is my riddle: What is the swiftest thing in the world? What is the sweetest thing? What is the richest? Think out your answers and bring them to me at this same hour tomorrow.&quot;</p>
<p>The farmer went home in a temper.</p>
<p>&quot;What kind of a burgomaster is this young fellow!&quot; he growled. &quot;If he had let me keep the heifer I'd have sent him a bushel of pears. But now I'm in a fair way of losing the heifer for I can't think of any answer to his foolish riddle.&quot;</p>
<p>&quot;What is the matter, husband?&quot; his wife asked.</p>
<p>&quot;It's that new burgomaster. The old one would have given me the heifer without any argument, but this young man thinks to decide the case by asking us riddles.&quot;</p>
<p>When he told his wife what the riddle was, she cheered him greatly by telling him that she knew the answers at once.</p>
<p>&quot;Why, husband,&quot; said she, &quot;our gray mare must be the swiftest thing in the world. You know yourself nothing ever passes us on the road. As for the sweetest, did you ever taste honey any sweeter than ours? And I'm sure there's nothing richer than our chest of golden ducats that we've been laying by these forty years.&quot;</p>
<p>The farmer was delighted.</p>
<p>&quot;You're right, wife, you're right! That heifer remains ours!&quot;</p>
<p>The shepherd when he got home was downcast and sad. He had a daughter, a clever girl named Manka, who met him at the door of his cottage and asked:</p>
<p>&quot;What is it, father? What did the burgomaster say?&quot;</p>
<p>The shepherd sighed.</p>
<p>&quot;I'm afraid I've lost the heifer. The burgomaster set us a riddle and I know I shall never guess it.&quot;</p>
<p>&quot;Perhaps I can help you,&quot; Manka said. &quot;What is it?&quot;</p>
<p>So the shepherd gave her the riddle and the next day as he was setting out for the burgomaster's, Manka told him what answers to make.</p>
<p>When he reached the burgomaster's house, the farmer was already there rubbing his hands and beaming with self-importance.</p>
<p>The burgomaster again propounded the riddle and then asked the farmer his answers.</p>
<p>The farmer cleared his throat and with a pompous air began:</p>
<p>&quot;The swiftest thing in the world? Why, my dear sir, that's my gray mare, of course, for no other horse ever passes us on the road. The sweetest? Honey from my beehives, to be sure. The richest? What can be richer than my chest of golden ducats!&quot;</p>
<p>And the farmer squared his shoulders and smiled triumphantly.</p>
<p>&quot;H'm,&quot; said the young burgomaster, dryly. Then he asked:</p>
<p>&quot;What answers does the shepherd make?&quot;</p>
<p>The shepherd bowed politely and said:</p>
<p>&quot;The swiftest thing in the world is thought for thought can run any distance in the twinkling of an eye. The sweetest thing of all is sleep for when a man is tired and sad what can be sweeter? The richest thing is the earth for out of the earth come all the riches of the world.&quot;</p>
<p>&quot;Good!&quot; the burgomaster cried. &quot;Good! The heifer goes to the shepherd!&quot;</p>
<p>Later the burgomaster said to the shepherd:</p>
<p>&quot;Tell me, now, who gave you those answers? I'm sure they never came out of your own head.&quot;</p>
<p>At first the shepherd tried not to tell, but when the burgomaster pressed him he confessed that they came from his daughter, Manka. The burgomaster, who thought he would like to make another test of Manka's cleverness, sent for ten eggs. He gave them to the shepherd and said:</p>
<p>&quot;Take these eggs to Manka and tell her to have them hatched out by tomorrow and to bring me the chicks.&quot;</p>
<p>When the shepherd reached home and gave Manka the burgomaster's message, Manka laughed and said: &quot;Take a handful of millet and go right back to the burgomaster. Say to him: 'My daughter sends you this millet. She says that if you plant it, grow it, and have it harvested by tomorrow, she'll bring you the ten chicks and you can feed them the ripe grain.'&quot;</p>
<p>When the burgomaster heard this, he laughed heartily.</p>
<p>&quot;That's a clever girl of yours,&quot; he told the shepherd. &quot;If she's as comely as she is clever, I think I'd like to marry her. Tell her to come to see me, but she must come neither by day nor by night, neither riding nor walking, neither dressed nor undressed.&quot;</p>
<p>When Manka received this message she waited until the next dawn when night was gone and day not yet arrived. Then she wrapped herself in a fishnet and, throwing one leg over a goat's back and keeping one foot on the ground, she went to the burgomaster's house.</p>
<p>Now I ask you: did she go dressed? No, she wasn't dressed. A fishnet isn't clothing. Did she go undressed? Of course not, for wasn't she covered with a fishnet? Did she walk to the burgomaster's? No, she didn't walk for she went with one leg thrown over a goat. Then did she ride? Of course she didn't ride for wasn't she walking on one foot?</p>
<p>When she reached the burgomaster's house she called out:</p>
<p>&quot;Here I am, Mr. Burgomaster, and I've come neither by day nor by night, neither riding nor walking, neither dressed nor undressed.&quot;</p>
</blockquote>
<p>The young burgomaster was so delighted with Manka's cleverness and so pleased with her comely looks that he proposed to her at once and in a short time married her.
&gt;
&gt;&quot;But understand, my dear Manka,&quot; he said, &quot;you are not to use that cleverness of yours at my expense. I won't have you interfering in any of my cases. In fact if ever you give advice to any one who comes to me for judgment, I'll turn you out of my house at once and send you home to your father.&quot;
&gt;
&gt;All went well for a time. Manka busied herself in her house-keeping and was careful not to interfere in any of the burgomaster's cases.
&gt;
&gt;Then one day two farmers came to the burgomaster to have a dispute settled. One of the farmers owned a mare which had foaled in the marketplace. The colt had run under the wagon of the other farmer and thereupon the owner of the wagon claimed the colt as his property.
&gt;
&gt;The burgomaster, who was thinking of something else while the case was being presented, said carelessly:
&gt;
&gt;&quot;The man who found the colt under his wagon is, of course, the owner of the colt.&quot;
&gt;
&gt;As the owner of the mare was leaving the burgomaster's house, he met Manka and stopped to tell her about the case. Manka was ashamed of her husband for making so foolish a decision and she said to the farmer:
&gt;
&gt;&quot;Come back this afternoon with a fishing net and stretch it across the dusty road. When the burgomaster sees you he will come out and ask you what you are doing. Say to him that you're catching fish. When he asks you how you can expect to catch fish in a dusty road, tell him it's just as easy for you to catch fish in a dusty road as it is for a wagon to foal. Then he'll see the injustice of his decision and have the colt returned to you. But remember one thing: you mustn't let him find out that it was I who told you to do this.&quot;
&gt;
&gt;That afternoon when the burgomaster chanced to look out the window he saw a man stretching a fishnet across the dusty road. He went out to him and asked:
&gt;
&gt;&quot;What are you doing?&quot;
&gt;
&gt;&quot;Fishing.&quot;
&gt;
&gt;&quot;Fishing in a dusty road? Are you daft?&quot;
&gt;
&gt;&quot;Well,&quot; the man said, &quot;it's just as easy for me to catch fish in a dusty road as it is for a wagon to foal.&quot;
&gt;
&gt;Then the burgomaster recognized the man as the owner of the mare and he had to confess that what he said was true.
&gt;
&gt;&quot;Of course the colt belongs to your mare and must be returned to you. But tell me,&quot; he said, &quot;who put you up to this? You didn't think of it yourself.&quot;
&gt;
&gt;The farmer tried not to tell but the burgomaster questioned him until he found out that Manka was at the bottom of it. This made him very angry. He went into the house and called his wife.
&gt;
&gt;&quot;Manka,&quot; he said, &quot;do you forget what I told you would happen if you went interfering in any of my cases? Home you go this very day. I don't care to hear any excuses. The matter is settled. You may take with you the one thing you like best in my house for I won't have people saying that I treated you shabbily.&quot;
&gt;
&gt;Manka made no outcry.
&gt;
&gt;&quot;Very well, my dear husband, I shall do as you say: I shall go home to my father's cottage and take with me the one thing I like best in your house. But don't make me go until after supper. We have been very happy together and I should like to eat one last meal with you. Let us have no more words but be kind to each other as we've always been and then part as friends.&quot;
&gt;
&gt;The burgomaster agreed to this and Manka prepared a fine supper of all the dishes of which her husband was particularly fond. The burgomaster opened his choicest wine and pledged Manka's health. Then he set to, and the supper was so good that he ate and ate and ate. And the more he ate, the more he drank until at last he grew drowsy and fell sound asleep in his chair. Then without awakening him Manka had him carried out to the wagon that was waiting to take her home to her father.
&gt;
&gt;The next morning when the burgomaster opened his eyes, he found himself lying in the shepherd's cottage.
&gt;
&gt;&quot;What does this mean?&quot; he roared out.
&gt;
&gt;&quot;Nothing, dear husband, nothing!&quot; Manka said. &quot;You know you told me I might take with me the one thing I liked best in your house, so of course I took you! That's all.&quot;
&gt;
&gt;For a moment the burgomaster rubbed his eyes in amazement. Then he laughed loud and heartily to think how Manka had outwitted him.
&gt;
&gt;&quot;Manka,&quot; he said, &quot;you're too clever for me. Come on, my dear, let's go home.&quot;
&gt;
&gt;So they climbed back into the wagon and drove home.
&gt;
&gt;The burgomaster never again scolded his wife but thereafter whenever a very difficult case came up he always said:
&gt;
&gt;&quot;I think we had better consult my wife. You know she's a very clever woman.&quot;</p>
</details>
<p>Stories like this appear in numerous places throughout the world. For example, India has the story of <a href="https://en.wikipedia.org/wiki/Hiranyakashipu">Hiranyakashipu</a>, a king with a boon protecting him from death &quot;by day or by night&quot;, &quot;indoors and out&quot;, etc. Narasimha, an avatar of Vishnu, finds a way around the riddle. </p>
<p>These stories are so common that I might say humans find something universally valuable about them. 
but what in the world does a fairy tale have to do with <em>testing</em>?</p>
<div id="admonition-using-these-notes" class="admonition admonish-warning">
<div class="admonition-title">
<p>Using these notes</p>
<p><a class="admonition-anchor-link" href="02_lambdas_validation/02_lambdas_validation.html#admonition-using-these-notes"></a></p>
</div>
<div>
<p><B>If you're reading these notes without having been in lecture</B>: think about these questions first, before you read the answer! If you don't, you'll be robbing yourself of a chance to participate and learn. (The collapsible sections are meant to help you avoid spoilers while you think.)</p>
</div>
</div>
<p>Don't worry about whether your answer is the same as mine. Especially in 0320, there are often many different good answers, even to technical questions.</p>
<details>
<summary><B>Think, then click!</B></summary>
<p>Clever Manka is a <em>boundary condition tale</em>. There is something special about boundary conditions and how they challenge our preconceptions. <strong>As testers, we should give boundaries the respect they deserve.</strong></p>
<p>(Are you aware of more mythological or literary settings for this sort of boundary-condition riddle? Share them with Tim!)</p>
</details>
<h2 id="boundary-conditions-testing-and-defensive-programming"><a class="header" href="#boundary-conditions-testing-and-defensive-programming">Boundary Conditions: Testing and Defensive Programming</a></h2>
<p>Here's an example: &quot;I have tested a positive number, and I have tested a negative number.&quot; Surely all numbers are positive or negative. <strong>(Is this true?)</strong></p>
<p>Here's another example: &quot;I have tested this function, which accepts a Java <code>Boolean</code>, on both values: true and false.&quot; <strong>(What's missing?)</strong></p>
<p>Never assume that the obvious partition of the space actually covers the space; be on the lookout for special cases, outliers, and even new dimensions about which to think. This isn't only about testing, either---see, for example, the <a href="https://gist.github.com/timvisee/fcda9bbdff88d45cc9061606b4b923ca">Falsehoods Programmers Believe About Time</a>. Part of programming defensively is trying to avoid making unnecessary assumptions, while still allowing for extensibility. Keep this in mind as we start to code (and test) together.</p>
<h2 id="runtime-validation"><a class="header" href="#runtime-validation">Runtime Validation</a></h2>
<p>Ok, so we're on the lookout for faulty assumptions that <em>we</em> might make when programming. But what about <em>other people</em> who might be writing code we depend on—or even code that calls ours? We can't solve this problem, and (as careful as we might be) we can't entirely solve it for ourselves, either. So we'll need to make our code <em>robust</em> against bugs, whether they are our mistakes or others'. </p>
<p><em>Runtime validation</em> involves checking for issues with data your code is given, unexpected changes in state, and so on. Here are two examples. </p>
<h3 id="example-1-user-input"><a class="header" href="#example-1-user-input">Example 1: User Input</a></h3>
<p>Suppose that a user just typed in a pair of numbers and we want to know if one is bigger than another. Because they just arrived, they will be strings, so we need to convert them. No problem: </p>
<pre><code class="language-typescript">function rawGreaterThan(arg1: string, arg2: string): boolean {
    return parseInt(arg1) &gt; parseInt(arg2)
}
</code></pre>
<p>This seems reasonable enough, but it forgets something important about numbers in JavaScript: <code>NaN</code> (not a number) is a number. Since TypeScript is JavaScript with added protection, the same is true in TypeScript. Imagine that a user accidentally types &quot;!00&quot; instead of &quot;100&quot;. In Java, we'd get an exception since <code>&quot;!00&quot;</code> can't be converted to a number. But in TypeScript, <code>parseInt(&quot;!00&quot;)</code> produces a value: <code>NaN</code>. And <code>NaN</code> isn't greater or less than anything! (It can't even be <em>equal</em> to itself: <code>NaN == NaN</code> evaluates to <code>false</code>.) So:</p>
<pre><code class="language-typescript">&gt; parseInt(&quot;!00&quot;) &gt; parseInt(&quot;100&quot;)
false
&gt; parseInt(&quot;!00&quot;) &lt;= parseInt(&quot;100&quot;)
false
</code></pre>
<p>Oh, dear. It's one of those pesky boundary conditions! But the problem is <em>invisible</em> outside of our function. The caller only gets a boolean. Let's do some <em>validation</em> to protect them and us. We'll first check that both arguments can be converted:</p>
<pre><code class="language-typescript">function rawGreaterThan(arg1: string, arg2: string): boolean | undefined {
    const num1 = parseInt(arg1)
    const num2 = parseInt(arg2)
    // num1 === NaN won't work! Instead:
    if(Number.isNaN(num1) || Number.isNaN(num2)) return undefined
    return parseInt(arg1) &gt; parseInt(arg2)
}
</code></pre>
<p>Now the caller will be given something special if there's an issue converting the input to numbers. We could improve this, actually: <code>undefined</code> is better than hiding the problem, but it doesn't communicate much. We could throw an error, but instead let's explore building a better error value. </p>
<pre><code class="language-typescript">interface ConversionError {
    error: &quot;parseInt&quot;
    arg1: string 
    arg2: string
}
</code></pre>
<p>Yeah, that's a string literal as the <em>type</em> of the <code>error</code> field. In TypeScript, this means the type containing only that string. Thus, the <code>error</code> field can only ever be the string <code>&quot;parseInt&quot;</code> So why have that field at all? Because if our larger program can ever produce a different kind of conversion error, we can add other options via union types:</p>
<pre><code class="language-typescript">interface ConversionError {
    error: &quot;parseInt&quot; | &quot;parseFloat&quot;  // | ... | ... | etc.
    arg1: string 
    arg2: string
}
</code></pre>
<p>If we said <code>error: string</code> instead, we'd be allowing <em>any</em> old string. Sometimes this is what you want, but if you're establishing a protocol for reporting errors, you probably want an enumeration of error codes, not arbitrary strings. Anyway, now we can write:</p>
<pre><code class="language-typescript">function rawGreaterThan(arg1: string, arg2: string): boolean | ConversionError {
    const num1 = parseInt(arg1)
    const num2 = parseInt(arg2)
    if(Number.isNaN(num1) || Number.isNaN(num2)) 
        return {error: &quot;parseInt&quot;, arg1: arg1, arg2: arg2}
    return parseInt(arg1) &gt; parseInt(arg2)
}
</code></pre>
<p>The caller is now being told <em>exactly what the problem is</em>, not only that they had some kind of problem. This is only possible because we're now validating the input. </p>
<h3 id="reading-data"><a class="header" href="#reading-data">Reading Data</a></h3>
<p>The same problem occurs if you're reading in data from files or responses to your web requests. Suppose the registrar stored student information in a comma-separated-value (CSV) file:</p>
<pre><code class="language-csv">Name,Credits,Email
Tim Nelson,10,Tim_Nelson@brown.edu
Nim Telson,11,MYAWESOMEEMAIL
</code></pre>
<p>If I expect the third column to contain an email address, I'm going to be <em>very</em> surprised with the data I get from the second row. Hopefully the registrar is validating every column of every row so they can avoid relying on the bad data. But now it's not as simple as it was before: do I need to manually write a validation function that matches all possible email addresses? Argh!</p>
<h3 id="library-support-zod"><a class="header" href="#library-support-zod">Library Support: Zod</a></h3>
<p>Fortunately, people write and share libraries that solve real problems. We'll be using a library called <a href="https://zod.dev">Zod</a>, which is built to help us with exactly these kinds of validation tasks. Zod is free, open source, and widely used. Zod works off of something called a <em>schema</em>, which is kind of analogous to a type (not entirely; more on this later). Here's a schema to validate each CSV row according to the registrar's expectations:</p>
<pre><code class="language-typescript">const studentRowSchema = z.tuple([z.string(), z.coerce.number(), z.email()])
</code></pre>
<p>Zod schemas are compositional. <code>z.string()</code> is a schema that matches any string. <code>z.coerce.number()</code> is a schema that matches any number or any string that can be converted to a number. <code>z.email()</code> is a schema that matches strings containing <em>email addresses</em>. And <code>z.tuple</code> takes an array of schemas and matches arrays of exactly the same length, where each of the sub-schemas matches its corresponding array element. </p>
<p>I hear that at this point, you might be enhancing a CSV parser. Probably it splits a big file into rows, and then splits each row by <code>,</code> (or something like that) to produce an array. So for the 2-row example above, you might get a <code>string[][]</code> that looks like:</p>
<pre><code>[[&quot;Tim Nelson&quot;,&quot;10&quot;,&quot;Tim_Nelson@brown.edu&quot;],
 [&quot;Nim Telson&quot;,&quot;11&quot;,&quot;MYAWESOMEEMAIL&quot;]]
</code></pre>
<p>The first row will match the schema, but the second won't: &quot;MYAWESOMEEWMAIL&quot; isn't an email address. Zod will give a structured error for this failure, although it contains even more detail than the <code>parseInt</code> error we built before. </p>
<p>Zod makes validating external data much, much easier. <strong>Whenever validation becomes non-trivial, stop writing ad-hoc <code>if</code> statements and use Zod instead.</strong></p>
<h3 id="anonymous-functions"><a class="header" href="#anonymous-functions">Anonymous Functions</a></h3>
<p>Zod doesn't just do validation: it can also transform data into new shapes. But it needs us to tell it how that transformation works: a <em>strategy</em> function that says how to map the old shape into the new one. Often, we'll use an anonymous function for this. Anonymous functions are sometimes called &quot;lambdas&quot; (e.g., in Python). Even Java has them in the form of the <code>Function&lt;T, R&gt;</code> interface and special syntax to build them concisely. TypeScript's syntax for these is quite similar to Java's.</p>
<p>For example, let's turn a (validated) CSV row into an object instead:</p>
<pre><code class="language-typescript">const studentRowSchema = z.tuple([z.string(), z.number(), z.email()])
                          .transform(arr =&gt; ({name: arr[0], credits: arr[1], email: arr[2]}))
</code></pre>
<p>Now the first row becomes an object: <code>{name: &quot;Tim Nelson&quot;, credits: 10, email: &quot;Tim_Nelson@Brown.edu&quot;}</code>. </p>
<p>Passing functions arguments to to other functions is so powerful that it appears in multiple contexts. In Object-Oriented Programming, you see it everywhere under the name of &quot;strategy pattern&quot;. For example, <a href="https://docs.oracle.com/javase/8/docs/api/java/util/Collections.html#sort-java.util.List-java.util.Comparator-">Java's <code>Collections.sort</code> method</a> takes an object called a <code>Comparator</code>. A <code>Comparator</code> implements a method that takes two elements of the collection and says whether one is greater than another. In this way, the <code>Collections</code> library allows a single type to be sorted many different ways. </p>
<div id="admonition-but-why-not-just-implement-comparable" class="admonition admonish-note">
<div class="admonition-title">
<p>But why not just implement <code>Comparable</code>?</p>
<p><a class="admonition-anchor-link" href="02_lambdas_validation/02_lambdas_validation.html#admonition-but-why-not-just-implement-comparable"></a></p>
</div>
<div>
<p>Many objects implement Java's <code>Comparable</code> interface, and <code>Collections.sort</code> will indeed use that if no comparator is provided. The advantage of taking arbitrary comparators is in its flexibility: the caller might want to sort in ascending or descending order for example. Records might be sorted by one key or another key, and so on. The strategy pattern is all about flexibility.</p>
</div>
</div>
<h2 id="exercise"><a class="header" href="#exercise">Exercise</a></h2>
<p>I'm not going to start the <em>required</em> exercises this early in shopping period. But I'd still like us to get some practice with TypeScript. </p>
<h3 id="tools-challenge-packagejson"><a class="header" href="#tools-challenge-packagejson">Tools Challenge: <code>package.json</code></a></h3>
<p>Let's start with the toolchain we're using in the course. You've probably cloned the starter repository by now. Let's look at the <code>package.json</code> file together. JSON means &quot;JavaScript Object Notation&quot;, and it's a very common text data format. You'll see fields like <code>dependencies</code> and <code>scripts</code> and so on. <em>What do you think they mean? How do they interact with the <code>npm</code> console command?</em> </p>
<div id="admonition-why-wont-i-just-tell-you" class="admonition admonish-note">
<div class="admonition-title">
<p>Why won't I just tell you?</p>
<p><a class="admonition-anchor-link" href="02_lambdas_validation/02_lambdas_validation.html#admonition-why-wont-i-just-tell-you"></a></p>
</div>
<div>
<p>Research has shown that instruction is more effective if students <em>commit to a hypothesis</em> first, rather than being told the answer immediately. I also want you to finish 0320/1340 with a confidence in making guesses that might be wrong.</p>
</div>
</div>
<h3 id="design-challenge-unchecked-casting"><a class="header" href="#design-challenge-unchecked-casting">Design Challenge: Unchecked Casting</a></h3>
<p>Just like Java, TypeScript has a way to tell the type checker to be quiet because you know best. We call these &quot;unchecked typecasts&quot;. In TypeScript, this happens whenever a value has type <code>any</code>. You might explicitly cast this (via <code>as any</code>) or TypeScript might infer the type because it has no further context. The <code>any</code> type exists because TypeScript needs to interoperate with untyped JavaScript, and it's dangerous to keep around if you don't need it. </p>
<p>Union types mean that TypeScript may be &quot;uncertain&quot; about your code. Here's an example:</p>
<pre><code class="language-typescript">function whatToDo(input: string[] | number): string {
    return input[0]
}
</code></pre>
<p>If the input is a string array, this is fine. But what if it's a number? TypeScript reports this problem with the following error: </p>
<pre><code>Element implicitly has an 'any' type because expression of type '0' can't be used to index type 'number | string[]'.
  Property '0' does not exist on type 'number | string[]'.ts(7053)
</code></pre>
<p><strong>What should you do about this?</strong></p>
<details>
<summary>Think, then click!</summary>
<p>Any time you see something like &quot;Element implicitly has an 'any' type&quot; you should be suspicious. It means that you haven't given TypeScript enough information. This information might need to go in your function headers, in your variable declarations, or the logical flow of your code. Notice what happens when I add an <code>if</code> statement:</p>
<pre><code class="language-typescript">function whatToDo(input: string[] | number): string {
    if(typeof input === &quot;number&quot;) return &quot;&quot;
    return input[0]
}
</code></pre>
<p>The error goes away! TypeScript looks at your conditionals for hints, and uses those hints to resolve union types and other kinds of uncertainty. This is called <em>narrowing</em>, because TypeScript is able to reduce the size of the set of possible values.</p>
</details>
<p>We'll talk more about this trick soon. </p>
<div id="admonition-the-typeof-operator" class="admonition admonish-warning">
<div class="admonition-title">
<p>The <code>typeof</code> operator</p>
<p><a class="admonition-anchor-link" href="02_lambdas_validation/02_lambdas_validation.html#admonition-the-typeof-operator"></a></p>
</div>
<div>
<p>The <code>typeof</code> operator is technically part of JavaScript, and it isn't very precise at all! JavaScript has only a few &quot;types&quot;:</p>
<ul>
<li><code>string</code>;</li>
<li><code>object</code>;</li>
<li><code>number</code>; and
...only a few others. </li>
</ul>
<p>JavaScript, on its own, makes no distinction between an array and an object, or between two different kinds of object. This is one thing TypeScript handles a lot better, but it still can use these basic JavaScript checks.</p>
</div>
</div>
<div style="break-before: page; page-break-before: always;"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.min.css" integrity="sha384-AfEj0r4/OFrOo5t7NnNe46zW/tFgW6x/bCJG8FqQCEo3+Aro6EYUG4+cU+KJWu/X" crossorigin="anonymous">
<h1 id="narrowing-and-refinements"><a class="header" href="#narrowing-and-refinements">Narrowing and Refinements</a></h1>
<h2 id="my-homework"><a class="header" href="#my-homework">My Homework</a></h2>
<p>Last time, a student asked what would happen if we didn't return an object directly, and instead worked with it before returning it.</p>
<pre><code class="language-typescript">function rawGreaterThan(arg1: string, arg2: string): 
  boolean | ConversionError {
    const num1 = parseInt(arg1)
    const num2 = parseInt(arg2)
    if(Number.isNaN(num1) || Number.isNaN(num2)) {
        // This produces an error
        const result = {error: 'parseInt', arg1: arg1, arg2: arg2}
        return result
        // Before, it was:
        //return {error: 'parseInt', arg1: arg1, arg2: arg2}
    }
    return num1 &gt; num2
  }
</code></pre>
<p>The error isn't super helpful:</p>
<pre><code>Type '{ error: string; arg1: string; arg2: string; }' is not assignable to type 'boolean | ConversionError'.
  Type '{ error: string; arg1: string; arg2: string; }' is not assignable to type 'ConversionError'.
    Types of property 'error' are incompatible.
      Type 'string' is not assignable to type '&quot;parseInt&quot; | &quot;parseFloat&quot;'
</code></pre>
<p>But it's surprising, right? Look at that first type. TypeScript isn't using the literal string: it's inferring <code>string</code> for the <code>error</code> field. Initially, TypeScript can directly infer the return type and then check for consistency. TypeScript isn't smart enough to carry that inference over to the value of <code>result</code> without help. So we'll provide it:</p>
<pre><code class="language-typescript">const result: ConversionError = {error: 'parseInt', arg1: arg1, arg2: arg2}
</code></pre>
<p>Now the error goes away. Sometimes we do need to give TypeScript a little help.</p>
<h2 id="testing-as-a-human"><a class="header" href="#testing-as-a-human">Testing as a Human</a></h2>
<p>Suppose your job is to build a statistical app that summarizes United Nations data on population, GDP, and so on. You need to test your app, so think of a country. What country are you thinking of?</p>
<details>
<summary><B>Think, then click!</B></summary>
<p>Chances are, the country you thought of was:</p>
<ul>
<li>close to home; </li>
<li>large; or</li>
<li>in the news often.</li>
</ul>
<p>And it's even more likely that the country you thought of was <strong>currently in existence</strong>. You probably didn't say &quot;the USSR&quot; or &quot;Austria-Hungary&quot;. And note that my choices there were all limited by my own historical knowledge. I went and <a href="https://en.wikipedia.org/wiki/List_of_former_sovereign_states">looked up more</a> after writing that sentence. Even if we only count nations that existed after the U.N. was created, there are many: the Republic of Egypt (1953-1958), the Fourth Brazilian Republic (1946-1964), etc.</p>
<p>This is an example of something called <em>availability bias</em> (or the <em>availability heuristic</em>). All humans exhibit it, and <em>usually</em> it's an advantage: just like caching in a program, our brains tend to recall information in cache. For us, it's an energy-saving measure.</p>
</details>
<p>I'm not a cognitive scientist! If you want to learn more about this in depth, take a CLPS class. But even so, let's ask: <strong>How does this cognitive phenomenon impact software testing?</strong></p>
<details>
<summary><B>Think, then click!</B></summary>
<p>You probably test what you have loaded into your mental cache. If you aren't thinking of it at the moment, or haven't been thinking of it recently, you likely won't test it unless you work to find examples outside your current context.</p>
<p>Even worse, if you aren't aware of the thing to begin with, you won't think to test it. Beware of the kind of thing that Iain Banks called an &quot;outside context problem&quot;, translated from fiction into the real world of testing. This is why getting outside feedback from others can be so valuable for testing.</p>
</details>
<h2 id="typescript-narrowing"><a class="header" href="#typescript-narrowing">TypeScript: Narrowing</a></h2>
<p>We saw last time that TypeScript uses the control flow of your program to infer type information. You can read more about this in the <a href="https://www.typescriptlang.org/docs/handbook/2/narrowing.html">TypeScript documentation</a>. For now, let's do a few narrowing exercises. </p>
<p>Recall: last time we used the <code>typeof</code> operator to check whether a value was a <code>number</code>. This operator is from JavaScript, and there aren't many &quot;types&quot; in that setting: <code>string</code>, <code>number</code> and a few others. To really use TypeScript well, we'll need more than <code>typeof</code>.</p>
<p>Calling a schema's <code>safeParse</code> method in Zod will return either a &quot;success&quot; or &quot;failure&quot; type. If we call <code>parse</code> instead then we might get an exception. I think <code>safeParse</code> is better, because it lets us keep some useful context for the caller in a normal value. Here's an example. First, we'll define the (more simple) schema from last time:</p>
<pre><code class="language-typescript">// Mouse over type: z.ZodTuple&lt;[z.ZodString, z.ZodCoercedNumber&lt;unknown&gt;, z.ZodEmail], null&gt;
const studentRowSchema = z.tuple([z.string(), z.coerce.number(), z.email()])
</code></pre>
<p>We can make the types cleaner by creating a new identifier and using <code>z.infer</code>. But we have to use it right, or we get a strange error:</p>
<pre><code class="language-typescript">// Property 'infer' does not exist on type 
z.infer&lt;typeof studentRowSchema&gt;
</code></pre>
<p>The error isn't great, but it means we're misusing <code>infer</code>. It's not a function in TypeScript; it operates on types. So we can't just call it like it is a normal function; we need to put it into a type context:</p>
<pre><code class="language-typescript">type StudentRow = z.infer&lt;typeof studentRowSchema&gt;
</code></pre>
<p>Now let's call <code>safeParse</code>:</p>
<pre><code class="language-typescript">// We don't need the explicit type annotation here. You can mouse over without it and you'll see:
// type ZodSafeParseResult&lt;T&gt; = z.ZodSafeParseSuccess&lt;T&gt; | z.ZodSafeParseError&lt;T&gt;
// Either way, this is a union type!
const result: z.ZodSafeParseResult&lt;StudentRow&gt; = studentRowSchema.safeParse([&quot;Tim Nelson&quot;, 10, &quot;Tim_Nelson@brown.edu&quot;])
</code></pre>
<p>The <code>result</code> value is either a success or an error. We can try to get the data either way, but it will be <code>undefined</code> in the error case. So this won't work as written:</p>
<pre><code class="language-typescript">// Error: 'result.data' is possibly 'undefined'
result.data[0]
</code></pre>
<p>A great time to use narrowing!</p>
<pre><code class="language-typescript">// This works: we're directly checking that the value is not undefined
if(result.data) {
    result.data[0]
}

// This also works
if(result.success) {
    result.data[0]
}
</code></pre>
<p>Wait: how is TypeScript able to infer the type of <code>result.data</code> based on <code>result.success</code>? Let's look at the definition of these types. </p>
<pre><code class="language-typescript">// From Zod's library code
export type ZodSafeParseResult&lt;T&gt; = ZodSafeParseSuccess&lt;T&gt; | ZodSafeParseError&lt;T&gt;;
export type ZodSafeParseSuccess&lt;T&gt; = {
    success: true;
    data: T;
    error?: never;
};
export type ZodSafeParseError&lt;T&gt; = {
    success: false;
    data?: never;
    error: ZodError&lt;T&gt;;
};
</code></pre>
<p>Notice that the <em>type</em> of <code>success</code> differs. It can only be <code>true</code> in a <code>ZodSafeParseSuccess</code>. That's how TypeScript narrows the type in the second case. </p>
<p><strong>Added after class:</strong> Using <code>result.success</code> to narrow the type of <code>result.data</code> worked above. But if we give an intermediate name to <code>result.data</code> <em>outside the narrowed scope</em>, that variable will have the union type, and the link is broken for TypeScript:</p>
<pre><code class="language-typescript">const student: StudentRow | undefined = result.data
if(result.success) {
  console.log(student[0]) // type error: possibly undefined
}
</code></pre>
<p>But this works, because the variable is declared within the narrowed scope:</p>
<pre><code class="language-typescript">if(result.success) {
  const student2 = result.data
  console.log(student2[0])
}
</code></pre>
<h2 id="escaping-the-any-type"><a class="header" href="#escaping-the-any-type">Escaping the <code>any</code> type</a></h2>
<p>There are built-in ways to parse JSON in TypeScript. Let's play:</p>
<pre><code class="language-typescript">const jsonString = '{&quot;course&quot;: &quot;CSCI 0320&quot;, &quot;instructor&quot;: &quot;Tim Nelson&quot;}';
// cs32 has inferred value *any*. TypeScript sees a string being parsed, it has no way to know the result type.
const cs32 = JSON.parse(jsonString);
</code></pre>
<p>This seems OK, right? But then:</p>
<pre><code class="language-typescript">// We can check whether a key exists on an object
if(&quot;course&quot; in cs32) {
    // Notice the mouseover type is still: any
    console.log(cs32[&quot;course&quot;])    
    // So I can do this with no problem:
    console.log(cs32[&quot;DOESNT_EXIST&quot;])
    // The &quot;if&quot; statement is doing nothing! We get no protection!
}
</code></pre>
<p>TypeScript trusts the <code>any</code> type. It always applies, and so narrowing doesn't matter. This is worse than it appears. What happens if we add a new field?</p>
<pre><code class="language-typescript">const cs32_withLocation = {...cs32, location: &quot;B&amp;H&quot;}
// The inferred type is _still any_. ARGH!
</code></pre>
<p>We might try to protect ourselves</p>
<pre><code class="language-typescript">interface ClassWithLocation {
    course: string,
    instructor: string,
    location: string
}
const cs32_withLocation_better: ClassWithLocation = {...cs32, location: &quot;B&amp;H&quot;}
// Whew! Now we're safe, right? Well...

const jsonString2 = '{&quot;course&quot;: 17, &quot;teacher&quot;: &quot;Tim Nelson&quot;}';
const cs32_bad = JSON.parse(jsonString2)
const cs32_withLocation_bad_better: ClassWithLocation = {...cs32, location: &quot;B&amp;H&quot;}
// Oh. Oh no. TypeScript _trusts the any type_ implicitly. 
// So I can't get where the actual data is:
console.log(&quot;Prof. &quot; + cs32_withLocation_bad_better.teacher)
// But I can reference a field that doesn't exist.
console.log(&quot;Prof. &quot; + cs32_withLocation_bad_better.instructor)
</code></pre>
<p>How do we deal with <code>any</code>? TypeScript has a feature called <a href="https://www.typescriptlang.org/docs/handbook/2/narrowing.html#using-type-predicates">type predicates</a> that can work. But those can be verbose. We'd like a simpler solution in this situation. Fortunately, Zod is great for exactly this.</p>
<pre><code class="language-typescript">const classRecordSchema = z.object({course: z.string(), instructor: z.string()})

// What do you think each of these will produce?
const result1 = classRecordSchema.safeParse(cs32_withLocation_better)
const result2 = classRecordSchema.safeParse(cs32)
const result3 = classRecordSchema.safeParse(cs32_withLocation_bad_better)
</code></pre>
<p>What do you think these produce? Try it. </p>
<details>
<summary>Try it, then click!</summary>
<ul>
<li><code>result1</code>: a success result containing <code>{&quot;course&quot;:&quot;CSCI 0320&quot;,&quot;instructor&quot;:&quot;Tim Nelson&quot;}</code></li>
<li><code>result2</code>: a success result containing <code>{&quot;course&quot;:&quot;CSCI 0320&quot;,&quot;instructor&quot;:&quot;Tim Nelson&quot;}</code></li>
<li><code>result3</code>: an error result reporting 2 <code>invalid_type</code> errors: one for <code>course</code> (<code>number</code>) and one for <code>instructor</code> (<code>undefined</code>). </li>
</ul>
</details>
<p>Notice that both <code>result1</code> and <code>result2</code> contain the same values, even though one of them had a <code>location</code> field originally. This is because Zod throws away fields it isn't told to keep, at least by default. If we want to avoid this, we use <code>.passthrough()</code>:</p>
<pre><code class="language-typescript">const classRecordSchema = z.object({course: z.string(), instructor: z.string()}).loose()
</code></pre>
<p>Now the <code>location</code> field is kept, if there is one there. (But, of course, now TypeScript will need some convincing before it lets you access that field.)</p>
<h2 id="refinements"><a class="header" href="#refinements">Refinements</a></h2>
<p>We saw before that Zod can create schemas that are <em>richer than what TypeScript types can represent.</em>. TypeScript has no type for &quot;email addresses&quot;, but Zod has a schema for them. But a type is just a set. So it's not that these richer schemas can't be thought of as types. Rather, it's that the type checker (which runs at &quot;compile&quot;, or &quot;static&quot; time) isn't expressive enough to handle them. </p>
<p>Whenever we add a further restriction on a base type, we'll call it a <em>refinement</em> of that type. So, &quot;it's a string, but in email-address format&quot; would refine &quot;it's a string&quot;. Zod has a lot of these, including a <a href="https://zod.dev/api#refinements">very expressive method</a>: <code>.refine()</code>, which takes a refinement function:</p>
<pre><code class="language-typescript">const evenNumberSchema = z.number().refine( num =&gt; num % 2 == 0)

const departments = ['CSCI', 'MATH', 'MCM'] // etc.
const refinedClassRecordSchema = z.object(
    {course: z.string().refine( c =&gt; departments.includes(c.split(' ')[0])), 
     instructor: z.string()})
const course1 = refinedClassRecordSchema.safeParse(cs32)
console.log(course1.data)
</code></pre>
<p>By the way, watch out for &quot;in&quot;. You might want it to work like it does in Python, but:</p>
<pre><code class="language-typescript">&gt; 0 in [0, 1, 2]
true
&gt; &quot;a&quot; in [&quot;a&quot;,&quot;b&quot;,&quot;c&quot;]
false
</code></pre>
<p>Use <code>lst.includes()</code> instead.</p>
<h2 id="exercise-building-a-suite-for-csv"><a class="header" href="#exercise-building-a-suite-for-csv">Exercise: Building a suite for CSV</a></h2>
<p>Your first sprint asks you to build tests that probe how the parser we gave you might not be handling CSVs very well. We want you to think carefully about what's missing, but it's also a useful place to take time in class and talk about using Copilot to synthesize tests. </p>
<p>I've used Copilot a good amount now, and sometimes it's <em>great</em> at building test suites, and other times not so much: I've often needed to prompt it to change something, or to realize there's an issue with a test it wrote. So let's get some practice critiquing. We'll do this over multiple classes. </p>
<p>How do you want to start?</p>
<div style="break-before: page; page-break-before: always;"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.min.css" integrity="sha384-AfEj0r4/OFrOo5t7NnNe46zW/tFgW6x/bCJG8FqQCEo3+Aro6EYUG4+cU+KJWu/X" crossorigin="anonymous">
<h1 id="narrowing-and-refinements-1"><a class="header" href="#narrowing-and-refinements-1">Narrowing and Refinements</a></h1>
<h2 id="logistics-2"><a class="header" href="#logistics-2">Logistics</a></h2>
<p>Good job on sprint 1.</p>
<p>My &quot;note of encouragement&quot; post has only been read by 107 unique users. The week 2 summary has done better (128 unique users), but very few have responded with an emoji. (These counts also include any staff members who have clicked the threads.)</p>
<p>We will pause for a couple of minutes so <em>everyone can read my post</em>.</p>
<p>Now: everyone turn to your neighbor and show them something from your sprint 1 solution. Let's normalize collaboration...</p>
<h2 id="exercise-disappointing-types"><a class="header" href="#exercise-disappointing-types">Exercise: Disappointing Types</a></h2>
<p>We'll start with today's in-class exercise. I'd like you all to look at <a href="https://github.com/cs0320/class-livecode/tree/main/F25/sep16_refinements/exercise">this Java project</a> in the livecode repository.  There are some questions for you in <a href="https://docs.google.com/forms/d/e/1FAIpQLSf_PGN5rsDbH3soKd1v2huSpjIV5IK4kc0thwqB65-BuN7uSg/viewform?usp=dialog">this web form</a>.</p>
<p>Now would be a great time to <a href="https://github.com/cs0320/class-livecode">clone the repository</a>. We won't be using Java much this semester, so we don't provide a formal setup process. I wanted to make this exercise more accessible, so used Java. When we do use Java, the projects use Maven for dependencies: open the <code>pom.xml</code> file as a project in IntelliJ, not the folder. But you don't need to run the code (right now) to do the exercise. </p>
<p><strong>What do you notice?</strong></p>
<h2 id="types-of-type-system"><a class="header" href="#types-of-type-system">Types of Type System</a></h2>
<p>Let's continue on from last time.</p>
<h3 id="type-assertions--typecasting"><a class="header" href="#type-assertions--typecasting">Type Assertions / Typecasting</a></h3>
<p>In Java, you've likely seen typecasting, or &quot;downcasting&quot;, that looks like this:</p>
<pre><code class="language-java">Object anObject = new ArrayList&lt;Integer&gt;();
// I can't refer to anObject.size() because the variable has type Object. 
// So I can tell Java &quot;I know better than you; it's an ArrayList&quot;. Something like this:
System.out.println(((ArrayList&lt;Integer&gt;)anObject).size());
</code></pre>
<p>This is called a <em>typecast</em>, or more precisely a <em>downcast</em> (because it asserts that an object has a more specific type—further down the type hierarchy—than what Java inferred). These are sometimes necessary, but in general they are dangerous: what happens if I'm wrong? What happens if that object is actually something different? I get an exception at runtime. Ouch!</p>
<p>TypeScript has a form of downcasting, too: the <code>as</code> keyword. We can always disable TypeScript on anything by asserting it has the expected type (or, even more dangerously, <code>any</code>). As a general rule, <em>you won't want to use this operator</em>. When in doubt, ask. </p>
<p>(Funnily enough, when I was experimenting with Copilot over the summer it kept trying to add <code>(as any)</code> to a bunch of stuff, even when it wasn't necessary.)</p>
<h3 id="structural-not-nominal"><a class="header" href="#structural-not-nominal">Structural, not Nominal</a></h3>
<p>TypeScript types corresponding to Zod schemas will only be as specific as TypeScript itself can support.</p>
<pre><code class="language-typescript">type ClassRecord = z.infer&lt;typeof refinedClassRecordSchema&gt;
</code></pre>
<p>If you mouse over this type, you'll see:</p>
<pre><code class="language-typescript">type RefinedClassRecord = {
    course: string;
    instructor: string;
}
</code></pre>
<p>That's missing our refinement, which makes sense because TypeScript's types can't express our schema refinement.</p>
<p>TypeScript is <em>structurally</em> typed, not <em>nominally</em> typed (meaning that it looks at the structure of objects, not the actual name of their types). This is in contrast to languages like Java, where it's the name that matters. </p>
<p>Because it only cares about <em>structure</em>, TypeScript won't stop me from claiming that an object with these fields (of the less specific types) is a <code>ClassRecord</code>:</p>
<pre><code class="language-typescript">// No type error
const uhoh: ClassRecord = {course: &quot;NOT A VALID COURSE ID&quot;, instructor: &quot;&quot;}
</code></pre>
<p>This is a threat to success: I might accidentally manufacture a value that, to TypeScript, <em>looks</em> like something Zod has validated. </p>
<h3 id="type-branding"><a class="header" href="#type-branding">Type Branding</a></h3>
<p>Let's make it impossible to create a <code>ClassRecord</code> without going through Zod first. We'll use something called &quot;type branding&quot;: add a special flag (which won't exist at runtime) to the type that only Zod can add. At a basic level, this is easy: we'll just <code>.brand()</code> the schema. </p>
<pre><code class="language-typescript">const brandedCRSchema = refinedClassRecordSchema.brand(&quot;ClassRecord&quot;)
type BrandedCR = z.infer&lt;typeof brandedCRSchema&gt;
const uhoh2: BrandedRCR = {course: &quot;NOT A VALID COURSE ID&quot;, instructor: &quot;&quot;}
</code></pre>
<p>If you mouse over <code>BrandedRCR</code> you'll see something strange:</p>
<pre><code class="language-typescript">type BrandedRCR = {
    course: string;
    instructor: string;
} &amp; z.core.$brand&lt;&quot;RefinedClassRecord&quot;&gt;
</code></pre>
<p>That <code>&amp;</code> means <em>intersection</em> (the same as we use <code>|</code> to build unions). If a value doesn't carry that brand, it can't be used as an instance of this type. Hence, <code>uhoh2</code> now gives an error. This is a longhanded way to say that the brand is missing:</p>
<pre><code>Type '{ course: string; instructor: string; }' is not assignable to type '{ course: string; instructor: string; } &amp; $brand&lt;&quot;RefinedClassRecord&quot;&gt;'.
  Property '[$brand]' is missing in type '{ course: string; instructor: string; }' but required in type '$brand&lt;&quot;RefinedClassRecord&quot;&gt;
</code></pre>
<h3 id="a-danger-of-mutable-state"><a class="header" href="#a-danger-of-mutable-state">A Danger of Mutable State</a></h3>
<p>Type branding isn't perfect. One major threat is that <em>if these objects are mutable</em>, then the guarantees might hold immediately but then stop holding (without TypeScript protection!) after some code changes the object.</p>
<pre><code class="language-typescript">const brandedCRSchema = refinedClassRecordSchema.brand(&quot;ClassRecord&quot;)
type BrandedCR = z.infer&lt;typeof brandedCRSchema&gt;
const uhoh2: BrandedCR = {course: &quot;NOT A VALID COURSE ID&quot;, instructor: &quot;&quot;}
const cs32 = brandedCRSchema.safeParse({course: &quot;CSCI 0320&quot;, instructor: &quot;Tim Nelson&quot;}).data

if(cs32 !== undefined)
  cs32[&quot;course&quot;] = &quot;FAKE 1234&quot;

</code></pre>
<p>TypeScript objects are mutable, similar to fields in Java objects. In Java, we can prevent a field from being modified with the <code>final</code> keyword. In TypeScript, we use <code>readonly</code> when declaring a field. Zod will even help us if we call the <code>.readonly()</code> method on a schema:</p>
<pre><code class="language-typescript">/** Schema for valid class records. */
const refinedClassRecordSchema = z.object(
    {course: z.string().refine( c =&gt; departments.includes(c.split(' ')[0])), 
     instructor: z.string()}).readonly()
</code></pre>
<p>Now, when we mouse over the inferred type:</p>
<pre><code class="language-typescript">type ClassRecord = {
    readonly course: string;
    readonly instructor: string;
}
</code></pre>
<p><strong>Beware</strong>: again, just like with <code>final</code> in Java, declaring a <em>field</em> immutable doesn't mean that an object stored in that field is itself immutable. If we were storing something more complicated than strings in those fields, we'd want to mark the inner schemas as <code>.readonly()</code> as well.</p>
<p>Branding and mutability are sometimes subtle, especially when trying to create cyclic data. See the separate <a href="https://docs.google.com/document/d/115A3utnCRM71jOGlXV6hqGzvHgA7psPo218JpXtnSPI/edit?usp=sharing">types document</a> we wrote for more on this.</p>
<h2 id="reminder-copilot-chats-do-persist"><a class="header" href="#reminder-copilot-chats-do-persist">Reminder: Copilot chats do persist!</a></h2>
<p>Copilot chats persist, but they are stored in a <em>workspace</em>-specific way. 
So if you're wondering how to recover a chat, just make sure you're in the same workspace as when you created it. To see the chats you've created in the current workspace, open the command palette (Cmd-Shift-P on Mac) and select &quot;Chat: Show Chats&quot;. </p>
<p>In case you're interested: each workspace has a unique ID and a folder for all its storage. If you have Copilot installed, you can see where this is by opening the command palette (Cmd-Shift-P on Mac) and selecting &quot;Developer: Open Chat Storage Folder&quot;. The chat logs are stored as JSON, and are rather verbose.</p>
<div style="break-before: page; page-break-before: always;"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.min.css" integrity="sha384-AfEj0r4/OFrOo5t7NnNe46zW/tFgW6x/bCJG8FqQCEo3+Aro6EYUG4+cU+KJWu/X" crossorigin="anonymous">
<h1 id="web-apis-and-integration-testing-with-mocks"><a class="header" href="#web-apis-and-integration-testing-with-mocks">Web APIs and Integration Testing with Mocks</a></h1>
<p>This chapter combines some notes from Fall 2025 and Spring 2025. As such, it will have examples in both TypeScript and in Java. </p>
<h2 id="web-apis"><a class="header" href="#web-apis">Web APIs</a></h2>
<p>There's a lot of useful information out there on the web.  One way we might work with that info is to <em>scrape</em> websites: write a script that interacts with the HTML on a webpage to extract the info.</p>
<h3 id="why-not-web-scraping"><a class="header" href="#why-not-web-scraping">Why Not Web Scraping?</a></h3>
<p>What are some weaknesses of web scraping, from the perspective of both the person doing the scraping, and the person who is running the website?</p>
<details><summary><B>Think, then click!</B></summary>
<p>A few issues might be:</p>
<ul>
<li>The owner of the data might want to charge for access in a fine-grained way, or limit access differently from the way it works on a webpage. </li>
<li>Web scraping is unstable. If a site's format changes, web-scraper scripts can break. APIs can have breaking changes too, but when they do, the changes usually come with a warning to users!</li>
<li>Web scraping is mostly a one-sided effort. While a site designer might work to ease the job of web scrapers, details can still require some guesswork on the part of the script author.</li>
</ul>
</details>
<p>It turns out that ideas from web-scraping will remain useful though, when we get to testing front-end applications in a few weeks.</p>
<h3 id="web-apis-1"><a class="header" href="#web-apis-1">Web APIs</a></h3>
<p>APIs work like this: the user sends a structured request to the API, which replies in a documented, structured way. API is short for <em>Application Programming Interface</em>, and often you'll hear the set of functions it provides to users called the &quot;interface&quot;. </p>
<p>This is an example of an &quot;interface&quot; in the broad, classical sense. It isn't a <em>Java</em> <code>interface</code>. It's one of many ways for two programs to communicate across the web, but it's <em>specific</em> and <em>well-defined</em>.</p>
<p>APIs are everywhere. Whenever you log in via Google (even on a non-Google site) you're using <a href="https://developers.google.com/identity">Google's Authentication API</a>. </p>
<p>APIs are very like method calls! The pictures are very similar:</p>
<p><img src="04_refinements_mutability/./method_call.png" width="45%"/> <img src="04_refinements_mutability/./api_call.png" width="45%"/></p>
<p>The differences are in the ways we go about making a call (and processing the result). E.g., we have to build a request string that embodies the call, and we have to turn the response object into usable data.</p>
<h3 id="example-national-weather-service"><a class="header" href="#example-national-weather-service">Example: National Weather Service</a></h3>
<p>Let's start right away with a serious, high-volume API: the U.S. National Weather Service. These APIs tend to be <a href="https://www.weather.gov/documentation/services-web-api">well-documented</a>. We'll use the NWS because, while many professional APIs require registration and the use of an API key to use them, the NWS API is free and requires no registration. </p>
<p>The NWS API is not the exact API you will be using on the sprint, but I like it for demonstrating the same kind of interaction you'll need to implement.</p>
<p>Let's get weather information for Providence. Our geocordinates here are: <code>41.826820</code>, <code>-71.402931</code>. According to the docs, we can start by sending a <code>points</code> query with these coordinates: <a href="https://api.weather.gov/points/41.8268,-71.4029">https://api.weather.gov/points/41.8268,-71.4029</a>:</p>
<h4 id="queries"><a class="header" href="#queries">Queries</a></h4>
<p>There are a few things to notice right away. First, the URL we sent had a <em>host</em> portion (<code>https://api.weather.gov</code>) and an <em>endpoint</em> (called, confusingly, <code>points</code>) that represents the kind of query we're asking. Then there are <em>parameters</em> to the query (<code>41.8268,-71.4029</code>). </p>
<div id="admonition-why-4-significant-digits-rather-than-6-which-is-what-we-might-see-in-the-browser" class="admonition admonish-note">
<div class="admonition-title">
<p>Why 4 significant digits, rather than 6, which is what we might see in the browser?</p>
<p><a class="admonition-anchor-link" href="04_refinements_mutability/04.5.apis-integration.html#admonition-why-4-significant-digits-rather-than-6-which-is-what-we-might-see-in-the-browser"></a></p>
</div>
<div>
<p>Because last year, the API would give an error if we tried to provide 6 significant digits. So we truncate.</p>
</div>
</div>
<h4 id="responses"><a class="header" href="#responses">Responses</a></h4>
<p>We get this back:</p>
<pre><code>{
    &quot;@context&quot;: [
        &quot;https://geojson.org/geojson-ld/geojson-context.jsonld&quot;,
        {
            &quot;@version&quot;: &quot;1.1&quot;,
            &quot;wx&quot;: &quot;https://api.weather.gov/ontology#&quot;,
            &quot;s&quot;: &quot;https://schema.org/&quot;,
            &quot;geo&quot;: &quot;http://www.opengis.net/ont/geosparql#&quot;,
            &quot;unit&quot;: &quot;http://codes.wmo.int/common/unit/&quot;,
            &quot;@vocab&quot;: &quot;https://api.weather.gov/ontology#&quot;,
            &quot;geometry&quot;: {
                &quot;@id&quot;: &quot;s:GeoCoordinates&quot;,
                &quot;@type&quot;: &quot;geo:wktLiteral&quot;
            },
            &quot;city&quot;: &quot;s:addressLocality&quot;,
            &quot;state&quot;: &quot;s:addressRegion&quot;,
            &quot;distance&quot;: {
                &quot;@id&quot;: &quot;s:Distance&quot;,
                &quot;@type&quot;: &quot;s:QuantitativeValue&quot;
            },
            &quot;bearing&quot;: {
                &quot;@type&quot;: &quot;s:QuantitativeValue&quot;
            },
            &quot;value&quot;: {
                &quot;@id&quot;: &quot;s:value&quot;
            },
            &quot;unitCode&quot;: {
                &quot;@id&quot;: &quot;s:unitCode&quot;,
                &quot;@type&quot;: &quot;@id&quot;
            },
            &quot;forecastOffice&quot;: {
                &quot;@type&quot;: &quot;@id&quot;
            },
            &quot;forecastGridData&quot;: {
                &quot;@type&quot;: &quot;@id&quot;
            },
            &quot;publicZone&quot;: {
                &quot;@type&quot;: &quot;@id&quot;
            },
            &quot;county&quot;: {
                &quot;@type&quot;: &quot;@id&quot;
            }
        }
    ],
    &quot;id&quot;: &quot;https://api.weather.gov/points/41.8268,-71.4029&quot;,
    &quot;type&quot;: &quot;Feature&quot;,
    &quot;geometry&quot;: {
        &quot;type&quot;: &quot;Point&quot;,
        &quot;coordinates&quot;: [
            -71.402900000000002,
            41.826799999999999
        ]
    },
    &quot;properties&quot;: {
        &quot;@id&quot;: &quot;https://api.weather.gov/points/41.8268,-71.4029&quot;,
        &quot;@type&quot;: &quot;wx:Point&quot;,
        &quot;cwa&quot;: &quot;BOX&quot;,
        &quot;forecastOffice&quot;: &quot;https://api.weather.gov/offices/BOX&quot;,
        &quot;gridId&quot;: &quot;BOX&quot;,
        &quot;gridX&quot;: 64,
        &quot;gridY&quot;: 64,
        &quot;forecast&quot;: &quot;https://api.weather.gov/gridpoints/BOX/64,64/forecast&quot;,
        &quot;forecastHourly&quot;: &quot;https://api.weather.gov/gridpoints/BOX/64,64/forecast/hourly&quot;,
        &quot;forecastGridData&quot;: &quot;https://api.weather.gov/gridpoints/BOX/64,64&quot;,
        &quot;observationStations&quot;: &quot;https://api.weather.gov/gridpoints/BOX/64,64/stations&quot;,
        &quot;relativeLocation&quot;: {
            &quot;type&quot;: &quot;Feature&quot;,
            &quot;geometry&quot;: {
                &quot;type&quot;: &quot;Point&quot;,
                &quot;coordinates&quot;: [
                    -71.418784000000002,
                    41.823056000000001
                ]
            },
            &quot;properties&quot;: {
                &quot;city&quot;: &quot;Providence&quot;,
                &quot;state&quot;: &quot;RI&quot;,
                &quot;distance&quot;: {
                    &quot;unitCode&quot;: &quot;wmoUnit:m&quot;,
                    &quot;value&quot;: 1380.4369590568999
                },
                &quot;bearing&quot;: {
                    &quot;unitCode&quot;: &quot;wmoUnit:degree_(angle)&quot;,
                    &quot;value&quot;: 72
                }
            }
        },
        &quot;forecastZone&quot;: &quot;https://api.weather.gov/zones/forecast/RIZ002&quot;,
        &quot;county&quot;: &quot;https://api.weather.gov/zones/county/RIC007&quot;,
        &quot;fireWeatherZone&quot;: &quot;https://api.weather.gov/zones/fire/RIZ002&quot;,
        &quot;timeZone&quot;: &quot;America/New_York&quot;,
        &quot;radarStation&quot;: &quot;KBOX&quot;
    }
}
</code></pre>
<p>This <em>wasn't nicely formatted</em> for human reading. Why? Because it's meant for programs to consume. This string should bear a remarkable resemblance to TypeScript objects. It's called Json: <em>JavaScript Object Notation</em>. When we write programs that work with web APIs, we'll never manually parse these, we'll use a library that does it for us. In general:</p>
<ul>
<li>when we're converting data or an object in our program to a format meant for transmission (like Json) we'll call it <em>serialization</em>; and</li>
<li>when we're converting a transmission format (like Json) into data or an object in our program, we'll call it <em>deserialization</em>.</li>
</ul>
<p>What else do you notice about this data? </p>
<details>
<summary>Think, then click!</summary>
<p>One thing is: <strong>you can ignore a lot of it</strong>. This first query gives us useful information for <em>further</em> uses of the API. Another is that there's no actual weather information here...</p>
</details>
</br>
<p>See the documentation to understand the meaning of specific fields in the response. At a high level, this query tells us <em>which NWS grid location</em> Providence is in, along with telling us URLs for common queries about that grid location. The NWS API needs you to work with it in stages. </p>
<h2 id="building-api-servers"><a class="header" href="#building-api-servers">Building API Servers</a></h2>
<p>We've provided a number of examples of setting up an API server. Whether we're doing this in Java or TypeScript, the flow of our <em>proxy server</em> for weather will look roughly like this:</p>
<ul>
<li>When our server starts up, it listens for requests on a set of endpoints. We need to register an endpoint (for callers to make weather requests) and a <em>handler</em> callback for the server to call when it gets a request. </li>
<li>When someone sends our API server a request for the weather, it passes the request to the handler we gave it.</li>
<li>The handler sends a request of its own to the NWS, asking what their grid coordinates are for the geo-location given.</li>
<li>The handler sends a second request to the NWS for the forecast at that location. </li>
<li>Once the forecast is received, the handler assembles a JSON response and sends it back to the original caller—reporting the weather forecast.</li>
</ul>
<p>You can see a much-simplified version of this loop in my example <a href="04_refinements_mutability/">Providence Weather app</a>. The source code is (<a href="https://github.com/tnelson/pvd-weather">here</a>). </p>
<div id="admonition-this-was-a-summer-copilot-project" class="admonition admonish-note">
<div class="admonition-title">
<p>This was a summer Copilot project</p>
<p><a class="admonition-anchor-link" href="04_refinements_mutability/04.5.apis-integration.html#admonition-this-was-a-summer-copilot-project"></a></p>
</div>
<div>
<p>This was one of the first things I built with Copilot over the summer, as I was working on the course. The <a href="https://github.com/tnelson/pvd-weather/blob/main/README.md">README file</a> in the repo has some notes about how it went. Copilot was great for building the initial prototype, but had some trouble with the structure of the JSON it needed to process and adding TypeScript types.</p>
</div>
</div>
<!-- ### Setting up a server

We'll use a library called Sparkjava to run our API servers. Sparkjava is relatively simple to set up: we just tell it which port to use (here, `3232`), which endpoints to listen at, and for each, a handler object (there's the strategy pattern again!) that processes requests.

~~~admonish warning title="Sparkjava came first, but..."
If you Google for 'spark', you're likely to get answers related to [Apache Spark](https://spark.apache.org), a more popular library that happens to be for data science, not web servers. Watch out!
~~~

In the livecode for today, you'll see the entry point in the `Server.java` file. The code looks something like this:

```java
private final WeatherDatasource state = new NWSAPIWeatherSource();
Spark.port(port);
Spark.get("/weather", new WeatherHandler(state));
Spark.awaitInitialization();
```

In this case, the `WeatherHandler` object's constructor takes a _data source object_. Why do you think that is? 

<details>
<summary>Think, then click!</summary>
    
Extensibility and testing! If we added more handlers, we'd probably need to share some state between them. This sort of _dependency injection_ allows us to do just that. We might even wrap the datasource in a class that holds other kinds of state or other data sources.
    
</details>

Each of these handler classes handles queries sent to a specific endpoint. Here, queries to `weather` are handled by a `WeatherHandler` object.

You might notice that the data source being created is a `NWSAPIWeatherSource`, but it's being used only by an interface, `WeatherDatasource`. This enables some very useful techniques, including better testing.  -->
<h3 id="testing-api-servers-example-of-integration-testing"><a class="header" href="#testing-api-servers-example-of-integration-testing">Testing API Servers: Example of Integration Testing</a></h3>
<p>Our philosophy is generally that you'll be able to test most everything you do. So: <strong>how can I test my API server?</strong></p>
<p>One way is to write unit tests. E.g., if we have a CSV data source (hint: you do!), we should have unit tests for that. If we have a source that goes to the National Weather Service to fetch forecasts, we should test that. </p>
<p>But neither of those will test the <em>handlers</em>, or anything between the handler and the data source. We need to test the combination of a number of units: the code that accesses the data source, code (if any) that processes the raw data, the API handlers of our server, etc. When you're testing the <em>integration</em> of multiple components in your application (such as our server tests) this is called <em>integration testing</em>. </p>
<p>The gearups contain examples of how to set this up. In brief, you start up the server and send &quot;fake&quot; API queries as part of each of your test cases. Then each test looks at the responses and decides whether they are good or bad.</p>
<!-- One way, which is what we did in prior semesters, is to write a test class that starts up our server locally, sends it web requests, and evaluates the response&mdash;all done on the local computer, no Internet connection needed. In Spring 2025, we're instead using a tool called Postman, which can help us script API requests and examine responses. For the moment, we'll just use it as a library of example queries that we can manually inspect results for.  -->
<h3 id="mocking-a-remarkably-powerful-technique"><a class="header" href="#mocking-a-remarkably-powerful-technique">Mocking (a remarkably powerful technique)</a></h3>
<p>Consider what happens when I run integration tests. These generate web requests to our server, and then (assuming normal operation), our server will send a series of web requests to the NWS API. This is reasonable, but has a number of problems. What issues have I introduced into my testing because <em>running the tests requires the NWS API</em>?</p>
<details>
<summary>Think, then click!</summary>
<p>At the very least, the more I test (and I should test often!), the more I'll be spamming the NWS with requests. If I do it too much, they might think I am running a denial-of-service attack on them, and rate limit my requests. I also just can't run my test suite without an Internet connection, or if the NWS is down for maintenance. </p>
<p>(There are other reasons, too.)</p>
</details>
<p>You'll use mocking in every sprint from now until the class is over; we've only barely discovered how important it is as a technique. And the patterns we have learned so far are perfect for implementing mocking well. To start with, a data source can be a strategy provided by the caller (real or mock). </p>
<p>The <a href="https://github.com/cs0320/class-livecode/tree/main/F25/sep25_mocking_brain_jar">Mocking example</a> from the live code shows one way to do this. You can also use Jest or Playwright themselves to mock certain functionality like input and output. </p>
<div id="admonition-why-does-the-example-not-just-use-a-testing-framework" class="admonition admonish-note">
<div class="admonition-title">
<p>Why does the example not just use a testing framework?</p>
<p><a class="admonition-anchor-link" href="04_refinements_mutability/04.5.apis-integration.html#admonition-why-does-the-example-not-just-use-a-testing-framework"></a></p>
</div>
<div>
<p>A more conceptual example can demonstrate generally useful ideas like dependency injection without tying them to how those ideas are used by a specific library. In particular, notice how dependency injection here is just passing an argument to a factory function.</p>
</div>
</div>
<div style="break-before: page; page-break-before: always;"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.min.css" integrity="sha384-AfEj0r4/OFrOo5t7NnNe46zW/tFgW6x/bCJG8FqQCEo3+Aro6EYUG4+cU+KJWu/X" crossorigin="anonymous">
<h1 id="threads-and-promises"><a class="header" href="#threads-and-promises">Threads and Promises</a></h1>
<p>The material in these notes goes deeper than we can cover in class. If you're having issues with concurrency, parallelism, or asynchronous execution: <strong>read these notes</strong>! If you're having trouble with the difference between promises and threads, <strong>read these notes!</strong></p>
<h2 id="motivating-concurrency"><a class="header" href="#motivating-concurrency">Motivating Concurrency</a></h2>
<p>Let's go back to the hours queue dispatcher. You can find a more complete version of the example in the project linked at the beginning of these notes.</p>
<p>If we run the <code>main</code> method in the <code>Main</code> class of this new example, we'll get something like this (using TA names from a prior semester):</p>
<pre><code>08:45:09:837 Dispatcher: Welcome to edu.brown.cs32.livecode.threads.TA hours!
08:45:09:839 Dispatcher: Hi Nim; you'll be seen by Erica
08:45:09:844 Erica says: Hello Nim!
Erica says: Goodbye Nim, I hope that helped!!
08:45:10:859 Dispatcher: Hi Alice; you'll be seen by Erica
08:45:10:859 Erica says: Hello Alice!
Erica says: Goodbye Alice, I hope that helped!!
08:45:11:865 Dispatcher: Hi Bob; you'll be seen by Erica
08:45:11:865 Erica says: Hello Bob!
Erica says: Goodbye Bob, I hope that helped!!
08:45:12:870 Dispatcher: Hi Charli; you'll be seen by Erica
08:45:12:871 Erica says: Hello Charli!
Erica says: Goodbye Charli, I hope that helped!!
08:45:13:876 Dispatcher: Hi Boatswain; you'll be seen by Erica
08:45:13:877 Erica says: Hello Boatswain!
Erica says: Goodbye Boatswain, I hope that helped!!
08:45:14:882 Dispatcher: Hi Bucky; you'll be seen by Erica
08:45:14:882 Erica says: Hello Bucky!
Erica says: Goodbye Bucky, I hope that helped!!
08:45:15:887 Dispatcher (6 helped so far): Nobody waiting in queue, will check again in three seconds.
</code></pre>
<p>Until we look at the timestamps, this seems fine.</p>
<p>This doesn't look so great. We have some problems to solve. If you look at the code, you might see other problems too. Here are three:</p>
<ul>
<li>Challenge 1: the dispatcher is waiting for <em>an individual TA</em> to finish helping a student before allocating the next TA. Lots of TAs will be idle, and students will wait a lot longer.</li>
<li>Challenge 2: maybe we'd like to add TAs while the dispatcher is running.</li>
<li>Challenge 3: how can new students join the queue?</li>
</ul>
<p>All of these problems are related to today's topic: <em>concurrency</em>:</p>
<ul>
<li>We'd like TAs to be able to help students without holding up the dispatcher from allocating other students to other TAs. <em>We need the dispatcher to run concurrently with the TAs.</em></li>
<li>We need a way for the <code>Main</code> class to call <code>dispatcher.addTA()</code> after the dispatcher starts running. But right now, there's no way for the <code>Main</code> class to run independently of the dispatcher. <em>We need the dispatcher to run concurrently with the <code>main()</code> method.</em></li>
<li>We need a way for new students to be added to the queue. This is the same problem as above!</li>
</ul>
<p>Concerns like these pop up all the time in engineering. (The problem isn't just that the way I've written the dispatcher library is not very realistic.)</p>
<p>Here's a picture demonstrating the current state of affairs. These are called <em>sequence diagrams</em>, and they are very common in networking and distributed systems. Each vertical line corresponds to an entity (in this case, 3 different classes). Horizontal lines are messages or method calls. We can see the control flow, in a single thread, passing between the classes. Because <code>Erica</code> is always the first free TA in the list whenever the dispatcher gets to go, <code>Erica</code> is the only TA who gets to see students.</p>
<p><img src="05_threads_promises/./Seq1.jpg" alt="Single-threaded sequence diagram" /></p>
<h2 id="how-does-concurrency-help-us"><a class="header" href="#how-does-concurrency-help-us">How does concurrency help us?</a></h2>
<p>A program is <em>concurrent</em> if it involves multiple simultaneous threads of execution. Note that this doesn't necessarily mean that these multiple threads really are running at the same time, just that they are &quot;executing&quot;. We will make a distinction in this class between concurrency and <em>parallelism</em>, where threads really are executing at the same time, usually on multi-core hardware or in the cloud. <strong>A parallel program is always concurrent, but the threads of a concurrent program may or may not actually be run in parallel.</strong></p>
<p>To illustrate this idea, consider what your computer is doing right now. You're probably running more programs than you can count, even before you think about what your operating system is doing. How many CPU cores do you have? Probably not more than a dozen (and likely fewer). So not all of the concurrency that's happening can be parallelized: you'd need hundreds of cores for that! Instead, your operating system runs a <em>scheduler</em> program which allocates slices of time to different threads of execution. </p>
<p>Concurrency is more common than you might imagine. Because we're working with Java, <em>every</em> program you write is concurrent, even a &quot;Hello World!&quot; program. Why?</p>
<details>
<summary><B>Think, then click!</B></summary>
<p>The garbage collector!</p>
</details>
<h3 id="using-concurrency-to-get-what-we-want"><a class="header" href="#using-concurrency-to-get-what-we-want">Using concurrency to get what we want</a></h3>
<p>Imagine logically splitting our big program into separate, independent &quot;threads&quot; of execution: one that runs the dispatcher, another that runs when a TA helps a student, and so on. We just need to separate them from each other, and help them communicate.</p>
<p>So far we've only had one thread: the one that starts up in our <code>main</code> method. How do we get another, and which should it correspond to?</p>
<details>
<summary><B>Think, then click! (Image within...) </B></summary>
<p>There are a few options. But let's start simply, and not try to solve <em>all</em> the challenges at once. We'll have every TA correspond to their own thread, and have those threads woken up by the dispatcher. it would look something like this:</p>
<p><img src="05_threads_promises/./Seq2.jpg" alt="Multi-threaded sequence diagram" /></p>
<p><em>The triangle is a drawing error I need to remove, but I ran out of time before class. :-)</em></p>
</details>
<h3 id="runnables-and-threads"><a class="header" href="#runnables-and-threads">Runnables and Threads</a></h3>
<p>Java has an interface called <code>Runnable</code>, which requires the implementation of a <code>run()</code> method. It's also got a class called <code>Thread</code>, which has a constructor that accepts a <code>Runnable</code> and a method called <code>start()</code>. So, as a first cut, let's make <code>TA</code> implement <code>Runnable</code>, and whenever we dispatch a student to that TA, we run the thread.</p>
<pre><code class="language-java">public class TA implements Runnable {
    // ...
    public void seeStudent(Student student) throws TABusyException {
        // ...
        new Thread(this).start(); // NOT the same as .run()
    }
    // ...
    @Override
    public void run() {
        // When the above .start() method is called, the *NEW THREAD* will execute this method.
    }
}
</code></pre>
<p>Now, when we run, we'll see:</p>
<pre><code>09:24:18:642 Dispatcher: Hi Charli; you'll be seen by Erica
09:24:18:647 Dispatcher: Hi Boatswain; you'll be seen by Orion
09:24:18:647 Erica says: Hello Charli!
09:24:18:647 Orion says: Hello Boatswain!
Orion says: Goodbye Boatswain, I hope that helped!!
09:24:19:652 Dispatcher: Hi Bucky; you'll be seen by Orion
09:24:19:652 Orion says: Hello Bucky!
Erica says: Goodbye Charli, I hope that helped!!
09:24:19:653 Dispatcher: Hi Nim; you'll be seen by Erica
09:24:19:653 Erica says: Hello Nim!
Orion says: Goodbye Bucky, I hope that helped!!
09:24:20:658 Dispatcher: Hi Alice; you'll be seen by Orion
Erica says: Goodbye Nim, I hope that helped!!
09:24:20:658 Dispatcher: Hi Bob; you'll be seen by Erica
09:24:20:658 Orion says: Hello Alice!
09:24:20:658 Erica says: Hello Bob!
09:24:20:658 Dispatcher (4 helped so far): Nobody waiting in queue, will check again in three seconds.
Orion says: Goodbye Alice, I hope that helped!!
Erica says: Goodbye Bob, I hope that helped!!
09:24:23:662 Dispatcher (6 helped so far): Nobody waiting in queue, will check again in three seconds.

</code></pre>
<p>Much better! </p>
<h3 id="concurrency-vs-parallelism-again"><a class="header" href="#concurrency-vs-parallelism-again">Concurrency vs. Parallelism (Again)</a></h3>
<p>The <code>TA</code> thread and the main thread really are running separately. It's not clear whether they are truly running <em>in parallel</em>, though: the operating system and Java runtime decide that, in part based on how many cores the hardware has available. </p>
<h2 id="what-could-go-wrong"><a class="header" href="#what-could-go-wrong">What Could Go Wrong?</a></h2>
<p>Concurrency seems really powerful. But are there any risks associated with it? Let's investigate. </p>
<p>Suppose we want to record how many students have been seen before the dispatcher terminates. One natural way to do this is by adding a <code>static</code> counter to the dispatcher class:</p>
<pre><code class="language-java">static int studentsSeen = 0;
</code></pre>
<p>Now, every <code>TA</code> can increment this counter in its <code>run</code> method, when the student has been helped:</p>
<pre><code class="language-java">HoursDispatcher.studentsSeen += 1;
</code></pre>
<p>If we tell the dispatcher to print this counter out, we'll see output like this at the end of the queue:</p>
<pre><code>11:56:10 Dispatcher: Nobody waiting in queue, will check again in three seconds. So far we helped 6 students.
</code></pre>
<p>And indeed that's what we see. But let's see how this works <em>at scale</em>. Instead of using these names, we'll create a hundred TAs, and a few thousand students who need to be helped! </p>
<p>So that we can simulate helping so many students without waiting, let's reduce the delay time to help a student: students will be helped instantaneously! We'll also remove the printing in the <code>TA</code> class, since that slows things down. </p>
<p>We might see something like this:</p>
<p><code>12:10:52 Dispatcher: Nobody waiting in queue, will check again in three seconds. So far we helped 299993 students.</code></p>
<p>Uh oh.</p>
<p>What's going on? (By the way, this issue might be less likely to happen if we left the printing in.)</p>
<details>
<summary>Think, then click!</summary>
<p>I've made the classic <em>thread safety</em> mistake. Incrementing that counter isn't <em>atomic</em>: two threads might be trying to edit it at once. Suppose they both fetch the current value at once, add 1 to that value, and then write. If that sequence of operations happens, the counter will only be increased by one.</p>
</details>
</br>
<p>This sort of issue is <em>pervasive</em> in multi-threaded programming. Do the reading---you'll save yourselves a lot of pain.</p>
<h2 id="how-can-we-fix-this"><a class="header" href="#how-can-we-fix-this">How Can We Fix This?</a></h2>
<p>The first approach is old-school synchronization:</p>
<pre><code class="language-java">synchronized (HoursDispatcher.class) {
    HoursDispatcher.studentsSeen += 1;
}
</code></pre>
<p>This will tell Java that only one <code>TA</code> can be running that increment operation at a time. (The argument to <code>synchronized</code> helps disambiguate between multiple dimensions of synchronization we might have happening).</p>
<p>Another approach is to use <em>thread safe objects</em> from Java's standard library. In particular, I could have used an <code>AtomicInteger</code> for the counter:</p>
<pre><code class="language-java">static AtomicInteger studentsSeen = new AtomicInteger(0);
// ... 
HoursDispatcher.studentsSeen.incrementAndGet();
</code></pre>
<p>Both of these approaches fix the problem. The key takeaways are:</p>
<ul>
<li>Having multiple threads of execution lets a program better separate responsibilities into different execution paths that run at the &quot;same time&quot;, logically speaking.</li>
<li>These threads might <em>actually</em> be run at the same time, but, depending on the operating system, they might be run by time-slicing (i.e., taking turns on one core). </li>
<li>Concurrency can cause unusual bugs that don't always happen, or that happen differently across executions. Situations where the ordering of operations results in inconsistent behavior are called <em>race conditions</em>.</li>
</ul>
<h2 id="asynchronous-execution"><a class="header" href="#asynchronous-execution">Asynchronous Execution</a></h2>
<p>Let's get back to TypeScript. TypeScript has <em>really</em> convenient support for concurrency. Try these in the browser console:</p>
<pre><code>console.log('1')
setTimeout(() =&gt; console.log('2'), 5000)
console.log('3')
</code></pre>
<p>But just under that surface, complexity lurks:</p>
<pre><code>console.log('1')
setTimeout(() =&gt; console.log('2'), 5000)
console.log('3')
while(true) {}
</code></pre>
<p>What's happening here? JavaScript—a language built for the web—is a language whose design is <em>deeply and unavoidably</em> tangled with concurrency. </p>
<p>And yet, JavaScript itself (barring <a href="https://developer.mozilla.org/en-US/docs/Web/API/Web_Workers_API/Using_web_workers">some modern extensions</a>, which are best used for expensive tasks that would block important things like UI interactivity) is <strong>only single-threaded</strong>.  We don't create a new thread to wait for a web request to finish. Instead, we create a callback, like we would for a button being clicked. </p>
<p>In principle, callbacks are <em>called</em> as soon as possible. But the definition of &quot;as soon as possible&quot; is complicated. The browser is in charge (or Node is, if you're running a backend server).</p>
<h3 id="the-callback-queue"><a class="header" href="#the-callback-queue">The Callback Queue</a></h3>
<p>Because TypeScript is single threaded, it can't actually invoke a callback while it's running some other piece of code. It has to wait until that code finishes, and then it looks at its <em>callback queue</em> to see if it has callbacks waiting to be processed.</p>
<p>Every time a callback is registered (in the <code>setTimeout</code> example above, the 0-argument function that invokes <code>console.log</code> is a callback) it is added to the queue. Crucially, these calls will only ever take place if they're popped off the queue. And they're only ever removed when the code currently being executed is finished. </p>
<p>This will become extremely important when you start sending web requests from your frontend to your API server. <strong>Callbacks are not threads</strong>. Asynchronous execution is very closely related to concurrency, however. </p>
<div id="admonition-repeating-for-emphasis" class="admonition admonish-warning">
<div class="admonition-title">
<p>Repeating for emphasis</p>
<p><a class="admonition-anchor-link" href="05_threads_promises/05_threads_promises.html#admonition-repeating-for-emphasis"></a></p>
</div>
<div>
<p><strong>Callbacks are not threads.</strong> Neither are promises, <code>async</code> functions, or anything else in the remainder of these notes.</p>
</div>
</div>
<h2 id="code-review-exercise"><a class="header" href="#code-review-exercise">Code Review Exercise</a></h2>
<p>Let's look at some code and anticipate potential errors related to concurrency. (I've removed the types so that we can run this in the browser console.) What's the value that you expect to be printed by each block of code below, after its respective call is uncommented?</p>
<pre><code class="language-javascript">function example0() {
  let toReturn = 0
  setTimeout(() =&gt; {toReturn = 100}, 5000)
  return toReturn
}
//console.log(example0())

function example1(){
    let toReturn = 0
    setTimeout(() =&gt; {toReturn = 500}, 0)
    setTimeout(() =&gt; {toReturn = 100}, 5000)
    return toReturn
}
// console.log(example1())

function example2(){
    setTimeout(() =&gt; {console.log('A')}, 0)
    setTimeout(() =&gt; {console.log('B')}, 5000)
    console.log('C')
    while(0 == 0) {}
    console.log('D')
}
// example2()
</code></pre>
<h3 id="connecting-to-sprint-2"><a class="header" href="#connecting-to-sprint-2">Connecting to Sprint 2</a></h3>
<p>Right now, you're working with file I/O. Because reading from or writing to a file can take time, <em>file I/O is asynchronous in TypeScript</em>. The <code>async</code> and <code>await</code> operators help us deal with asynchronous execution.</p>
<p><strong>In class, we'll look at this informally in my own CSV parser code.</strong></p>
<p>Next time, we'll introduce asynchronous execution in the context of making web requests. </p>
<!-- ### Fetching Data 

In TypeScript, you can use the `fetch` function to send a web request:

```typescript
export function printGridInfo() {    
    const lat: number = 39.7456
    const lon: number = -97.0892
    const url: string = `https://api.weather.gov/points/${lat},${lon}`
    console.log(`Requesting: ${url}`)

    /* 
      Try #1
    */
    const json = fetch(`https://api.weather.gov/points/${lat},${lon}`)
    console.log(json)
```

Thinking about what we just learned about concurrency, and what we know about TypeScript, do you expect `fetch` to be synchronous or asynchronous? That is, will it "block" execution until it finishes?

If it's synchronous, then the page-load process might be delayed noticably. And slowing down page loading to the point a user notices is a cardinal sin on the web: it's "in the folklore" that [a small delay can lead to a drop in revenue](https://news.ycombinator.com/item?id=273900).

But if it's asynchronous (i.e., doesn't block) then what will be printed? Hopefully not `undefined` or `null`&mdash;the data will almost certainly get here _eventually_. So `fetch` returns a datatype whose entire purpose is to represent data that doesn't yet exist: a _promise_.

![](https://i.imgur.com/bvFibPk.png)

A promise can either be _resolved_, in which case the value exists within (but the value is still a promise object, not the data!) or _rejected_, in which case the promise contains an error. Until either of those events occurs, the promise exists in a state of potential only.

**Aside:** Many modern languages have promise libraries, and promises are a common way to manage asynchronous computation (like web requests). This is not just about TypeScript or JavaScript.

But because of how JavaScript/TypeScript works, the promise _cannot be resolved_ until the current code finishes running. That is, the `console.log` statement can't print the right answer until _after the `console.log` executes_, because the right answer won't exist until then. 

But how does `console.log` work, then?"

<details>
<summary>Think, then click!</summary>

Because the _environment_ has multiple threads. This might be the browser, or it might be Node.js. It's only the execution of a JavaScript/TypeScript program that is single threaded. So we can see the update in the console before the currently-running code finishes.

</details>

Clearly, we need something to help make this work. 

### Extracting Promised Data with Callbacks

Promises can be given callback functions to run when they're resolved:

```javascript
// Make a web request...
fetch(url) 
    // ...and when the response arrives, print it to the console
    .then(response => console.log(response)) 
```

The function passed to the `then` call will execute once a real value exists for the response. The `.json()` method returns a promise itself, so we need to provide a callback for that, too, now: 

```javascript
fetch(url)
    .then(response => response.json()) 
    .then(responseObject => {         
           console.log(responseObject)         
    }) 
```

This is called a _chain_ of promises. Once the response is received, we convert it to an object. Once that conversion process is done, we print the result. 

You can find more examples like this in the livecode repository. We'll also talk more about them in the gearup for this upcoming sprint.

### What about types?

`Promise<T>` is a generic type in TypeScript. By default, `fetch` returns a `Promise<any>`---beware, here. The `any` type exists, at least in part, for interoperability with JavaScript, and it disables many checks involving computation "downstream" of the `any` value. 

**See the livecode for more content.** In particular, there's:
* a demo that reinforces how promises _are not threads_;
* a demo of some pitfalls when using async/await, if you choose to do so; 
* a more complete series of attempts to extract Json from a fetched response, including how to make narrowing easy.

We'll cover what we can in today's class session, but please read over the livecode too. I leave comments to try and make the livecode a good supplemental resource.

## What about `async` and `await`? 

TypeScript provides two constructs that can often make working with promises easier: `async` (which tells the system that the function actually returns a _promise_, even if as written it returns a value), and `await` (which tells the system to invisibly inject callbacks as needed to act as though it is waiting for a certain operation to finish). You'll have already seen these used heavily in Playwright testing, because `await` is very convenient to, well _await_ the loading of a webpage. 

The key is remembering that `await` can only be used within an `async` function, and an `async` function always returns a promise. So if I write something like:

```
const f = async (url) => {
    const response = await fetch(url)
    return response;
}
```

then the return type of `f` is actually `Promise<Response>`, not `Response`. You can confirm this via mouseover in VSCode, or by `console.log`.

![A screenshot of VSCode showing the above code, with a mouseover indicating the return type is a promise.](await.png)

As a consequence, if you use `async` and `await`, you end up either:
* putting all the pertinent functionality you care about in `async` functions after `await`s, and thus can totally ignore the return value; or 
* if you need to do something with the final return value outside an `async` context, use `.then()` on the return value&mdash;which, again, will be a promise outside an `async` context.  --><div style="break-before: page; page-break-before: always;"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.min.css" integrity="sha384-AfEj0r4/OFrOo5t7NnNe46zW/tFgW6x/bCJG8FqQCEo3+Aro6EYUG4+cU+KJWu/X" crossorigin="anonymous">
<h1 id="webapps-html-css-and-typescript"><a class="header" href="#webapps-html-css-and-typescript">Webapps: HTML, CSS, and TypeScript</a></h1>
<p>We're going to start learning how to write web applications. In time, you'll have a working front-end web application, which you'll use to query the backend server you're finishing up now. </p>
<p>Please be aware that these notes:</p>
<ul>
<li>cover <strong>multiple class meetings</strong> (and thus may change, as I prepare for class each day); </li>
<li>contain supplemental material which may not be covered in class; and </li>
<li>meant to be accompanied by two examples: the <a href="06_html_react/">Providence Weather</a> app and the <a href="https://github.com/cs0320/class-livecode/tree/main/F25/nyt">NYT puzzle example</a>, which contain many comments for your reference. </li>
</ul>
<p>We're going to <em>start</em> building that final example in these notes, but won't have time to completely finish it. </p>
<h2 id="static-html-and-css-basics"><a class="header" href="#static-html-and-css-basics">Static HTML and CSS Basics</a></h2>
<p>Let's start by looking at a student's website. The site is hosted <a href="https://cs.brown.edu/~tbn/nim/">here</a>. Naturally, I got permission before using one of your fellow student's webpages. The style is rather outdated, but it suffices as a first intro to these concepts.</p>
<p>This website uses three files:</p>
<ul>
<li>an HTML file, which defines the <em>content</em> of the page (<a href="https://cs.brown.edu/~tbn/nim/index.html">index.html</a>);</li>
<li>a CSS File, which defines the <em>styling</em> of the page (<a href="https://cs.brown.edu/~tbn/nim/styles.css">styles.css</a>); and </li>
<li>an image file with a picture of the student (<a href="https://cs.brown.edu/~tbn/nim/nim.png">nim.png</a>).</li>
</ul>
<p>There's no &quot;app&quot; here; the site is static. Put another way, it's just unchanging content for the browser to format and present for us to see.</p>
<h3 id="html-the-content"><a class="header" href="#html-the-content">HTML: The Content</a></h3>
<p>Notice that the structure of HTML is <em>treelike</em>. Tags open and close elements in the document. There's some metadata, but largely the document describes visible content and the structure of that content.</p>
<p>If you're used to editing documents via Google Docs or MS Word, you might be wondering where the <em>formatting</em> information comes from. Websites usually separate out content from styling, meaning that the HTML won't say that a certain word should be shown in a particular font, or aligned in a particular way. Instead, any context needed for styling to be done is specified by...</p>
<h3 id="css-the-styling"><a class="header" href="#css-the-styling">CSS: The Styling</a></h3>
<p>CSS files say how to <em>style</em> elements of a webpage. Because the author of this page gave the <code>uniName</code> class to &quot;Brown University&quot;, this style declaration will apply:</p>
<pre><code class="language-css">.uniName {
    color: brown; 
    font-family: Trebuchet, sans-serif;
    font-size: 18px;
    font-weight: normal; 
}
</code></pre>
<p>The dot before <code>uniName</code> means that the style is meant to apply to any element on the page with <code>uniName</code> as its <em>class</em>. This is called a <em>CSS selector</em>; there are <a href="https://developer.mozilla.org/en-US/docs/Web/CSS/CSS_Selectors">lots more</a> that select elements by their <code>id</code> or other properties. </p>
<p>The result of this separation is that the HTML document can focus on content and context, and leave styling aside. Yes, it's possible to embed your CSS inside the same file, and there are also frameworks that combine the two in a useful way. But the convention we'll follow to start with is to split the two into different files. </p>
<div id="admonition-beware-styling-isnt-easy" class="admonition admonish-warning">
<div class="admonition-title">
<p>Beware: styling isn't easy.</p>
<p><a class="admonition-anchor-link" href="06_html_react/html-react-playwright.html#admonition-beware-styling-isnt-easy"></a></p>
</div>
<div>
<p>You might initially be inclined to dismiss styling as a minor part of a webapp. Don't. You will spend a surprising amount of time on styling before the semester is over. Just because CSS isn't obviously a &quot;programming language&quot; doesn't mean it lacks for complexity. More on this in the near future.</p>
</div>
</div>
<h3 id="viewing-html-source"><a class="header" href="#viewing-html-source">Viewing HTML Source</a></h3>
<p>By default, your browser will render the HTML file, rather than showing its raw form. To see the HTML itself, you'll need to <em>view source</em>. Often there's a right-click menu option for this, but if not there's usually a key combination to press:</p>
<ul>
<li>In Safari: <code>Command + Option + U</code>;</li>
<li>In (Windows) Firefox: <code>Control + U</code>;</li>
<li>In (MacOS) Firefox: <code>Command + U</code>.</li>
</ul>
<h3 id="inspecting-elements"><a class="header" href="#inspecting-elements">Inspecting Elements</a></h3>
<p>CSS files also have significant influence over how elements are positioned on the page. It can be useful to see where boundaries between <code>div</code>s and other elements actually are. This is best done in a browser's page-inspection tool. You'll often find this under &quot;Web Developer Tools&quot; or &quot;Dev Tools&quot; or a similarly named menu. Here are some key combinations:</p>
<ul>
<li>In Safari: <code>Command + Option + I</code> (and click on the <code>Elements</code> tab);</li>
<li>In (Windows) Firefox: <code>Control + Shift + I</code> (and click the <code>Inspector</code> tab);</li>
<li>In (MacOS) Firefox: <code>Command + Option + I</code> (and click on the <code>Inspector</code> tab).</li>
</ul>
<p>Notice that when I mouse over the first column in the table, my browser is highlighting the on-page position of that column:</p>
<p><img src="https://i.imgur.com/TD3UYKg.png" alt="" /></p>
<p>There are better ways of formatting this sort of data than tables. I took this from a webpage written more than a decade ago. However, HTML tables would be a great way to start displaying rows of tabular data on a webpage!</p>
<div id="admonition-sources-isnt-updated" class="admonition admonish-warning">
<div class="admonition-title">
<p>'Sources' isn't updated.</p>
<p><a class="admonition-anchor-link" href="06_html_react/html-react-playwright.html#admonition-sources-isnt-updated"></a></p>
</div>
<div>
<p>Make sure you're looking at <code>Elements</code> or <code>Inspector</code>, not <code>Sources</code>. Once we start working with pages that change dynamically, <code>Sources</code> only shows the starting HTML (the source loaded in the file) without updates that are actually displayed.</p>
</div>
</div>
<h2 id="adding-dynamic-behavior"><a class="header" href="#adding-dynamic-behavior">Adding Dynamic Behavior</a></h2>
<p>Neither HTML nor CSS alone suffice to build a good web application. We need a way to add <em>dynamic behavior</em> to the page, and to do that, we probably want a programming language. JavaScript is the most popular, and what most browsers optimize for. Fortunately, we've been using TypeScript already! We'll keep using it for web programming.</p>
<p>We could proceed to build a dynamic website with just TypeScript. But there are some annoying patterns that come up there; instead, we'll be using the <strong>React</strong> framework this semester. React is a web framework for JavaScript and TypeScript. We'll use it to make web development a bit easier. You will find the <a href="https://beta.reactjs.org/">React docs</a> useful. This is especially true for <em>hooks</em> which are how you manage state in React.</p>
<h2 id="a-website-i-liked"><a class="header" href="#a-website-i-liked">A Website I Liked</a></h2>
<p>The New York Times website had a <a href="https://www.nytimes.com/interactive/2015/07/03/upshot/a-quick-puzzle-to-test-your-problem-solving.html">puzzle</a> a few years back that I love to use in class. It went something like this:</p>
<p><img src="https://i.imgur.com/EOIDbbx.png" alt="" /></p>
<h3 id="the-problem"><a class="header" href="#the-problem">The Problem</a></h3>
<p>The page is paywalled. Although Brown provides access through your logins, it's kind of a pain to set up under time constraints. So, while you should definitely try the NYT's version if you can, <em>let's build our own</em>. In fact, <a href="https://tnelson.github.io/reactNYT/">I've already built one!</a> </p>
<p>This is an example of a webapp with both a <em>front end</em> and a <em>back end</em>. The front-end piece is what you see on the webpage, and all the dynamic functionality is there. The backend (in this app, anyway) is just a database where I keep track of everyone's sequences, and the results the app gave you. </p>
<p>Let's try it out. I didn't implement the &quot;I'm ready to guess&quot; part yet, but once you have a guess, <strong>write it down</strong> and stop.</p>
<details>
<summary>Think, then click!</summary>
The rule is "any non-decreasing sequence of three numbers." Is that your guess?
<p>Perhaps not! The NYT reports that the majority of people who've tried the puzzle made their first guess before ever receiving a <em>false</em> response. </p>
<p>What does that have to do with software engineering? This is an example of <em>confirmation bias</em>; we humans tend to favor examples that <em>meet</em> our expectations. But without first seeing some <code>false</code> results, how would you really build confidence in your guess? (Maybe <em>any</em> sequence worked!) </p>
<p>By the way, this shows an example of how cognitive bias can impact our testing. It's quite easy to see a lot of <code>true</code> responses and get complacent...</p>
</details>
<h2 id="building-an-app-the-hard-way"><a class="header" href="#building-an-app-the-hard-way">Building an App the Hard Way</a></h2>
<p>Before showing you React, I want to give you an example of how things work without a web framework to help out. And I want to showcase Copilot here and my process when I'm using it for this kind of prototyping. We're likely to run into some snags, and you'll see me resolve them. </p>
<p>Because this will be done live, I can't predict what will happen ahead of time. Still, remind yourselves of these three bits of advice from the AI gearup:</p>
<ul>
<li>Specify the end goal.</li>
<li>Specify he language/infrastructure.</li>
<li>Specify the output/input format.</li>
</ul>
<p>In this case, I want to build an example web application in TypeScript, without any frameworks. The application should have state in it: a counter on the page that the user clicks a button to increment. There's no real input/output format in this situation. We'll also want to prompt Copilot to ask us questions along the way.</p>
<p><strong>See the lecture capture for specifics on this exercise.</strong></p>
<h2 id="using-react"><a class="header" href="#using-react">Using React</a></h2>
<p>Let's try to do the same thing, but with React. I'll create a new folder and new conversation. Because there are a few different ways to <em>run</em> a React program, I'll specify Vite because that's what we use this semester. </p>
<p>Again, I'll stop and point out issues as Copilot helps us prototype, but I can't predict what will happen ahead of time. </p>
<p><strong>See the lecture capture for specifics on this exercise.</strong></p>
<h2 id="building-something-bigger"><a class="header" href="#building-something-bigger">Building Something Bigger</a></h2>
<p>I've put a draft of the puzzle in the live code repository <a href="https://github.com/cs0320/class-livecode/tree/main/F25/reactNYT">here</a>. </p>
<p>You can find the HTML <a href="https://github.com/cs0320/class-livecode/blob/main/F25/reactNYT/public/index.html">here</a>. There are a couple of new tags in the HTML, but they're just more semantic grouping tags, like <code>section</code> etc. We'll focus on the code today.</p>
<p>One thing is worth noting: the CSS has only two declarations. These correspond to the formatting cues assigned to correct and incorrect sequences in the history:</p>
<pre><code class="language-css">.correct-try {
    background-color: green;
}
.incorrect-try {
    background-color: red;
}
</code></pre>
<p>We could make the page a lot better-looking by doing more with CSS styling. But this is meant to be an example focused on the dynamic behavior only, so we'll move on from there.</p>
<h2 id="react-and-reactivity"><a class="header" href="#react-and-reactivity">React and Reactivity</a></h2>
<h3 id="most-languages"><a class="header" href="#most-languages">Most Languages</a></h3>
<p>Consider what happens when I assign a value in JavaScript (or Java, or C, or most programming languages):</p>
<pre><code class="language-javascript">x = 10;
y = x + 1;
</code></pre>
<p>At this point, <code>x</code> contains the value <code>10</code> and <code>y</code> contains the value <code>11</code>. But suppose I then update the value of <code>x</code> to <code>50</code>:</p>
<pre><code class="language-javascript">x = 50;
</code></pre>
<p><em>What happens to the value of <code>y</code></em>? </p>
<p>In most languages, it remains set to <code>11</code>. That <code>x + 1</code> is only computed once, at the time the line executes. And, at that time, the value of <code>x</code> was 10. So what if it's now <code>50</code>? It was <code>10</code> when the assignment to <code>y</code> happened.</p>
<h3 id="another-philosophy"><a class="header" href="#another-philosophy">Another philosophy</a></h3>
<p>Let's set up something similar in Google Sheets:</p>
<p><img src="https://i.imgur.com/Uc6DO5N.png" alt="" /></p>
<p>The cell <code>A1</code> is set to 10, and the cell <code>B1</code> has been assigned <code>A1+1</code>. Like before <code>B1</code> has the value <code>11</code>.</p>
<p>But in this setting, if I go and change <code>A1</code> to <code>50</code>, the value of <code>B1</code> automatically updates to <code>51</code>:</p>
<p><img src="https://i.imgur.com/aaMMjcf.png" alt="" /></p>
<p>Languages where assignment works like it does in Google Sheets are called <em>reactive</em>, because values change <em>in reaction to</em> changes in their dependencies. </p>
<p>At this point, you may have two questions:</p>
<p><em>Q: Is reactivity fundamental to the language, or can you build reactivity atop normal assignment?</em> 
A: You can, with effort, implement reactivity in languages where it's not the default behavior. </p>
<p><em>Q: Where is reactivity natural, outside of a spreadsheet program?</em> 
A: Reactivity makes sense in more domains than you might think.</p>
<h3 id="using-reactivity"><a class="header" href="#using-reactivity">Using Reactivity</a></h3>
<p>Here are a few examples.</p>
<ul>
<li>Signal propagation in electrical engineering</li>
<li>Updating a database view in real time</li>
<li>Monitoring a system (either in production or for debugging)</li>
<li><em>Physical</em> interfaces like a steering wheel or thermostat</li>
</ul>
<h4 id="one-more-example"><a class="header" href="#one-more-example">One More Example</a></h4>
<p>In a networked chess application, the state of the board on screen should automatically reflect the programmatic board state as it changes based on moves made. This is very straightforward to implement in React, because the program only needs to update the board's data structure and then React handles re-drawing the screen.</p>
<h3 id="how-do-we-get-reactivity"><a class="header" href="#how-do-we-get-reactivity">How do we get reactivity?</a></h3>
<p>All of the above are something we could, in principle, build ourselves in vanilla JavaScript (or some other language). Unfortunately, as the application grows in complexity, this becomes tougher to do, and there are efficiency challenges.</p>
<p>For example, if we wanted to use reactivity in our web frontend applications, it would be good to avoid updating the <em>entire webpage</em> every time a small value changed. We'd like to update only the places in the DOM that <em>really need</em> updating. Making updates accurate and efficient is hard work. React gives us (an approximation of) reactivity for free. I say &quot;approximation&quot; because TypeScript's single-threaded model means that state updates have to be <em>queued</em>, they are not seen immediately.</p>
<h2 id="what-does-react-do"><a class="header" href="#what-does-react-do">What does React Do?</a></h2>
<p>React provides two useful features (among others):</p>
<ul>
<li>React manages your front-end app's state centrally, and when it detects a state change it propagates that change to a <em>virtual copy</em> of the page. The actual page then only gets updated when it actually needs to be changed. This can improve efficiency of complex apps. To make this work, <strong>you usually want to manage all state through React</strong>.</li>
<li>React gives us a nice way to align the <em>visual layout</em> of the app with the program. Concretely, <strong>a React component is a TypeScript function</strong> that returns a special kind of object that resembles HTML: a <strong>JSX</strong> expression. In effect, JSX is HTML <strong>with holes in it</strong> where we can plug in the result of running TypeScript code. </li>
</ul>
<p>Together, these features mean that we can let React manage updating the DOM; we just need to update the state that React can see.</p>
<div id="admonition-jsx" class="admonition admonish-tip">
<div class="admonition-title">
<p>JSX</p>
<p><a class="admonition-anchor-link" href="06_html_react/html-react-playwright.html#admonition-jsx"></a></p>
</div>
<div>
<p>Always keep in mind that <strong>a React function component must return a JSX expression</strong>. This might be plain HTML, but almost always it's got some JavaScript being evaluated inside squiggle-braces.</p>
</div>
</div>
<p>We're also using Vite, a development server for React applications. This makes it easier to get started. Notice that we're using a lot of helper libraries! This is normal in much of web development, and we want to get more practice managing this.</p>
<div id="admonition-components" class="admonition admonish-tip">
<div class="admonition-title">
<p>Components</p>
<p><a class="admonition-anchor-link" href="06_html_react/html-react-playwright.html#admonition-components"></a></p>
</div>
<div>
<p>React components will either be classes or functions.  We don't use &quot;class components&quot;. They are outdated, from the early days of React. You'll still see them referenced online, though. The React team strongly suggests that new development use functional components instead, though. We follow their advice, and so should you. <strong>Use function components.</strong></p>
</div>
</div>
<h3 id="what-are-our-components-for-this-application"><a class="header" href="#what-are-our-components-for-this-application">What are our components for this application?</a></h3>
<p>After you ignore all of the extraneous content, the NYT puzzle is pretty simple: </p>
<ul>
<li>3 input boxes invite you to enter a trio of numbers. </li>
<li>Once you've entered numbers, you click a button to check whether those numbers are in the hidden set of sequences. </li>
<li>The 3 input boxes become read-only and get colored red or green depending on success or failure.</li>
<li>A new trio of inputs appears.</li>
</ul>
<p>So, for our graphical components, we probably need:</p>
<ul>
<li>input boxes and a submission button; and</li>
<li>a notion of &quot;attempt&quot;: one current attempt, and 0 or more past attempts.</li>
</ul>
<p>That's enough to get a very rough approximation of the puzzle, which is good enough for me!</p>
<p>I like to draw out a prototype UI, and circle different regions that represent important grouping in the application. E.g.:</p>
<p><img src="https://i.imgur.com/3cIg553.png" alt="" /></p>
<h4 id="jsx"><a class="header" href="#jsx">JSX</a></h4>
<p>React component functions return <strong>JSX</strong>, rather than standard TypeScript, which is why the file extension is now <code>.tsx</code> rather than <code>.ts</code>. React automatically renders whatever these functions return into HTML.</p>
<p>All these components except <code>App</code> take <em>properties</em>. This is either a single argument, <code>props</code>, that represents information passed down from parent components, or a collection of variables that do the same.</p>
<h3 id="running"><a class="header" href="#running">Running</a></h3>
<p>From the console, I'll run <code>npm run start</code>. Because I'm using React with Vite, it will give me output like this:</p>
<pre><code>  VITE v4.4.9  ready in 1240 ms

  ➜  Local:   http://localhost:5173/
  ➜  Network: use --host to expose
  ➜  press h to show help
</code></pre>
<p>If I then go to <code>http://localhost:5173/reactNYT</code>, I can view the app. (By default, it would be served at <code>localhost:3000</code>, but I've configured it to add <code>reactNYT</code> so that I could deploy it where I did, rather than the root of my Github pages page. We won't be doing deployment today.)</p>
<h3 id="revisiting-configuration"><a class="header" href="#revisiting-configuration">Revisiting Configuration</a></h3>
<p>Because different projects may have different configurations (and Copilot may sometimes produce configurations that are slightly wrong...) I want to revisit this. </p>
<p>We've got a file called <code>package.json</code> and another called <code>tsconfig.json</code>. We've seen these before, but as a reminder they control (respectively):</p>
<ul>
<li>the project's metadata and dependencies; and </li>
<li>how TypeScript should compile (e.g., which version of JavaScript it should emit, whether it should interoperate with raw JavaScript, etc.).</li>
</ul>
<p>There's also a very large file, <code>package-lock.json</code>. This gives the low-level details of how dependencies were resolved, even implicit ones, and helps ensure a consistent build. <em>All three of these should be pushed to Github</em>.</p>
<p>On the other hand, <code>node_modules</code> is where the dependencies have been downloaded. These are often large, and <em>should not be pushed to Github</em>.</p>
<p>You may notice some other configuration:</p>
<ul>
<li><code>vite.config.js</code> configures Vite.</li>
<li><code>jest.config.js</code> configures Jest.</li>
</ul>
<p>That's a lot of moving parts! Front-end development tends to have more pieces, but just keep in mind: </p>
<ul>
<li>Browsers understand JavaScript;</li>
<li>TypeScript adds types, and gets compiled to JavaScript;</li>
<li>React is a framework that makes building applications easier; and</li>
<li>Vite is a development server meant to make building React apps easier.</li>
</ul>
<h3 id="application-state"><a class="header" href="#application-state">Application state</a></h3>
<p>The <code>App</code> component is the entry point into a <code>create-react-app</code> program. Let's start by adding a <code>NewRound</code> component:</p>
<pre><code class="language-javascript">function App() {
  return (
    &lt;div&gt;
      &lt;NewRound/&gt;      
    &lt;/div&gt;
  );
}
</code></pre>
<p>This changes nothing, but it raises the question: how do we get the <code>NewRound</code> component to do what we want? Our application has some state. What does the state look like? </p>
<p>We'll need at least:</p>
<ul>
<li>the state of each text input;</li>
<li>some record of past guesses; and (if we want to get fancy)</li>
<li>maybe some text state for showing error messages and so on.</li>
</ul>
<p>Let's focus on the record of past guesses. What's the right component for that record to be kept in? If we keep the record in one big array, it's the <code>App</code> component. We don't just want to add a global variable for this, though; we want to enable React to register our updates so it can efficiently flow those updates into the UI. For this, we'll use a hook (see this week's lab for more information), and we'll pass both the value and the setter function to the <code>NewRound</code> component. We'll also tell the <code>NewRound</code> component about how to update the notification text</p>
<pre><code class="language-javascript">function App() {
  const [guesses, setGuesses] = useState([]);
  const [notification, setNotification] = useState('');
  return (
    &lt;div&gt;
      &lt;NewRound setGuesses={setGuesses}
                setNotification={setNotification} /&gt;      
      {notification}
    &lt;/div&gt;
  );
}
</code></pre>
<p>The squiggly braces contain JavaScript; the result of evaluating that JavaScript gets substituted into the JSX. As a result, the <code>NewRound</code> component will have access to the setter for <code>guesses</code>, and thus have the ability to <em>update</em> the record.</p>
<p>Having referred to a <em>NewRound</em> component, we probably ought to do something in the corresponding function (which is, at the moment, empty except for a <code>&lt;div&gt;</code>). We've got to do a few things:</p>
<ul>
<li>We need a place for the state of those 3 text inputs to go. We'll use another <code>useState</code> hook for this.</li>
<li>We need a place for the inputs to go, and the guess button.</li>
<li>We need to <em>take in</em> some props---at minimum, a way to change the notification message.</li>
</ul>
<p>See the completed livecode for details. Much of class will be a code-dive exercise with an opportunity to ask questions. Pay special attention to...</p>
<ul>
<li>...how state is declared, updated, and accessed. Never modify a state variable directly; always use the setter provided by React, and don't expect the setter to execute right away.</li>
<li>...how the components refer to each other, forming a nested structure. The structure of the program echoes the graphical structure. If you're ever feeling &quot;lost&quot; in React, draw the picture of how the components should relate to each other. </li>
</ul>
<div id="admonition-react-state-updates-are-asynchronous" class="admonition admonish-warning">
<div class="admonition-title">
<p>React state updates are asynchronous!</p>
<p><a class="admonition-anchor-link" href="06_html_react/html-react-playwright.html#admonition-react-state-updates-are-asynchronous"></a></p>
</div>
<div>
<p>Try adding a <code>console</code> write immediately after a state update (here's a snippet modified from the full code below):</p>
<pre><code class="language-javascript=function ControlledInput(props) {">  return (
    &lt;input value={props.value} onChange={(ev) =&gt; {
      props.setValue(ev.target.value);
      console.log(props.value);
   }
  }&gt;&lt;/input&gt;);
}
</code></pre>
<p>The <code>console.log</code> will print the old value, because React hasn't yet had a chance to run the update. In general, don't expect React state updates to take effect until after the currently running code has ended. (We'll talk more about this in preparation for your <em>next</em> sprint.)</p>
</div>
</div>
<h2 id="testing-in-react"><a class="header" href="#testing-in-react">Testing in React</a></h2>
<p>We'll be using and requiring <em>Playwright</em> for Mock and future sprints. You're strongly encouraged to use it on your term projects as well, since that's what we can best support. Playwright is a great library for scripting front-end tests. There's a <a href="https://testing-library.com/docs/guiding-principles/">guiding principle</a> (quoted from a different testing library) that we'll follow for front-end testing:</p>
<blockquote>
<p>The more your tests resemble the way your software is used, the more confidence they can give you.</p>
</blockquote>
<p>Broadly, we're going to focus on a more heavy-weight kind of testing on the front end that resembles the integration tests you wrote for Server. We'll call this <em>end-to-end</em> testing, because it can potentially test the entire application. You might think of it as a kind of user-focused system testing.</p>
<h3 id="contrasting-vs-unit-testing"><a class="header" href="#contrasting-vs-unit-testing">Contrasting vs. Unit Testing</a></h3>
<p>Unit testing still has a (major) place in our testing lives. It's still useful to test narrow units of code. But <em>why</em> do we unit test? It isn't because of some crude rule like &quot;we should test every line!&quot; but rather because it's important to have confidence about <em>interface boundaries</em> in your application. These boundaries exist at many different levels:</p>
<ul>
<li>individual public helper functions used throughout an application that developers (often you) invoke elsewhere, relying on their specific behavior when doing so;</li>
<li>the behavior of frontend-backend communication (like your API server in Sprint 2) and other connections between large components that developers (often <em>not</em> you) rely on; </li>
<li>the behavior of actual <em>user</em> interface(s) that end users rely on; </li>
<li>...</li>
</ul>
<p>It's <em>always</em> about the behavior! </p>
<p>My view is that testing should always be rooted in the requirements that specific kinds of users have---whether they're developers or end-users. Hence the way we've framed the user stories in your sprints to reflect the needs of both.</p>
<p>Kent Dodds writes more about this philosophy in the context of a <em>different testing library</em> <a href="https://kentcdodds.com/blog/testing-implementation-details">here</a>. If you read the post, you'll see that he also frames testing in terms of both developers and end-users. Dodds also writes that if a test suite is brittle to low-level changes, it is a timesink to maintain. </p>
<p>If that doesn't seem counter-intuitive, give it more thought. Tests <em>specify behavior</em> at whatever level they operate. And isn't it a good thing whenever we know what our software should do? If so, it must also be a good thing for our software to be <em>completely specified</em>; you'd know exactly what the software does (or, even better, exactly what you should be implementing). <strong>No room for ambiguity, no chance of missing any rubric points or making any users unhappy.</strong></p>
<p>That's good, right? ...Right? </p>
<p>Maybe. But there's a price to pay in managing that specification and the effects of change. The more completely the tests specify your application, the less you'll be able to change without breaking tests.</p>
<!-- (Since tests really do specify what correct behavior is, we'll use "specification" and "testing" interchangeably in this specific chapter of notes.) -->
<h2 id="technical-asides"><a class="header" href="#technical-asides">Technical Asides</a></h2>
<h3 id="reminder-promises"><a class="header" href="#reminder-promises">Reminder: Promises</a></h3>
<p>In TypeScript, a <code>Promise</code> is a generic type that represents an <em>eventual</em> value (or error). The <code>await</code> and <code>async</code> keywords are syntactic sugar over promises (meaning that they both compile into promise operations). </p>
<ul>
<li>The <code>await</code> operator appears to &quot;pause&quot; until an operation is complete. In reality, <code>await</code> adds a callback function containing the rest of the code, and tells TypeScript to call that function when the promise resolves. </li>
<li>The <code>async</code> operator warns TypeScript that the function returns a <code>Promise&lt;T&gt;</code>, but that the function's syntax is phrased as if it returns a real <code>T</code> value. </li>
</ul>
<p>For example, this line:</p>
<pre><code class="language-javascript">const res: Response = await fetch(`https://api.weather.gov/points/${lat},${lon}`)
if(!res.ok) {
  setError('Error getting data from NWS.')
  return
}
</code></pre>
<p>really means:</p>
<pre><code class="language-javascript">fetch(`https://api.weather.gov/points/${lat},${lon}`)
  .then( res =&gt; if(!res.ok) {setError('Error getting data from NWS.'); return} )
</code></pre>
<p>You can usually use <code>await</code> and <code>async</code> without thinking too much about promises, but bugs can happen because of misusing them. This is especially bad when paired with the <code>any</code> type, because then TypeScript won't complain if you forget whether something is a promise or not. </p>
<p>For more information, see these <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Promise">docs on <code>Promise</code>s</a> and these <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Statements/async_function">docs on <code>async</code> and <code>await</code></a>. </p>
<h3 id="why-arent-you-adding-types-in-your-test-files"><a class="header" href="#why-arent-you-adding-types-in-your-test-files">Why aren't you adding types in your test files?</a></h3>
<p>While you must fill in types in your application files, we're <strong>not</strong> requiring you to fill in explicit type values within your test files. These files <em>are</em> TypeScript; we're just letting TypeScript infer types on its own. </p>
<h3 id="blank-space-and-semicolons-in-javascripttypescript"><a class="header" href="#blank-space-and-semicolons-in-javascripttypescript">Blank Space and Semicolons in JavaScript/TypeScript</a></h3>
<p>I'm including this because it is a strange thing about TypeScript/JavaScript and it's caused confusion before. Let's ask: how does JavaScript handle blank space? How about the ultimate blank space: new lines?</p>
<pre><code class="language-javascript">five = function() { return 
5; }
</code></pre>
<p>JavaScript automatically inserts semicolons where it believes they are needed. It turns out this often makes sense, but can be confusing. I found <a href="https://stackoverflow.com/questions/2846283/what-are-the-rules-for-javascripts-automatic-semicolon-insertion-asi">this great StackOverflow thread</a> that explains the policy in detail.</p>
<p>The language is powerful, and many of its quirks actually make perfect sense when writing web UIs. But still, beware, and treat your JavaScript programs like a science project: if you've got weird behavior, <em>experiment</em>. </p>
<div id="admonition-strict-mode" class="admonition admonish-note">
<div class="admonition-title">
<p>Strict Mode</p>
<p><a class="admonition-anchor-link" href="06_html_react/html-react-playwright.html#admonition-strict-mode"></a></p>
</div>
<div>
<p>If you absolutely must work in plain JavaScript (do not do this in 0320, you must use TypeScript), I suggest enabling <em>strict mode</em>. You'll get fewer silent failures (and more runtime errors). It won't give you protections before runtime like TypeScript does, and it won't protect you from as many problems. But it's better than nothing.</p>
</div>
</div>
<h2 id="using-playwright-to-test-components-for-sprint-6-not-sprint-5"><a class="header" href="#using-playwright-to-test-components-for-sprint-6-not-sprint-5">Using Playwright to Test Components (for Sprint 6, not Sprint 5)</a></h2>
<p>You can find some example uses of Playwright in the <code>reactNYT</code> livecode repository. In particular, look at the <a href="https://github.com/cs0320/class-livecode/blob/main/F23/reactNYT/tests/app.spec.ts"><code>app.spec.tsx</code> file</a>. Here's an example:</p>
<pre><code class="language-typescript">test('renders guess input fields', async ({ page }) =&gt; {
  await page.goto(url);    
  // Leverage accessibility tags we ought to be providing anyway  
  const guess0 = await page.getByRole(&quot;textbox&quot;, {name: TEXT_number_1_accessible_name})
  const guess1 = await page.getByRole(&quot;textbox&quot;, {name: TEXT_number_2_accessible_name})
  const guess2 = await page.getByRole(&quot;textbox&quot;, {name: TEXT_number_3_accessible_name})
  await expect(guess0).toBeVisible()
  await expect(guess1).toBeVisible()
  await expect(guess2).toBeVisible()
});
</code></pre>
<p>First, the test calls <code>page.goto</code> to load the page. This works because of <a href="https://github.com/cs0320/class-livecode/blob/main/F23/reactNYT/playwright.config.ts">how Playwright is configured</a> in the project: when run, Playwright will automatically start up the development server for the project. </p>
<p>Then, the test creates <em>locators</em> for textbox elements with specific labels (in this case, accessibility metadata). Rather than hard-coding the specific string, the module imports an identifier from the app itself in the <code>constants.ts</code> file:</p>
<pre><code class="language-typescript">export const TEXT_number_1_accessible_name = 'first number in sequence'
</code></pre>
<p>The advantage of this approach is that, assuming that the application also uses <code>TEXT_number_1_accessible_name</code> for the accessible label of the input boxes, simple changes to their text <em>won't break our tests</em>. </p>
<p>Notice how we're identifying the three &quot;guess&quot; input boxes based on their <em>accessible role</em> and <em>accessible name</em>. This is less brittle than just getting all elements with that role; we don't need to filter out old-round information, or worry about ordering. Instead, <code>NewRound.tsx</code> sets up the <code>NewRound</code> component so that these text boxes all have distinct accessible names. </p>
<p>You'll see this a lot in modern front-end testing. Rather than requesting elements from <code>document</code> or some other HTML node, we'll use library support for accessibility metadata. Using Playwright it's easy to enter values into the input boxes:</p>
<pre><code class="language-typescript">await guess0.fill('100');    
await guess1.fill('200');    
await guess2.fill('300');
</code></pre>
<p>and even script clicking the button, after we find it by its accessibility data:</p>
<pre><code class="language-typescript">await submitButton.click();
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.min.css" integrity="sha384-AfEj0r4/OFrOo5t7NnNe46zW/tFgW6x/bCJG8FqQCEo3+Aro6EYUG4+cU+KJWu/X" crossorigin="anonymous">
<h1 id="thinking-about-algorithms"><a class="header" href="#thinking-about-algorithms">Thinking About Algorithms</a></h1>
<p>These notes combine multiple sources from prior semesters. Broadly, they discuss:</p>
<ul>
<li>data representations vs. interfaces; </li>
<li>kd-trees; </li>
<li>comparators (from the perspective of the kd-tree class as a consumer); </li>
<li>bloom filters; and </li>
<li>A* search.</li>
</ul>
<p>We probably won't be able to talk about everything here in class! For Fall 2025, you'll want to pay special attention to the section on A* search.</p>
<h2 id="thinking-about-data-representations"><a class="header" href="#thinking-about-data-representations">Thinking About Data Representations</a></h2>
<p>There's an adage you may have heard before: &quot;the query influences the structure&quot;. This means that your choice of data structure shouldn't just be about the shape of the data you get, it should also be affected what you plan to <em>do</em> with the data. </p>
<p>This may seem obvious, but it's harder than it sounds. It's helpful to make a very careful distinction between the <em>representation</em> of data and the <em>interface</em> it provides. Blurring this distinction leads to pain later in the development cycle. Here's an example. </p>
<p><strong>QUESTION:</strong> What's a list?</p>
<details>
<summary><B>Think, then click!</B></summary>
<p>It depends. </p>
<p>Do you mean the set of <em>operations</em> one usually expects a list to be able to perform? Adding, removing, index-based accesses, etc.? If so, a list is an object providing that interface to a caller. </p>
<p>Or do you mean a particular data structure? A <em>linked</em> list? Maybe a <em>doubly linked</em> list? A (dynamic) <em>array</em> list? All of these can conform to the <code>List</code> interface, although some of them have to do more work than others for certain operations.</p>
<p>Don't conflate these two meanings. One is about the functionality you must provide; the other is about how you concretely choose to represent your data. </p>
</details>
<br/>
<div id="admonition-think-like-an-engineer" class="admonition admonish-tip">
<div class="admonition-title">
<p>Think Like an Engineer</p>
<p><a class="admonition-anchor-link" href="algorithms/algorithms.html#admonition-think-like-an-engineer"></a></p>
</div>
<div>
<p>Keep this in mind when you're splitting up work: decide together on the operations (interface) each component needs from the others early, and keep other criteria broad (&quot;I need you to give me the <code>find</code> operation&quot;, and then eventually &quot;I need worst-case <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal" style="margin-right:0.02778em;">O</span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.01968em;">l</span><span class="mord mathnormal">o</span><span class="mord mathnormal" style="margin-right:0.03588em;">g</span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.10903em;">N</span><span class="mclose">))</span></span></span></span> runtime for the find operation&quot;; don't skip right to  &quot;I need you to use a Java <code>TreeList</code>&quot;).</p>
</div>
</div>
<p>Just like we can provide the <code>List</code> interface via many different data structures, we can provide algorithmic content like &quot;find the nearest neighbor of an element&quot; in many different ways. Let's look at one you may not have seen before.</p>
<h2 id="thinking-about-algorithms-the-mailbox-problem-kd-trees"><a class="header" href="#thinking-about-algorithms-the-mailbox-problem-kd-trees">Thinking About Algorithms: The Mailbox Problem (KD-trees)</a></h2>
<p>In the <em>one-dimensional mailbox problem</em>, you've got a world consisting of buildings positioned on a very long street. Every building has a numeric location on the street; we'll assume it's always an integer. </p>
<p>If I told you that I wanted to give you the addresses of all houses on the street, and you needed to let me check to see whether there was a house at any address, you'd be quite justified in reaching first for the <code>Set</code> interface. You might even go for <code>Map</code>, anticipating I might later want to add more to the data for each house. These tend to be backed by efficient hash-table data structures. </p>
<p>But now there's a twist. I don't just want to check membership (or get data about a specific house). Instead, I've got to route the mail.</p>
<p>Why is this hard? Because I'm doing the routing at a very high level: I'm working for a gigantic or district post office! We can't hand-deliver every piece of mail ourselves. So I need to send letters to the right small, local post office for hand-delivery. </p>
<p><img src="https://hackmd.io/_uploads/SyUQYG9mY.png" alt="" /></p>
<p>In short, I need to find the <em>nearest neighbor</em> to the target house, from among a set of post office addresses. </p>
<p>You could solve this using a list (or set, or any collection) to store the data points, and a <code>for</code> loop to iterate through them, seeking the nearest neighbor. The trouble is that a linear-time search won't scale as the dataset grows. Our first go-to data structure, the hash table, won't work for nearest-neighbor---hashing will lose information about locality and closeness that are so vital to solving this problem! </p>
<div id="admonition-think-like-an-engineer-1" class="admonition admonish-tip">
<div class="admonition-title">
<p>Think Like an Engineer</p>
<p><a class="admonition-anchor-link" href="algorithms/algorithms.html#admonition-think-like-an-engineer-1"></a></p>
</div>
<div>
<p>Agree on what you need from the interface, and then figure out what the right implementation is afterward. It's OK to start with something inefficient, and it might even let you explore the problem enough that your second implementation is better than it would have been otherwise.</p>
</div>
</div>
<p>What would you use instead, if you wanted better performance? </p>
<details>
<summary><B>Think, then click!</B></summary>
<p>This is one of several reasons why we still teach you binary search trees (BSTs). BSTs are absolutely perfect for this problem. Not only are they aware of relative positions (and have to be) but it turns out that the ordinary recursive descent you might perform to search for membership also suffices to find a nearest neighbor: you're guaranteed to always find the nearest neighbor somewhere on the descent!</p>
</details>
<br/>
<p>Suppose we store a set of post offices in the following (balanced!) BST:</p>
<p><img src="https://hackmd.io/_uploads/HJztFzcmY.png" alt="" /></p>
<p>If we're seeking a nearest-neighbor to <code>17</code>, I claim that it always works to do a search in the tree for <code>17</code>. If <code>17</code> is found, it is its own nearest neighbor. If <code>17</code> isn't found, then its nearest neighbor must be on the path taken during the search. </p>
<p><img src="https://hackmd.io/_uploads/HJam9zq7K.png" alt="" /></p>
<p>And <code>20</code> is the nearest neighbor to <code>17</code>. It won't always be the last node visited, but it must be on the path. </p>
<p>Why does this work?</p>
<details>
<summary><B>Think, then click!</B></summary>
<p>Because every time we move down the tree, we move in the direction of the goal. It would be impossible to visit a node <code>X</code>, where <code>X &lt; goal</code>, and move right when we should have moved left. We get this from one of the BST invariants: <em>every node is less than (or equal to) all its right descendants</em>. </p>
</details>
<br/>
<h3 id="moving-beyond-1-dimension"><a class="header" href="#moving-beyond-1-dimension">Moving beyond 1 dimension</a></h3>
<p>This seems pretty useful, and 1 dimension can be enough for data organized by (say) price or time, where &quot;nearest&quot; still makes sense. But often you really do need more than one dimension. How might we extend a BST for multiple dimensions?</p>
<p>It turns out that there are a few answers. There are solutions, like quad-trees and oct-trees, where nodes have a large number of children. These are often used in (e.g.) video game engines. </p>
<p>Today we're going to explore an alternative solution that retains the binary-tree foundation, but still handles membership and nearest-neighbor queries on multiple dimensions: <em>k-d trees</em>.</p>
<p>(I'm going to completely sidestep the question of balance; it's vital for performance but today we'll be talking about functionality.)</p>
<p>K-d trees have nodes corresponding to k-dimensional points. So, in a tree with two dimensions, we might have points like <code>(0,5)</code> or <code>(6,2)</code>. Here's an example of what I mean:</p>
<p><img src="https://hackmd.io/_uploads/rJZ6nGc7F.png" alt="" /></p>
<p>OK, sure: this is a binary tree with 2-dimensional node labels. But what makes it <em>usable</em> in ways other binary trees aren't? A better way to phrase that question is to ask: <em>what are the invariants of a k-d tree</em>?</p>
<p>The key is that every rank in a k-d tree is focused on a single dimension: starting at index <code>0</code>, then moving on to index <code>1</code> and so on, and rotating back to <code>0</code>. Given that added structure, we can say that for every node <code>P</code> at rank <code>X</code>:</p>
<ul>
<li>all left-descendants of <code>P</code> have an <code>X</code> coordinate less than <code>P.X</code>; and</li>
<li>all right-descendants of <code>P</code> have an <code>X</code> coordinate greater than or equal to <code>P.X</code>.</li>
</ul>
<p>(I'm making an arbitrary design choice and saying that same-value entries go to the right. Notice that this design choice is more important here than in a BST: there, you can avoid the question by excluding duplicates; here, you'd have to exclude any point from sharing a single dimension from another.)</p>
<p>Here's the tree, annotated more helpfully. (Check that it satisfies the invariants!)</p>
<p><img src="https://hackmd.io/_uploads/SkCYRG9mY.png" alt="" /></p>
<p>Now how do we actually <em>use</em> these invariants? Since every rank has a single dimension of interest, we might start by doing a normal recursive descent, like we would on a BST, but ignoring dimensions that the current node has no interest in. </p>
<p>Let's try it! We'll search for the nearest neighbor of <code>(5,5)</code> in this kd-tree. </p>
<p><img src="https://hackmd.io/_uploads/ByVP1mqXt.png" alt="" /></p>
<p>This looks promising; the nearest neighbor is <code>(6,5)</code> and we did visit that node in our descent. </p>
<p>But will it always work? See if you can think of a target <code>(X,Y)</code> coordinate whose nearest neighbor is <em>not</em> along the normal recursive descent.</p>
<details>
<summary><B>Think, then click!</B></summary>
<p><code>(5,4)</code> is one example of this; there are others. </p>
<p>Sadly, this means that we can't always get away with a single descent. Which, yes, means that even a balanced kd-tree has a worst-case search time that's worse than logarithmic in the number of nodes. In fact, the worst-case complexity is linear.</p>
<p>In the average case, it's still much better than a list, though.</p>
</details>
<br/>
<h4 id="fixing-the-problem"><a class="header" href="#fixing-the-problem">Fixing the problem</a></h4>
<p>So we can't always get away with a single descent. Surely we aren't doomed to always exploring the <em>entire</em> tree? Maybe we can still exploit the invariants in a useful way. To explore this idea, we'll draw those same 7 points on a 2-dimensional graph, and frame the same search for <code>(5,4)</code>: </p>
<p><img src="https://hackmd.io/_uploads/r1ArWQcQK.png" alt="" /></p>
<p>Here is where I notice that my drawing app has gridlines, but the exported images don't. Sigh. (TODO: fix for next semester.)</p>
<p>The purpose of the invariants is, like in a normal BST, splitting the search space between points &quot;bigger&quot; and &quot;smaller&quot; than the current point. We no longer have a single number line, but we <em>can</em> still split the space. The root note, <code>(6,5)</code> is a dimension <code>0</code> (X) node, so let's draw a line partitioning the space accordingly:</p>
<p><img src="https://hackmd.io/_uploads/rkDdf7q7Y.png" alt="" /></p>
<p>The invariants guarantee that any target node with an X coordinate smaller than 6 <em>must be located in the left subtree</em> of <code>(6,5)</code>. </p>
<p>Sure, but that's the same reasoning that got us into trouble in the first place. We know that the nearest neighbor might be, and indeed is, in the <em>right</em> subtree of <code>(6,5)</code>. </p>
<p>The trick is in the diagram. How far away from the goal <code>(5,4)</code> is the node we're currently visiting? <code>sqrt(2)</code>, assuming that we're using the usual Cartesian distance metric. So we know that any regions of the space further away from the goal than <code>sqrt(2)</code> aren't productive to visit. In fact, let's mentally draw a circle of radius <code>sqrt(2)</code> around the goal:</p>
<p><img src="https://hackmd.io/_uploads/BJbyE7cQt.png" alt="" /></p>
<p>At least, we'll pretend that's a circle. </p>
<p>As we follow the normal recursive descent, we'll draw 2 more dotted lines: one for <code>(0,5)</code> and another for <code>(4,1)</code>. But, sadly, our best estimate remains no closer than <code>sqrt(2)</code>. We'll pop back up from <code>(4,1)</code> to <code>(0,5)</code> and ask: <em>do we need to explore the right subtree?</em> </p>
<p>Put another way, is there potentially useful space (space inside the circle) on on the far side of the dotted line we drew for <code>(0,5)</code>?</p>
<p>By the way, you'll sometimes hear these dotted lines referred to as <em>cutting planes</em>. </p>
<p>Here's a possibly helpful picture:</p>
<p><img src="https://hackmd.io/_uploads/ByJSvmcXF.png" alt="" /></p>
<p>Yes! there's productive space on the far side, and so we do need to recur on the right subtree. In general, we can check for productive space by calculating:</p>
<p><span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.02778em;">GO</span><span class="mord mathnormal">A</span><span class="mord mathnormal">L</span><span class="mopen">[</span><span class="mord mathnormal">d</span><span class="mclose">]</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal" style="margin-right:0.07153em;">C</span><span class="mord mathnormal" style="margin-right:0.10903em;">U</span><span class="mord mathnormal" style="margin-right:0.00773em;">RR</span><span class="mopen">[</span><span class="mord mathnormal">d</span><span class="mclose">])</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">≤</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal">d</span><span class="mord mathnormal">i</span><span class="mord mathnormal">s</span><span class="mord mathnormal">t</span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.02778em;">GO</span><span class="mord mathnormal">A</span><span class="mord mathnormal">L</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord mathnormal" style="margin-right:0.13889em;">BEST</span><span class="mclose">)</span></span></span></span></p>
<p>where <code>GOAL</code> is the goal point, <code>CURR</code> is the current node (where we arere trying to decide whether or not to recur again), <code>BEST</code> is our best candidate so far, and <code>dist</code> is the distance formula of your choice.</p>
<h2 id="comparators-and-the-strategy-pattern"><a class="header" href="#comparators-and-the-strategy-pattern">Comparators and the Strategy Pattern</a></h2>
<p>Data structures like this rely heavily on <em>comparisons</em>, and there isn't one single comparison operation that works for every imaginable dataset. Another engineer who is using your data structure might want to provide their own, domain-appropriate comparisons. But if we code a particular comparison into the class, the engineer can't provide their own comparison metric.</p>
<div id="admonition-think-like-an-engineer-2" class="admonition admonish-tip">
<div class="admonition-title">
<p>Think Like an Engineer</p>
<p><a class="admonition-anchor-link" href="algorithms/algorithms.html#admonition-think-like-an-engineer-2"></a></p>
</div>
<div>
<p>This is an opportunity to exercise a little &quot;technical empathy&quot;. We want to allow the other engineer to use our data structure with their own, domain-specific, definitions. This might involve multiple concepts: comparison, distance, and so on. </p>
<p>But don't be an &quot;Architecture Astronaut&quot;! Don't over-engineer things.</p>
</div>
</div>
<h3 id="oo-and-fp-agree-on-the-interface"><a class="header" href="#oo-and-fp-agree-on-the-interface">OO and FP Agree on the Interface</a></h3>
<p>If this reminds you of the <em>dependency injection</em> idea from last week, good! Whether or not we ask the caller to provide the metric to the constructor or at the time we call another method, the idea is the same. Object-Oriented design calls this the <em>strategy pattern</em>; Functional Programming calls this a use of <em>first-class functions</em>---that is, functions or methods that are values in the language itself and thus can be passed as arguments.</p>
<p>You may have heard that in Java, &quot;everything is an object&quot;. This isn't strictly true (because primitives like <code>int</code> exist) but even if it were, like in (say) Scala, I see no reason why a function can't also be an object. After all, objects carry methods.</p>
<h3 id="comparators"><a class="header" href="#comparators">Comparators</a></h3>
<p>At the core of the strategy pattern is <em>humility</em>: we don't pretend to know every possible scenario that our caller might think of, so we give them a way to customize the larger functionality we provide.</p>
<p>Java provides another standard interface that's useful here: <code>Comparator</code>. But rather than being implemented by the class being compared, it's implemented by a standalone class whose implementation provides a new comparison method. E.g.:</p>
<pre><code class="language-java">class CartesianComparator implements Comparator&lt;Cartesian&gt; {

    @Override
    public int compare(Cartesian o1, Cartesian o2) {
        // e.g., an implementation of Euclidian distance
        //   (throw an error if #dimensions is different)
    }
}
</code></pre>
<p>Every instance of the CartesianComparator class contains a <em>strategy function</em> that a kd-tree can use for comparisons. 
A caller could create an object of this type, and pass it to the tree as needed. And they could write more of these: <code>WeightedCartesianComparator</code>, <code>ManhattanCartesianComparator</code>, and on and on, limited only by <em>their</em> needs and <em>your</em> interface. </p>
<p>(You'll provide them a suitable interface, won't you?)</p>
<p>Finally, remember you're free to ask something of <em>them</em>. For instance, if I write a comparator method that always returns <code>-1</code>, I'm setting myself up for frustration and debugging in the future <strong>through no fault of yours!</strong> Why isn't it your fault? Can it be there's some obligation I have, when I use <a href="https://docs.oracle.com/javase/8/docs/api/java/util/Comparator.html">the <code>Comparator</code> interface</a>?</p>
<h2 id="thinking-about-tradeoffs-bloom-filters"><a class="header" href="#thinking-about-tradeoffs-bloom-filters">Thinking About Tradeoffs: Bloom Filters</a></h2>
<p>In computer science, we're used to tradeoffs. Specifically, you've all learned about the classic <em>space-time tradeoff</em> that caching gives. You might implement this by memoization, or dynamic programming, or (if you're Google, Netflix, or some other popular website) a Content Delivery Network.</p>
<p>But what <em>else</em> might we compromise on? Here's a thought: can we ever compriomise on <em>correctness</em> in exchange for a time or space savings? Does that even make sense? Is it possible we've already done that somehow?</p>
<details>
<summary>Think, then click!</summary>
<p>The basic idea underlying hash tables is a compromise on correctness. They're just built to resolve that compromise internally. </p>
<p>Here's what I mean. If we assume that every record key hashes to a different table key, hash tables are a miracle (constant-time lookup). But this usually isn't true: collisions almost certainly happen. So the table has a (worst-case) linear-time backup plan built in to recover from that compromise.</p>
</details>
<br/>
<p>This idea of compromise on correctness is also valuable in algorithms. E.g., there exist fast algorithms for primality testing that just happen to be wrong sometimes.</p>
<p>Is that enough to build something useful out of? Would you maybe want more?</p>
<details>
<p>Yeah, you'd maybe like something along the lines of:</p>
<ul>
<li>only wrong in one direction; and </li>
<li>only wrong X% of the time. </li>
</ul>
<p><strong>Technical aside:</strong> I am oversimplifying the algorithm a bit, because there are a few other details. You might learn about these if you take a number theory class, or an algorithms class!</p>
</details>
<div id="admonition-think-like-an-engineer-3" class="admonition admonish-tip">
<div class="admonition-title">
<p>Think Like an Engineer</p>
<p><a class="admonition-anchor-link" href="algorithms/algorithms.html#admonition-think-like-an-engineer-3"></a></p>
</div>
<div>
<p>Note again that we're back to what <em>guarantees</em> a data structure or algorithm provides. When you're building or selecting a data structure or algorithm, consider the needs of your caller and/or end-user. In the case of these prime-testing algorithms, they can very quickly rule out many non-prime numbers, and do so fast enough that it's worth using them as a pre-test before applying a slow, but sound, algorithm.</p>
</div>
</div>
<h2 id="bloom-filters"><a class="header" href="#bloom-filters">Bloom Filters</a></h2>
<p>Bloom filters are a data structure for implementing set-membership queries. They work a lot like a hash table. Indeed, the basic structure they build on <strong>is</strong> a hash table. They just happen to not return booleans, or at least not in the same sense as (say) a <code>Set</code> in Java. Instead, a Bloom filter returns one of:</p>
<ul>
<li>the item is <em>possibly</em> in the set; or</li>
<li>the item is <em>definitely</em> not in the set.</li>
</ul>
<h3 id="a-common-use-case"><a class="header" href="#a-common-use-case">A Common Use Case</a></h3>
<p>They're frequently used as an efficient first-pass check to more expensive membership checks on very, very large datasets. (Think: &quot;No, I don't have that YouTube video stored in this server.&quot; or &quot;Yes, I might have that YouTube video---let's look for it.&quot;)</p>
<h3 id="building-the-idea"><a class="header" href="#building-the-idea">Building The Idea</a></h3>
<p>Like with kd-trees, Bloom filters build on a simpler idea; in this case, it's hash tables.</p>
<p>Start with an array of bits. We can use that to implement an approximate membership check: just hash the key you're looking for, and see if the bit in that cell of the array is <code>true</code>, rather than <code>false</code>.</p>
<p>Here's an example. Suppose we're in charge of Amazon's Prime TV service, and we want to very quickly tell whether a certain content-delivery network (CDN) node has a show that a local customer requests. We could add a bit array to every node, and when a new piece of media arrived (say, the first chunk of a new series), we'd hash the name of the media and set the corresponding bit to <code>1</code>. Like this:</p>
<p><img src="https://i.imgur.com/mfzLIUa.png" alt="" /></p>
<p>Note one crucial difference. Instead of saving a reference to the media in the table, we're just saving <em>one bit</em>. Very space efficient, especially if we've got a large array. </p>
<p>Now what happens if there's a collision? </p>
<details>
<summary>Think, then click!</summary>
<p>The key that the 2nd arrival hashes to is <em>already set to 1</em>. The array now can't tell the difference between these two media: if a customer requests the second arrival but the first arrival isn't there, the array will report a false positive.</p>
<p>But, either way, a lookup is very, very fast. We can always do a <em>real</em> search through the local media catalogue if the array says we <em>might</em> have what the customer wants. And if the array says it's not here, it definitely isn't.</p>
</details>
<p>In short: this data structure allows <em>false positives</em> but not false negatives. Even so, the false positives might make it seem useless, until you think of it as just one part of an overall solution. The table of bits is <em>fast</em>, likely much faster than a real, no-false-positives membership query. If we expect most query responses to be negative, why not try something like:</p>
<ul>
<li>When a query arrives, hash it and check the table of bits. 
<ul>
<li>If the answer is &quot;no&quot;, then we can return false right away.</li>
<li>If the answer is &quot;yes&quot;, then we perform the slower, real check and return its result.</li>
</ul>
</li>
</ul>
<h3 id="scaling-the-idea"><a class="header" href="#scaling-the-idea">Scaling The Idea</a></h3>
<p><em>Bloom Filters</em> are a generalization of this table-of-bits idea. Wwhy not have <em>several</em> hash functions, and use all the bits those hash functions produce for adding and looking up membership? That is, if we have 3 hash functions and they produce <code>{13, 2, 118}</code>, we'd set bits <code>13</code>, <code>2</code> and <code>118</code> to true on arrival, and check those same 3 bits on a membership check. </p>
<p>We still have the potential for false positives: two keys might hash to the same values across all hash functions, and even if they don't, multiple keys might have separately flipped all of those bits before our query. But, if we tune things right, it's a lot less likely than it was before. The trick is in picking the hash functions and deciding how big the table needs to be. Other operations, like deletion, also need care to implement properly. </p>
<h2 id="thinking-about-algorithms-a-search"><a class="header" href="#thinking-about-algorithms-a-search">Thinking about Algorithms: A* Search</a></h2>
<p>Let's talk about a problem that you might see in an AI class: helping a robot navigate around a grid-world. The robot wants to find the reward (hidden somewhere in the world) while spending a minimal number of resources in the process. The robot can move up, down, left, or right.</p>
<p>Here's an example: the little smiley face is the robot, and the dollar signs are the reward:</p>
<img src="https://i.imgur.com/kuUY9MJ.png" width="45%" alt="A 4-by-4 gridworld"/>
<p>The filled-in squares represent obstacles: walls, mountains, pits, etc. For now, let's say that every move costs <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6444em;"></span><span class="mord">1</span></span></span></span> unit of time, or fuel, or whatever measure we're using. </p>
<p>Assuming we know the contents of the gridworld above, how can we plan a path from the robot to the reward?</p>
<h3 id="breadth-first-search-and-dijkstras-algorithm"><a class="header" href="#breadth-first-search-and-dijkstras-algorithm">Breadth-First Search and Dijkstra's Algorithm</a></h3>
<p>One option is to use Dijkstra's algorithm. Actually, since we're saying that every move has cost <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6444em;"></span><span class="mord">1</span></span></span></span>, we're safe using a simpler variant: breadth-first search (BFS). BFS just builds a &quot;wavefront&quot; of exploration from the source until it finds the goal: distance-1 cells, then distance-2 cells, and so on. </p>
<p>Note that we're not talking about exploring with the robot in real time; we're executing the algorithm all at once, before the robot starts moving at all. So if I talk about &quot;backtracking&quot; I mean it in an algorithmic sense only. </p>
<p>Here's what BFS might look like on this grid world. We reach the goal after <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6444em;"></span><span class="mord">5</span></span></span></span> hops:</p>
<img src="https://i.imgur.com/M00wXPY.png" width="45%" alt="BFS on the above grid world"/>
<p>This looks great! It's a simple algorithm, it's pretty efficient, and everything's great. Right? </p>
<p>It turns out that I've drawn the picture in a way that hides something from you. More formally, the <em>abstraction choices</em> I made in drawing this picture <em>excluded</em> some important aspects of the problem. </p>
<p>Here's the picture, slightly changed...</p>
<img src="https://i.imgur.com/yMuEM4d.png" width="45%" alt="A bigger grid world"/>
<p>What's the problem? If the world is bigger, BFS will explore a lot of unproductive space before it finds the goal. (To see why, fill in the distance markings in the new cells I just added.)</p>
<p>Neither BFS nor Dijkstra's algorithm takes advantage of any /real distance information/: they just look at the edge weights. Not all graphs make such information available, and not every geometric setting makes &quot;distance&quot; defined in a useful way. But here, we should be able to take advantage of it.</p>
<h3 id="greedy-best-first-search"><a class="header" href="#greedy-best-first-search">Greedy Best-First Search</a></h3>
<p>Here's an alternative. Let's build a search process that is entirely guided by <em>distance</em>, not by edge weights.  Every cell (implicitly; we're not actually going to have to compute them all) has such a distance.  We have a few choices of what distance metric to use here, but let's just use ordinary Euclidian distance:</p>
<img src="https://i.imgur.com/LPhLAXO.png" width="45%" alt="Greedy Best-First Search on the same grid world"/>
<p>I haven't filled them all in, but the idea is to apply <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.24em;vertical-align:-0.305em;"></span><span class="mord sqrt"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.935em;"><span class="svg-align" style="top:-3.2em;"><span class="pstrut" style="height:3.2em;"></span><span class="mord" style="padding-left:1em;"><span class="mopen">(</span><span class="mord">Δ</span><span class="mord mathnormal">x</span><span class="mclose"><span class="mclose">)</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.7401em;"><span style="top:-2.989em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mopen">(</span><span class="mord">Δ</span><span class="mord mathnormal" style="margin-right:0.03588em;">y</span><span class="mclose"><span class="mclose">)</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.7401em;"><span style="top:-2.989em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span></span></span><span style="top:-2.895em;"><span class="pstrut" style="height:3.2em;"></span><span class="hide-tail" style="min-width:1.02em;height:1.28em;"><svg xmlns="http://www.w3.org/2000/svg" width='400em' height='1.28em' viewBox='0 0 400000 1296' preserveAspectRatio='xMinYMin slice'><path d='M263,681c0.7,0,18,39.7,52,119 c34,79.3,68.167,158.7,102.5,238c34.3,79.3,51.8,119.3,52.5,120 c340,-704.7,510.7,-1060.3,512,-1067 l0 -0 c4.7,-7.3,11,-11,19,-11 H40000v40H1012.3 s-271.3,567,-271.3,567c-38.7,80.7,-84,175,-136,283c-52,108,-89.167,185.3,-111.5,232 c-22.3,46.7,-33.8,70.3,-34.5,71c-4.7,4.7,-12.3,7,-23,7s-12,-1,-12,-1 s-109,-253,-109,-253c-72.7,-168,-109.3,-252,-110,-252c-10.7,8,-22,16.7,-34,26 c-22,17.3,-33.3,26,-34,26s-26,-26,-26,-26s76,-59,76,-59s76,-60,76,-60z M1001 80h400000v40h-400000z'/></svg></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.305em;"><span></span></span></span></span></span></span></span></span> as needed to every cell. By this metric, the robot starts out at a distance <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6444em;"></span><span class="mord">3</span></span></span></span> from the goal. Moving up would get the robot closer: to distance <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6444em;"></span><span class="mord">2</span></span></span></span>. Moving down would bring the robot further away: distance <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6444em;"></span><span class="mord">4</span></span></span></span>. So the search process will move up first. In fact, for this example it will only explore the cells I've labeled. There's one branch caused by the obstacle, but it's quickly bypassed to discover the goal.</p>
<h4 id="the-good"><a class="header" href="#the-good">The Good</a></h4>
<p>Greedy best-first search can be <em>much</em> more efficient than Dijkstra's algorithm when working with graphs that represent positions in space. </p>
<h4 id="the-bad"><a class="header" href="#the-bad">The Bad</a></h4>
<p>What happens when edge weights aren't all <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6444em;"></span><span class="mord">1</span></span></span></span>?</p>
<img src="https://i.imgur.com/XcEZyYT.png" width="45%" alt="Changing one edge weight"/>
<p>GBFS still finds a path, but it isn't the <em>cheapest</em> path. By changing an edge weight, we've made GBFS non-optimal. </p>
<h3 id="combining-these-ideas"><a class="header" href="#combining-these-ideas">Combining These Ideas</a></h3>
<p>We have just invented two different algorithms to solve the same problem. They have different advantages and disadvantages. Perhaps we can somehow <em>combine</em> them to suit our needs? To figure out how to do this, we need to prioritize the <em>properties</em> we want.</p>
<ul>
<li>We don't want any fake paths! Neither of the above algorithms produce invalid paths, so hopefully we can preserve this.</li>
<li>We want <em>cheapest</em> paths. GBFS doesn't guarantee this, but Dijkstra's does.</li>
<li>We want efficiency. GBFS is often more efficient. </li>
</ul>
<p>We can combine these two algorithmic ideas to produce another path-finding algorithm called A* (pronounced &quot;A Star&quot;). The core idea of A* is to begin with Dijkstra's algorithm, but include an <em>estimated actual distance</em> in the best-estimate calculations. Rather than looking at only the immediate neighborhood of the current node, A* recognizes that a candidate path must be extended by at least some minimal, &quot;direct&quot; distance in order to reach the goal. </p>
<p>In physical space, this distance metric might be something like the Euclidian distance between the two points. But there are also other distance metrics you might use.</p>
<p>Put another way, given two equal-length paths, the path ending closer to the goal should be considered first. The search can therefore be guided more intelligently. Dijkstra’s algorithm will often spend time exploring the “neighborhood” of the start node, but A* can be goal-directed. For example: between two candidate &quot;next&quot; edges with the same weight, if one would take you further from the goal, it is less likely to be the right edge to take.The beauty of the idea is that, to add in this awareness of overall distance, we just need to make two small change sto Dijkstra's algorithm.</p>
<p>In Dijkstra's algorithm, we set the cost <code>d[m]</code> of reaching (unexplored) node <code>m</code> via (explored) node <code>n</code> to <code>d[m] = d[n] + w(n,m)</code>, where <code>w</code> is the edge-weight function. </p>
<p>In A*, we need to include the heuristic. But we don't want to count it more than once, so we need two different notions of &quot;distance&quot;:
(1) the actual path-cost from the start to a given node <code>n</code> (similarly to Dijkstra's); and
(2) the <em>estimated</em> cost of reaching the goal via the cheapest path to that node. </p>
<p>The 2nd cost will be used as the priority-queue key, ensuring that the <em>most promising</em> nodes are processed first: <code>d[n] + w(n,m) + h(m,g)</code>, where <code>h</code> is the heuristic distance function. The 1st cost will be used to actually report the real cost of the route. In effect, Dijkstra's <code>h</code> function always returns <code>0</code>. </p>
<p>We'll cover this in more detail next time. </p>
<div id="admonition-not-all-heuristics-are-good" class="admonition admonish-warning">
<div class="admonition-title">
<p>Not all heuristics are good!</p>
<p><a class="admonition-anchor-link" href="algorithms/algorithms.html#admonition-not-all-heuristics-are-good"></a></p>
</div>
<div>
<p>A* won't report &quot;wrong&quot; paths. However, if <code>h</code> doesn't meet some criteria, it might report paths that are more expensive than they need to be. Put another way, a bad heuristic could cause A* to lose its guarantee of optimality. We rely implicitly on the <em>first</em> visit to the goal node corresponding to a cheapest path. But if <code>h</code> <em>over</em>-estimates the distance that will actually be taken, A* might explore a non-optimal path first—just like greedy best-first search did. </p>
<p>For more information about this, take an algorithms course.</p>
</div>
</div>
<div style="break-before: page; page-break-before: always;"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.min.css" integrity="sha384-AfEj0r4/OFrOo5t7NnNe46zW/tFgW6x/bCJG8FqQCEo3+Aro6EYUG4+cU+KJWu/X" crossorigin="anonymous">
<h1 id="algorithms-supplement"><a class="header" href="#algorithms-supplement">Algorithms Supplement</a></h1>
<p><a href="algorithms/./Oct21_AStar.pdf">Link from Tablet Whiteboard</a></p>
<div style="break-before: page; page-break-before: always;"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.min.css" integrity="sha384-AfEj0r4/OFrOo5t7NnNe46zW/tFgW6x/bCJG8FqQCEo3+Aro6EYUG4+cU+KJWu/X" crossorigin="anonymous">
<h1 id="security-and-threat-modeling-all-too-briefly"><a class="header" href="#security-and-threat-modeling-all-too-briefly">Security And Threat Modeling (All Too Briefly)</a></h1>
<p>Today's notes are more of an outline. They are accompanied by the <a href="https://docs.google.com/presentation/d/1g-iesYd5D0PhmjHw39zx6XqWXhDGNzMPd8w1RfG5Ado/edit?usp=sharing">slides</a>.</p>
<h3 id="example-1-the-parler-data-leak"><a class="header" href="#example-1-the-parler-data-leak">Example 1: The Parler Data Leak</a></h3>
<p>Some time ago, hackers were able to <a href="https://www.wired.com/story/parler-hack-data-public-posts-images-video/">obtain nearly all data from the Parler website</a>. It turns out that this was technically pretty easy to do, because of a variety of engineering decisions. These included:</p>
<ul>
<li>insecure direct object references: post IDs were consecutive, and so a <code>for</code> loop could reliably and efficiently extract <em>every</em> post on the site.</li>
<li>no rate limiting: the above-mentioned <code>for</code> loop could run quickly.</li>
<li>failure to scrub geo-location data from uploaded images: the physical location of users was compromised.</li>
</ul>
<p>Combining multiple security mistakes tends to add up to more than the sum of the individual impacts. </p>
<h3 id="example-2-phishing-email"><a class="header" href="#example-2-phishing-email">Example 2: Phishing Email</a></h3>
<p>Here's a screenshot of a real email someone received a couple of years ago.</p>
<p><img src="https://i.imgur.com/mxbNDq4.png" alt="" /></p>
<p>There was a lot more to follow, carefully crafted to trigger fear and loss aversion in the recipient. The sender claimed that they would toss the (salacious and embarrassing) information they had in exchange for a bit of money... in Bitcoin, of course.</p>
<p>This is an example of a <em>social engineering</em> attack: no technical aspect of a system is compromised, but still its human or institutional facets can be hacked. Social engineering is pretty broad, but other examples include a hacker calling Google to reset your password, or a trojan-horse USB drive being left in a bank parking lot.</p>
<h2 id="example-3-taxis"><a class="header" href="#example-3-taxis">Example 3: Taxis</a></h2>
<p>Today's discussion: <a href="https://medium.com/vijay-pandurangan/of-taxis-and-rainbows-f6bc289679a1">Of Taxis and Rainbows</a>. There's also a corresponding <a href="https://news.ycombinator.com/item?id=7926358">Hacker News thread</a>.</p>
<h3 id="lets-talk-about-the-core-anonymization-issue-that-the-article-reported-on"><a class="header" href="#lets-talk-about-the-core-anonymization-issue-that-the-article-reported-on">Let's talk about the core anonymization issue that the article reported on.</a></h3>
<ul>
<li>What's in the data, and what was anonymized?</li>
<li>What did they do to anonymize the data before release?</li>
<li>What went wrong? (how was the anonymization circumvented?)</li>
<li>Is this attack a generally useful technique? For what? 
<ul>
<li>See my <a href="security/./src/md5hash.ts">proof-of-concept code</a>.</li>
</ul>
</li>
</ul>
<h3 id="takeaways"><a class="header" href="#takeaways">Takeaways:</a></h3>
<ul>
<li>True anonymization is hard, and it's difficult if not impossible to undo mistakes. </li>
<li>Often the <strong>legitimate</strong> interests of historians, social scientists, journalists and others may be competing with privacy interests. There is not always a single right answer, and there certainly isn't an absolute answer that is right for all such cases.</li>
<li>When presented with such a situation in tech, think carefully. Seek advice if it's available on both the technical and non-technical angles. Here, the FOIA request was answered in <em>2 days</em>. </li>
</ul>
<h3 id="leaving-the-anonymization-problems-aside-what-else-could-an-adversary-do-with-this-data"><a class="header" href="#leaving-the-anonymization-problems-aside-what-else-could-an-adversary-do-with-this-data">Leaving the anonymization problems aside, what else could an adversary do with this data?</a></h3>
<ul>
<li>What about the <em>passengers</em>? There's no identifying information, right?</li>
<li>Is there any risk of correlation with other data?</li>
</ul>
<h3 id="lets-analyze-this-hacker-news-exchange"><a class="header" href="#lets-analyze-this-hacker-news-exchange">Let's analyze this Hacker News exchange.</a></h3>
<p>There were 2 arguments I thought were interesting near the top:</p>
<ul>
<li>&quot;NYC is too dense for reasonable correlation&quot;</li>
<li>&quot;nobody who lives in a non-dense part of NYC can afford to take a taxi anyway&quot;</li>
</ul>
<p>New York City is a lot more than skyscrapers. It includes, say, Staten Island:</p>
<p><img src="https://i.imgur.com/TYsQNas.png" alt="" /></p>
<p>Here's a random Google street view:</p>
<p><img src="https://i.imgur.com/bDID3iU.jpg" alt="" /></p>
<p>Take Malte's 2390, Julia's 1952B, and other such courses if you think this sort of thing is interesting. Most importantly, if you think of &quot;social implications&quot; as a separate thing from engineering, stop. It's not always inseparable, but it frequently is. As with much else, there's nuance.</p>
<h3 id="are-there-possible-defenses-against-this"><a class="header" href="#are-there-possible-defenses-against-this">Are there possible defenses against this?</a></h3>
<p>Assume that you want to give weight to the historian's goals—you can't just say &quot;no&quot;. We'll also ignore the specific obligations of the Freedom of Information Act to explore the design space.</p>
<details>
<summary>Think, then click.</summary>
<p>The historian needs data at the granularity of individual trips. </p>
<p>Here are some potential mitigations. Of course, if you find yourself in this situation for real, consult with experts rather than these notes. Crucially, <strong>none of these ideas is &quot;perfect&quot;</strong>. Different situations warrant different approaches.</p>
<ul>
<li>Reduce the spatial detail: snap locations to a grid or add random noise. This might affect the ability to tell (e.g.) which corners people tend to pick up taxis, however. Perhaps we could adjust the level of noise by the density of the area.</li>
<li>Reduce the temporal detail: report rides only at (e.g.) the per-hour granularity. This causes other problems for the historian, but also helps to preserve privacy. </li>
<li>Provide opt-out options and provide both individual trips (for those who don't opt-out) and aggregate data (for those who do). This is admittedly difficult to implement for this specific case.</li>
<li>Don't provide fields where certain very rare values (vs. the overall corpus) could aid deanonymization. Classic examples often involve self-reported ethnicity, gender identity, etc. Suppose I asked in an anonymous feedback form for your <em>country of origin</em> along with the usual survey. Then unless country-of-origin is pretty uniform, I might be able to deanonymize the data. </li>
</ul>
</details>
<h2 id="dont-forget-the-people-involved"><a class="header" href="#dont-forget-the-people-involved">Don't Forget the People Involved</a></h2>
<p>Here's a classical experiment in psychology.</p>
<h3 id="variation-1"><a class="header" href="#variation-1">Variation 1</a></h3>
<p>Suppose you're shown four cards. The deck these cards have been taken from have colors on one side (either yellow or red), and numbers (between 1 and 100) on the other. At first, you only see one side of each. Perhaps you see:</p>
<pre><code>1
2
yellow
red
</code></pre>
<p>You're asked to determine if these four cards obey a simple rule: <em>if the card's number is even, then the card's color is red</em>. The question is, <em>which cards do you need to turn over to check the rule</em>?</p>
<h3 id="variation-2"><a class="header" href="#variation-2">Variation 2</a></h3>
<p>Suppose you're shown four cards. The deck these cards have been taken from have drink orders on one side (either juice or beer), and ages (between 1 and 100) on the other. At first, you only see one side of each. Perhaps you see:</p>
<pre><code>beer
water
17
23
</code></pre>
<p>You're asked to determine if these four cards obey a simple rule: <em>if the drink order is alcoholic, then the age is no less than 21</em>. The question is, <em>which cards do you need to turn over to check the rule</em>?</p>
<h3 id="psychological-context"><a class="header" href="#psychological-context">Psychological Context</a></h3>
<p>These are called [Wason Selection Task]s(https://en.wikipedia.org/wiki/Wason_selection_task) and have been studied extensively in psychology. </p>
<p>Surprisingly, humans tend to do poorly on the first task, but far better on the second. Why? Because context matters. If you can <strong>catch someone outside of their security mindset</strong> with an apparently rote task, you have a higher chance of exploiting them.</p>
<p>Good security involves far more than just the software. But whether or not we're talking about software or the human brain, bias can be attacked, and the attacker can abuse leaky abstractions.</p>
<!-- ## Aside: The GDPR

You may have heard of the [GDPR](https://gdpr.eu). On your term projects, it's a good idea to consider how you would comply with the law; we may ask (e.g.) how you would support deletion of a user's data (although we don't expect you to necessarily have time to _implement_ all your ideas, you need to be able to speak intelligently about the challenges).

Why should you care about laws like the GDPR? Setting aside ethical and empathetic concerns, if you ever intend to build software that's used in Europe, you ought to be aware of compliance requirements. -->
<h2 id="a-cognitive-tool-threat-modeling"><a class="header" href="#a-cognitive-tool-threat-modeling">A Cognitive Tool: Threat Modeling</a></h2>
<p>We tend to think of security as being about confidentiality. But that's too limiting. Are there <em>other</em> kinds of security goals you might want?</p>
<p>Here are 6 very broad classes of goal, which together comprise the S.T.R.I.D.E. framework. More on these soon.</p>
<h3 id="authentication-vs-spoofing"><a class="header" href="#authentication-vs-spoofing">Authentication (vs. Spoofing)</a></h3>
<h3 id="integrity-vs-tampering"><a class="header" href="#integrity-vs-tampering">Integrity (vs. Tampering)</a></h3>
<h3 id="non-repuditation-vs-repudiation"><a class="header" href="#non-repuditation-vs-repudiation">Non-repuditation (vs. Repudiation)</a></h3>
<h3 id="confidentiality-vs-information-disclosure"><a class="header" href="#confidentiality-vs-information-disclosure">Confidentiality (vs. Information Disclosure)</a></h3>
<h3 id="availability-vs-denial-of-service"><a class="header" href="#availability-vs-denial-of-service">Availability (vs. Denial of Service)</a></h3>
<h3 id="authorization-vs-elevation-of-privilege"><a class="header" href="#authorization-vs-elevation-of-privilege">Authorization (vs. Elevation of Privilege)</a></h3>
<h2 id="elevation-of-privilege"><a class="header" href="#elevation-of-privilege">Elevation of Privilege</a></h2>
<!-- We're going to get practice with STRIDE using the cards by [Adam Shostack](https://adam.shostack.org) (a noted security expert) for a game called [Elevation of Privilege](https://github.com/adamshostack/eop). Adam is the author of my favorite book on threat modeling, which is [available in the Brown library](https://bruknow.library.brown.edu/permalink/01BU_INST/9mvq88/alma991043215908506966). I strongly recommend using this book as a guide to _mitigating_ the kinds of threats we'll identify today. 

Happily, this semester I have actual hard-copies of this game to use in class today. We won't have time to play the game, but I want to use them as props to think about potential threats your term projects will face. **Everyone should leave with at least one threat in mind.**  -->
<!-- ### Step 1: Diagramming

What would a diagram of the Sprint 3--4 application look like? Here's a general process to follow:
* Draw some vertexes that correspond to entitites where data is produced, consumed, held, processed, etc. The detail can be either coarse or fine, depending on our needs and our knowledge of the system. You might have vertexes for:
    * the database itself;
    * the database proxy;
    * the API handler; and
    * different aspects of the front-end app (e.g., the screenreader vs. the table view). 
* Draw edges between these vertexes that show how data flows, and label them with a short description of the data. For example:
    * table names flow from the front-end to the API handler.
    
Now, what kinds of _trust_ does each component need to perform its function? Does the database proxy trust the API handler implicitly? Then draw a circle around them, linking them into the same "zone of trust". (The trust doesn't have to absolute! The point is to identify lack of boundaries that an attacker could exploit.)

The slides contain 2 examples of this from Shostack's book. 

#### Important Aside

The goal of this lecture isn't to "teach you to do proper threat modeling". That would take more than the half-hour or so we have for this section. Rather, I want to give you a taste of the discipline in the hope it's useful on your term projects. 

If you're planning on specializing (or even sometimes engaging with) security concerns, you'd do well to explore the threat-modeling book and take other security-focused classes. 

**Which category does threat-modeling fall into?** Design is most likely. Depending on what you do with it, you might also be able to make an argument for testing or professionalism.

### Step 2: Looking For Threats

If we were building the system, would we have any spoofing concerns? What about availability? Etc. Remember, you're not looking for _bugs_; you're looking for _potential threats_. Some are easy to avoid or mitigate, others are challenging, and still others may be impossible (or at least prohibitively expensive to avoid). Also, remember that the attacker may be after something other than _your_ data: are there things about your system that might make it useful as a vector of attack?

To avoid issues caused by diagramming differences, and keep things simple, we'll use the company dataflow diagram from Shostack (slide 9). Where detail is missing, allow yourself to think in hypotheticals. E.g., what _if_ the attacker could get a directory listing, and learn about filenames on the human-resources server?

Now we get to play the game! Form groups, and play. The classroom isn't well-suited to this, but let's make it work---focus on thinking through different kinds of threats.

**While the game is going on, and until the end of "class", Tim is available in the front of class to answer questions you have about Sprint 4 or the term project.**


### Some Possible Threats:

Here are some examples (not at all exhaustive), mostly taken from the book:

<details>
<summary>Think, then click!</summary>
* The web client could connect to a spoofed front-end.
* Someone could tamper with a request en route to the DB server.
* Someone might send many consecutive expensive SQL requests.
* The logs could fill up.
* If the database can run arbitrary commands, then the client gains access to them as well.
</details> -->
                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->


                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">

            </nav>

        </div>




        <script>
            window.playground_copyable = true;
        </script>


        <script src="elasticlunr.min.js"></script>
        <script src="mark.min.js"></script>
        <script src="searcher.js"></script>

        <script src="clipboard.min.js"></script>
        <script src="highlight.js"></script>
        <script src="book.js"></script>

        <!-- Custom JS scripts -->

        <script>
        window.addEventListener('load', function() {
            window.setTimeout(window.print, 100);
        });
        </script>

    </div>
    </body>
</html>
